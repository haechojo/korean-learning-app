<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>韩语学习助手 (AI高级定制版)</title>
    <style>
        :root {
            --wechat-bg-gray: #f0f2f5;
            --wechat-header-bg: #f7f7f7;
            --wechat-header-text: #1f1f1f;
            --wechat-tabbar-bg: #fdfdfd;
            --wechat-tab-text: #7a7a7a;
            --wechat-tab-text-active: #07c160;
            --wechat-border-color: #e1e1e1;
            --wechat-list-item-bg: #ffffff;
            --wechat-button-primary: #07c160;
            --wechat-text-primary: #333333;
            --wechat-text-secondary: #666666;
            --wechat-input-bg: #ffffff;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --ai-accent-color: #1677ff;
            --card-background: #ffffff;
            --primary-color: #07c160;
            --text-color: #2c3e50;
            --shadow-color: rgba(0, 0, 0, 0.06);
            --font-system: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", sans-serif;
        }

        body[data-theme="dark"] {
            --wechat-bg-gray: #1a1a1a;
            --wechat-header-bg: #2a2a2a;
            --wechat-header-text: #e0e0e0;
            --wechat-tabbar-bg: #2a2a2a;
            --wechat-tab-text: #b0b0b0;
            --wechat-border-color: #444444;
            --wechat-list-item-bg: #333333;
            --wechat-button-primary: var(--primary-color);
            --wechat-text-primary: #e0e0e0;
            --wechat-text-secondary: #aaaaaa;
            --wechat-input-bg: #444444;
            --card-background: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body[data-color-theme="red"] {
            --primary-color: #FF4136;
            --wechat-tab-text-active: #FF4136;
            --ai-accent-color: #FF4136;
        }
        body[data-color-theme="orange"] {
            --primary-color: #FF851B;
            --wechat-tab-text-active: #FF851B;
            --ai-accent-color: #FF851B;
        }
        body[data-color-theme="yellow"] {
            --primary-color: #FFDC00;
            --wechat-tab-text-active: #FFDC00;
            --ai-accent-color: #FFDC00;
        }
        body[data-color-theme="green"] {
            --primary-color: #07c160;
            --wechat-tab-text-active: #07c160;
            --ai-accent-color: #07c160;
        }
        body[data-color-theme="cyan"] {
            --primary-color: #00B8D4;
            --wechat-tab-text-active: #00B8D4;
            --ai-accent-color: #00B8D4;
        }
        body[data-color-theme="blue"] {
            --primary-color: #0074D9;
            --wechat-tab-text-active: #0074D9;
            --ai-accent-color: #0074D9;
        }
        body[data-color-theme="purple"] {
            --primary-color: #B10DC9;
            --wechat-tab-text-active: #B10DC9;
            --ai-accent-color: #B10DC9;
        }


        body {
            font-family: var(--font-system); margin: 0; padding: 0; background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary); display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; position: relative; font-size: 14px;
        }

        .app-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .wechat-header { background-color: var(--wechat-header-bg); border-bottom: 1px solid var(--wechat-border-color); padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-sizing: border-box; }
        .wechat-header-title { font-size: 17px; font-weight: 600; color: var(--wechat-header-text); }
        .wechat-content { flex-grow: 1; overflow-y: auto; padding: 15px; padding-top: 65px; padding-bottom: 70px; background-color: var(--wechat-bg-gray); }
        .content-page { display: none; animation: fadeInPage 0.3s ease-in-out; }
        .content-page.active { display: block; }
        @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        .wechat-tabbar { background-color: var(--wechat-tabbar-bg); border-top: 1px solid var(--wechat-border-color); height: 55px; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--wechat-tab-text); font-size: 10px; cursor: pointer; flex-grow: 1; text-align: center; padding: 5px 0; }
        .tab-item-icon { font-size: 22px; margin-bottom: 3px; }
        .tab-item.active .tab-item-icon, .tab-item.active .tab-item-label { color: var(--wechat-tab-text-active); }

        button.ai-action-btn, .generic-button { background-color: var(--ai-accent-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 5px; margin-right: 5px; transition: background-color 0.2s; }
        button.ai-action-btn:hover, .generic-button:hover { background-color: var(--primary-color); }
        button.ai-action-btn:disabled, .generic-button:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7;}
        input[type="text"], textarea, select {
            width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color);
            border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: var(--font-system);
            box-sizing: border-box; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="radio"], input[type="checkbox"] {
            accent-color: var(--primary-color);
        }
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #5a6268;
        }


        #page-memorize .status {font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px; text-align: center;}
        #page-memorize .progress-bar-container {width: 100%; background-color: #e0e0e0; border-radius: 25px; margin-bottom: 20px; height: 8px; overflow: hidden;}
        body[data-theme="dark"] #page-memorize .progress-bar-container { background-color: #555;}
        #page-memorize .progress-bar {width: 0%; height: 100%; background: var(--primary-color); border-radius: 25px; transition: width 0.4s ease-in-out;}
        #page-memorize .word-card-container {width: 100%; perspective: 1000px; margin-bottom: 20px;}
        #page-memorize .word-card {min-height: 250px; width: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); background-color: var(--card-background); border-radius: 12px; box-shadow: 0 3px 10px var(--shadow-color);}
        #page-memorize .word-card.is-flipped {transform: rotateY(180deg);}
        #page-memorize .card-face {position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; border-radius: 12px;}
        #page-memorize .card-face-back {transform: rotateY(180deg); justify-content: flex-start; padding-top: 15px; overflow-y: auto;}
        #page-memorize .korean-word-container {display: flex; align-items: center; margin-bottom: 8px;}
        #page-memorize .korean-word {font-family: 'Noto Sans KR', var(--font-system); font-size: 2.2em; font-weight: 500; color: var(--text-color); margin-right: 8px; line-height: 1.3;}
        #page-memorize .pronounce-btn {background: none; border: none; font-size: 1.6em; cursor: pointer; color: var(--primary-color); padding: 0 5px;}
        #page-memorize .pronunciation {font-size: 1em; color: var(--wechat-text-secondary); margin-bottom: 15px; font-style: italic;}
        #page-memorize .hint-to-flip {font-size: 0.8em; color: var(--wechat-text-secondary); position: absolute; bottom: 10px;}
        #page-memorize .translation {font-size: 1.4em; font-weight: 500; margin-bottom: 10px;}
        #page-memorize .chinese-translation {color: var(--primary-color);}
        #page-memorize .example-sentence {font-size: 0.95em; text-align: left; width: 100%; margin-top: 5px;}
        #page-memorize .korean-example, #page-memorize .chinese-example {font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 4px; line-height: 1.5;}
        #page-memorize .korean-example {font-family: 'Noto Sans KR', var(--font-system); color: #555;}
        body[data-theme="dark"] #page-memorize .korean-example { color: #ccc;}
        #page-memorize .ai-word-expansion-area {width: 100%; margin-top: 10px;}
        #page-memorize .ai-helper-container, #page-memorize .ai-sentence-generator-container, #page-memorize .ai-usage-notes-container {margin-top: 8px; padding: 8px; background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; font-size: 0.85em; display: none;}
        body[data-theme="dark"] #page-memorize .ai-helper-container, body[data-theme="dark"] #page-memorize .ai-sentence-generator-container, body[data-theme="dark"] #page-memorize .ai-usage-notes-container { background-color: #213d54; border-color: #3b6d91;}
        #page-memorize .ai-helper-title, #page-memorize .ai-sentence-generator-title, #page-memorize .ai-usage-notes-title {font-weight: 500; color: var(--ai-accent-color); margin-bottom: 5px;}
        #page-memorize .ai-helper-content, #page-memorize .ai-generated-sentences, #page-memorize .ai-usage-notes-content {white-space: pre-wrap; color: var(--wechat-text-primary); line-height: 1.4;}
        #page-memorize .ai-generated-sentences ul {padding-left: 15px; margin: 5px 0;}
        #page-memorize .ai-generated-sentences li {margin-bottom: 5px;}
        #page-memorize .controls {display: grid; grid-template-columns: 1fr 1.6fr 1fr; gap: 8px; width: 100%; margin-bottom: 8px;}
        #page-memorize .controls.secondary-controls {grid-template-columns: 1fr 1fr;}
        #page-memorize .controls.tertiary-controls { grid-template-columns: 1fr 1fr; margin-top: 5px; }
        #page-memorize .controls button {background-color: var(--card-background); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 8px; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease;}
        body[data-theme="dark"] #page-memorize .controls button { background-color: #2b2b2b;}
        #page-memorize .controls button:hover {background-color: #f0f0f0; transform: translateY(-1px);}
        body[data-theme="dark"] #page-memorize .controls button:hover {background-color: #444;}
        #page-memorize .controls button:active {transform: translateY(0px);}
        #page-memorize .controls button#show-translation-btn {background-color: var(--primary-color); color: white;}
        #page-memorize .controls button.ai-btn {background-color: var(--ai-accent-color); color: white; border-color: var(--ai-accent-color); font-size: 0.9em; padding: 10px 5px;}


        #page-review-plan .review-summary {background-color: var(--wechat-list-item-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px var(--shadow-color); text-align: center;}
        #page-review-plan .review-summary p {margin: 5px 0; font-size: 0.95em;}
        #page-review-plan .review-summary .count {font-weight: bold; color: var(--primary-color);}
        #page-review-plan .review-list-item {background-color: var(--wechat-list-item-bg); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px var(--shadow-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s;}
        #page-review-plan .review-list-item:hover {background-color: #f9f9f9;}
        body[data-theme="dark"] #page-review-plan .review-list-item:hover {background-color: #444;}
        #page-review-plan .review-word-info .word {font-size: 1.1em; font-weight: 500; color: var(--text-color);}
        #page-review-plan .review-word-info .meaning {font-size: 0.9em; color: var(--wechat-text-secondary);}
        #page-review-plan .review-status .next-review {font-size: 0.8em; text-align: right;}
        #page-review-plan .review-status .next-review .date {font-weight: bold;}
        #page-review-plan .review-status .next-review .overdue {color: var(--danger-color);}
        #page-review-plan .review-status .next-review .due-soon {color: var(--warning-color);}
        #page-review-plan .no-reviews {text-align: center; color: var(--wechat-text-secondary); margin-top: 30px;}
        #page-review-plan .filter-buttons {margin-bottom: 15px; text-align: center;}
        #page-review-plan .filter-buttons button {padding: 6px 12px; margin: 0 5px; border-radius: 15px; border: 1px solid var(--wechat-border-color); background-color: var(--wechat-list-item-bg); color: var(--wechat-text-secondary); cursor: pointer; font-size:0.85em;}
        body[data-theme="dark"] #page-review-plan .filter-buttons button { background-color: #2b2b2b; }
        #page-review-plan .filter-buttons button.active {background-color: var(--primary-color); color: white; border-color: var(--primary-color);}


        #page-ai-functions .ai-function-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #page-ai-functions.menu-active .ai-function-menu { display: flex; }
        #page-ai-functions.sub-feature-active .ai-function-menu { display: none; }

        #page-ai-functions .ai-function-menu-item {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.1em;
            color: var(--wechat-text-primary);
        }
        #page-ai-functions .ai-function-menu-item:hover {
            background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-ai-functions .ai-function-menu-item:hover {
            background-color: #444;
        }
        #page-ai-functions .ai-sub-feature-section {
            display: none;
        }
        #page-ai-functions.sub-feature-active .ai-sub-feature-section.active {
            display: block;
            background-color: var(--wechat-bg-gray);
            padding: 0;
            box-shadow: none;
        }
        .ai-sub-feature-section .section-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
         .ai-sub-feature-section .section-container:last-child {
            margin-bottom: 0;
        }


        #page-image-recognition #image-preview-container-rec { margin-bottom: 10px; text-align: center; }
        #page-image-recognition #image-preview-rec { max-width: 100%; max-height: 180px; border: 1px solid var(--wechat-border-color); border-radius: 6px; display: none; margin: 0 auto; }
        #page-image-recognition #image-upload-label-rec { display: inline-block; padding: 8px 12px; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-size: 0.9em; }
        #page-image-recognition #image-upload-rec { display: none; }
        #page-image-recognition .recognition-output-section { margin-top: 10px; }
        #page-image-recognition .recognition-output-section h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-cloze .cloze-question { margin-bottom: 10px; font-size: 1.1em; }
        #feature-cloze .cloze-hint { font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px;}
        #feature-cloze #cloze-answer-input { width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }
        #feature-cloze #cloze-feedback { font-weight: bold; min-height: 20px; margin-top: 5px; }
        #feature-cloze #cloze-correct-sentence { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px; }

        #feature-story .story-weaver-controls { margin-bottom: 10px; }
        #feature-story .story-weaver-controls label { font-size: 0.9em; margin-right: 5px;}
        #feature-story #story-word-select { width: 100%; min-height: 60px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 0.9em; margin-bottom: 10px; }
        #feature-story #story-word-select option { padding: 3px; }
        #feature-story #ai-generated-story-ko, #feature-story #ai-generated-story-zh { margin-top: 5px; }
        #feature-story #ai-generated-story-ko h5, #feature-story #ai-generated-story-zh h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-scenario .scenario-difficulty-selector {
            margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;
        }
        body[data-theme="dark"] #feature-scenario .scenario-difficulty-selector { background-color: #2b2b2b;}
        #feature-scenario .scenario-difficulty-selector label { font-size: 0.9em; margin-right: 5px; }
        #feature-scenario .scenario-difficulty-selector input[type="radio"] { margin-right: 2px; vertical-align: middle; }
        #feature-scenario .scenario-difficulty-selector label[for^="diff-"] { margin-right: 10px; }
        #feature-scenario #ai-scenario-description { font-style: italic; margin-bottom: 10px; }
        #feature-scenario #ai-scenario-dialogue-history { background-color: #f8f8f8; border: 1px solid #eee; border-radius: 4px; padding: 10px; min-height: 80px; margin-bottom:10px; display:none; max-height: 200px; overflow-y: auto;}
        body[data-theme="dark"] #feature-scenario #ai-scenario-dialogue-history { background-color: #222; border-color: #444;}
        #feature-scenario #ai-scenario-dialogue-history p { margin: 3px 0; padding: 4px; border-radius: 3px;}
        #feature-scenario #ai-scenario-dialogue-history .user-utterance { text-align: right; }
        #feature-scenario #ai-scenario-dialogue-history .user-utterance strong { color: var(--primary-color); }
        #feature-scenario #ai-scenario-dialogue-history .ai-utterance strong { color: var(--ai-accent-color); }
        #feature-scenario #user-scenario-response { width: calc(100% - 22px); min-height: 50px; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }

        #feature-essay-correction #essay-input { min-height: 150px; }
        #feature-essay-correction #essay-feedback-area { margin-top: 15px; padding: 12px; background-color: #f9f9f9; border: 1px solid var(--wechat-border-color); border-radius: 6px; min-height: 80px; color: var(--wechat-text-primary); white-space: pre-wrap; font-size: 15px; line-height: 1.6; }
        body[data-theme="dark"] #feature-essay-correction #essay-feedback-area { background-color: #2b2b2b; border-color: #555;}
        #feature-essay-correction #essay-feedback-area.loading::before { content: "AI 批改中..."; color: var(--ai-accent-color); }
        #feature-essay-correction #essay-feedback-area.error { color: var(--danger-color); }

        #feature-mc-questions .mc-category-select {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        body[data-theme="dark"] #feature-mc-questions .mc-category-select { background-color: #2b2b2b;}
        #feature-mc-questions .mc-category-select label {
            font-size: 0.9em;
            margin-right: 5px;
        }
        #feature-mc-questions .mc-category-select input[type="radio"] {
            margin-right: 2px;
            vertical-align: middle;
        }


        #feature-mc-questions .mc-question-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        #feature-mc-questions .mc-question-controls input[type="text"] { flex-grow: 1; margin-bottom: 0;}
        #feature-mc-questions .mc-question-controls input[type="number"] { width: 60px; margin-bottom: 0; text-align: center;}
        #feature-mc-questions .mc-question { margin-bottom: 15px; }
        #feature-mc-questions .mc-question p { font-size: 1.1em; font-weight: 500; margin-bottom: 10px; }
        #feature-mc-questions .mc-options label { display: block; margin-bottom: 8px; cursor: pointer; padding: 8px 10px; border: 1px solid var(--wechat-border-color); border-radius: 5px; transition: background-color 0.2s;}
        body[data-theme="dark"] #feature-mc-questions .mc-options label { border-color: #555;}
        #feature-mc-questions .mc-options label:hover { background-color: #f0f0f0; }
        body[data-theme="dark"] #feature-mc-questions .mc-options label:hover { background-color: #444;}
        #feature-mc-questions .mc-options input[type="radio"] { margin-right: 8px; }
        #feature-mc-questions .mc-feedback { margin-top: 10px; font-weight: bold; min-height: 20px; }
        #feature-mc-questions .mc-feedback.correct { color: var(--primary-color); }
        #feature-mc-questions .mc-feedback.incorrect { color: var(--danger-color); }
        #feature-mc-questions .mc-explanation { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px;}

        #page-local-video #video-player-container {
            text-align: center;
            margin-top: 15px;
        }
        #page-local-video #video-player {
            width: 100%;
            max-width: 600px;
            max-height: 300px;
            background-color: black;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }
        #page-local-video #video-upload-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 1em;
        }
        #page-local-video #video-upload-input {
            display: none;
        }
        #page-local-video .file-name-display {
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
            margin-top: 5px;
            word-break: break-all;
        }


        #page-settings {
            padding: 0;
        }
        #page-settings .profile-section {
            background-color: var(--wechat-list-item-bg);
            padding: 20px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        #page-settings .profile-icon {
            font-size: 48px;
            margin-right: 15px;
            color: var(--wechat-text-secondary);
        }
        #page-settings .profile-info h3 {
            margin: 0;
            font-size: 1.3em;
            color: var(--text-color);
        }
        #page-settings .profile-info p {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
        }

        #page-settings .settings-list {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .settings-list .setting-item {
            padding: 15px;
            border-bottom: 1px solid var(--wechat-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        #page-settings .settings-list .setting-item:last-child {
            border-bottom: none;
        }
        #page-settings .settings-list .setting-item label {
            font-size: 1em;
            color: var(--wechat-text-primary);
            cursor: pointer;
            flex-grow: 1;
        }
        #page-settings .settings-list .setting-item .arrow {
            font-size: 1.2em;
            color: var(--wechat-text-secondary);
            margin-left: 10px;
        }


        #page-settings .about-section {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .about-section .about-button {
            width: 100%;
            background-color: var(--wechat-list-item-bg);
            color: var(--wechat-text-primary);
            border: none;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        #page-settings .about-section .about-button:hover {
             background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-settings .about-section .about-button:hover {
            background-color: #444;
        }
        #page-settings .about-section .about-button .icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: var(--ai-accent-color);
        }

        #page-about {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-about .about-content-area {
            background-color: var(--wechat-list-item-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: center;
            margin-top: 15px;
        }
        #page-about h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #page-about p {
            margin: 8px 0;
            line-height: 1.6;
            font-size: 0.95em;
        }
        #page-about p strong {
            color: var(--text-color);
        }

        #page-study-goals {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-study-goals .goals-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
        #page-study-goals .goals-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--wechat-border-color);
            padding-bottom: 5px;
        }
        #page-study-goals .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1em;
        }
        #page-study-goals .goal-item input {
            width: 60px;
            text-align: center;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .streak-calendar {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-top: 15px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-header {
            font-weight: bold;
            color: var(--wechat-text-secondary);
            font-size: 0.85em;
        }
        .calendar-day {
            padding: 8px 5px;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: var(--wechat-text-primary);
            font-size: 0.9em;
            position: relative;
        }
        body[data-theme="dark"] .calendar-day { background-color: #444; }
        .calendar-day.empty {
            background-color: transparent;
            box-shadow: none;
        }
        .calendar-day.today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }
        .calendar-day.checked::after {
            content: '✔';
            color: white;
            background-color: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8em;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }


        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s, border-color 0.2s;
            box-sizing: border-box;
        }
        .color-option.selected {
            border-color: var(--primary-color);
            border-width: 3px;
            transform: scale(1.1);
        }
        .color-red { background-color: #FF4136; }
        .color-orange { background-color: #FF851B; }
        .color-yellow { background-color: #FFDC00; }
        .color-green { background-color: #07c160; }
        .color-cyan { background-color: #00B8D4; }
        .color-blue { background-color: #0074D9; }
        .color-purple { background-color: #B10DC9; }

        /* 開屏動畫樣式 */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f8f9fa; /* 淺灰色背景 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* 確保在最上層 */
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }

        .splash-content {
            text-align: center;
        }

        .splash-title-zh {
            font-size: 2.5em; /* 增大字體 */
            font-weight: bold;
            color: var(--primary-color); /* 使用主題綠色 */
            margin-bottom: 0.4em;
        }

        .splash-title-ko {
            font-size: 1.8em; /* 增大字體 */
            color: var(--ai-accent-color); /* 使用 AI 主題藍色 */
            margin-bottom: 0.8em;
            font-family: 'Noto Sans KR', sans-serif; /* 確保韓文字體美觀 */
        }

        .splash-design-by {
            font-size: 1.1em; /* 增大字體 */
            color: var(--wechat-text-secondary); /* 灰色文字 */
            margin-top: 1.5em; /* 增加間距 */
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* 煙花動畫樣式 */
        #fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 允許點擊穿透 */
            z-index: 999;
            overflow: hidden; /* 防止煙花溢出 */
        }

        .firework {
            position: absolute;
            width: 8px; /* 煙花粒子大小 */
            height: 8px;
            border-radius: 50%;
            opacity: 0; /* 初始透明 */
            animation: shootAndExplode 1.5s ease-out forwards; /* 組合動畫 */
        }

        @keyframes shootAndExplode {
            0% {
                transform: translateY(200px) scale(0); /* 從底部向上射出 */
                opacity: 0;
            }
            30% {
                transform: translateY(0) scale(1); /* 射到指定高度 */
                opacity: 1;
            }
            100% {
                transform: translateY(-150px) scale(0.2); /* 爆炸並淡出 */
                opacity: 0;
            }
        }

        #congratulations-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--wechat-list-item-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-color);
            text-align: center;
            z-index: 1001;
            max-width: 80%;
            box-sizing: border-box;
            opacity: 0; /* 初始隱藏 */
            animation: fadeInModal 0.3s forwards; /* 使用現有的 fadeInModal */
        }

        #congratulations-modal p {
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary-color);
            line-height: 1.5;
        }
         body[data-theme="dark"] #congratulations-modal p {
            color: var(--wechat-text-primary);
        }

        #congratulations-modal button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #congratulations-modal button:hover {
            background-color: darken(var(--primary-color), 10%);
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-title-zh">AI 韩语学习小助手</div>
            <div class="splash-title-ko">AI 한국어 학습 도우미</div>
            <div class="splash-design-by">Design by MiniWorld</div>
        </div>
    </div>

    <div id="fireworks-container"></div>

    <div id="congratulations-modal">
        <p>🎉 恭喜你达成今日学习目标，打卡成功，再接再厉！ 🎉</p>
        <button id="close-congrats-modal">好的</button>
    </div>

    <div class="app-wrapper" id="app-wrapper">
        <header class="wechat-header">
            <div class="wechat-header-title" id="app-header-title">背单词</div>
        </header>

        <main class="wechat-content">
            <div id="page-memorize" class="content-page active">
                <div class="status">第 <span id="current-word-index">1</span> 个单词 / 共 <span id="total-words">0</span> 个单词</div>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div class="word-card-container">
                    <div class="word-card" id="word-card">
                        <div class="card-face card-face-front">
                            <div class="korean-word-container">
                                <div class="korean-word" id="korean-word">载入中...</div>
                                <button class="pronounce-btn">🔊</button>
                            </div>
                            <div class="pronunciation" id="pronunciation"></div>
                            <div class="hint-to-flip">点击卡片查看释义或AI扩展</div>
                        </div>
                        <div class="card-face card-face-back">
                            <div class="translation chinese-translation" id="chinese-translation"></div>
                            <div class="example-sentence" id="example-sentence">
                                <div class="korean-example" id="korean-example"></div>
                                <div class="chinese-example" id="chinese-example"></div>
                            </div>
                            <div class="ai-word-expansion-area">
                                <div class="ai-helper-container" id="ai-helper-box"><div class="ai-helper-title">💡 AI 助记/小提示:</div><div class="ai-helper-content" id="ai-helper-content"></div></div>
                                <div class="ai-sentence-generator-container" id="ai-sentence-generator-box"><div class="ai-sentence-generator-title">✍️ AI 智能例句:</div><div class="ai-generated-sentences" id="ai-generated-sentences"></div></div>
                                <div class="ai-usage-notes-container" id="ai-usage-notes-box"><div class="ai-usage-notes-title">🧐 AI 用法辨析:</div><div class="ai-usage-notes-content" id="ai-usage-notes-content"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button id="prev-word-btn">❮ 上一个</button>
                    <button id="show-translation-btn" onclick="flipCard()">查看/隐藏</button>
                    <button id="next-word-btn">下一个 ❯</button>
                </div>
                <div class="controls secondary-controls">
                    <button id="mark-known-btn">✔ 我认识</button>
                    <button class="ai-btn" id="ai-tip-btn">🤖 AI提示</button>
                </div>
                <div class="controls tertiary-controls">
                    <button class="ai-btn" id="ai-sentence-btn">✍️ AI造句</button>
                    <button class="ai-btn" id="ai-usage-btn">🧐 AI辨析</button>
                </div>
            </div>

            <div id="page-review-plan" class="content-page">
                <div class="review-summary"><p>总学习单词数: <span id="total-learned-count" class="count">0</span></p><p>今日到期复习: <span id="due-today-count" class="count">0</span></p></div>
                <div class="filter-buttons"><button id="filter-all" class="active">全部学习</button><button id="filter-due">到期复习</button><button id="filter-overdue">逾期复习</button></div>
                <div id="review-list-container"><p class="no-reviews">暂无复习计划，快去学习新单词吧！</p></div>
            </div>

            <div id="page-ai-functions" class="content-page menu-active">
                <div class="ai-function-menu" id="ai-main-menu">
                    <div class="ai-function-menu-item" data-sub-feature-id="page-translate" data-title="AI 智能互译">
                        <span class="icon">🌐</span> AI 智能互译
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-ai-dictionary" data-title="AI 韩语词典">
                        <span class="icon">📖</span> AI 韩语词典
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-image-recognition" data-title="AI 看图识别韩文">
                        <span class="icon">🔍</span> AI 看图识别韩文
                    </div>
                     <div class="ai-function-menu-item" data-sub-feature-id="page-local-video" data-title="本地视频浏览">
                        <span class="icon">🎬</span> 本地视频浏览
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-cloze" data-title="AI 克漏字填空">
                        <span class="icon">🎯</span> AI 克漏字填空
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-story" data-title="AI 小故事创作">
                        <span class="icon">✍️</span> AI 小故事创作
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-scenario" data-title="AI 情景对话模拟">
                        <span class="icon">🗣️</span> AI 情景对话模拟
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-essay-correction" data-title="AI 批改作文">
                        <span class="icon">📝</span> AI 批改作文
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-mc-questions" data-title="AI 自动生成选择题">
                        <span class="icon">❓</span> AI 自动生成选择题
                    </div>
                </div>

                <div id="page-translate" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🌐 AI 智能互译</h3>
                        <div class="api-key-info">🔑 AI翻译功能使用预设的API密钥。</div>
                        <textarea id="text-to-translate-auto" placeholder="输入韩语或中文进行互译..."></textarea>
                        <button class="translate-button generic-button" id="do-translate-auto-btn">AI 智能互译</button>
                        <div class="translation-result-area ai-output-box" id="translation-output-auto">翻译结果将显示在此</div>
                        <div id="ai-translation-analysis-area"></div>
                    </div>
                </div>

                <div id="page-ai-dictionary" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">📖 AI 韩语词典</h3>
                        <div style="display: flex;">
                            <input type="text" id="korean-word-input" placeholder="输入要查询的韩语单词...">
                            <button class="generic-button" id="search-dictionary-btn">查询</button>
                        </div>
                        <div id="dictionary-output" class="ai-output-box">请在上方输入韩语单词并点击查询。</div>
                    </div>
                </div>

                <div id="page-image-recognition" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🔍 AI 看图识别韩文</h3>
                        <label for="image-upload-rec" id="image-upload-label-rec">选择图片</label>
                        <input type="file" id="image-upload-rec" accept="image/*">
                        <div id="image-preview-container-rec">
                            <img id="image-preview-rec" src="#" alt="图片预览">
                        </div>
                        <button class="ai-action-btn" id="recognize-image-korean-btn" disabled>AI 识别韩文</button>
                        <div id="ai-image-recognition-output-ko" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>🇰🇷 识别到的韩文:</h5><span id="image-recognized-ko-text"></span>
                        </div>
                        <div id="ai-image-recognition-output-zh" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>🇨🇳 中文翻译及解释:</h5><span id="image-recognized-zh-text"></span>
                        </div>
                    </div>
                </div>

                <div id="page-local-video" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🎬 本地视频浏览</h3>
                        <p class="api-key-info">此功能允许您浏览本地视频文件并在线播放，AI 辅助功能正在开发中。</p>
                        <label for="video-upload-input" id="video-upload-label">选择视频文件</label>
                        <input type="file" id="video-upload-input" accept="video/*">
                        <div class="file-name-display" id="video-file-name">未选择文件</div>

                        <div id="video-player-container">
                            <video id="video-player" controls style="display: none;"></video>
                        </div>
                    </div>
                </div>

                <div id="feature-cloze" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🎯 AI 克漏字填空</h3>
                        <div id="cloze-test-area">
                            <p class="cloze-question" id="cloze-question-text">点击下方按钮生成题目。</p>
                            <p class="cloze-hint" id="cloze-hint-text"></p>
                            <input type="text" id="cloze-answer-input" placeholder="输入挖空部分的韩语单词">
                            <button class="ai-action-btn" id="submit-cloze-btn">提交答案</button>
                            <div id="cloze-feedback"></div>
                            <div id="cloze-correct-sentence"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-cloze-btn" style="margin-top:10px;">获取新填空题</button>
                    </div>
                </div>

                <div id="feature-story" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">✍️ AI 小故事创作</h3>
                        <div class="story-weaver-controls">
                            <label for="story-word-select">选择2-5个已学单词:</label>
                            <select id="story-word-select" multiple size="5"></select>
                            <p style="font-size:0.8em; color: var(--wechat-text-secondary)">按住 Ctrl/Cmd 点击多选。</p>
                        </div>
                        <button class="ai-action-btn" id="generate-story-btn">AI 帮我写故事</button>
                        <div id="ai-generated-story-ko" class="ai-output-box" style="display:none;"><h5>🇰🇷 韩语故事:</h5><span id="story-ko-text"></span></div>
                        <div id="ai-generated-story-zh" class="ai-output-box" style="display:none;"><h5>🇨🇳 中文翻译:</h5><span id="story-zh-text"></span></div>
                    </div>
                </div>

                <div id="feature-scenario" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🗣️ AI 情景对话模拟</h3>
                        <div id="ai-scenario-area">
                            <div class="scenario-difficulty-selector" style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;">
                                <label style="font-weight: bold; font-size: 0.95em;">选择对话难度：</label>
                                <input type="radio" name="scenario-difficulty" value="beginner" id="diff-beginner" checked> <label for="diff-beginner" style="font-size: 0.9em;">初级</label>
                                <input type="radio" name="scenario-difficulty" value="intermediate" id="diff-intermediate"> <label for="diff-intermediate" style="font-size: 0.9em;">中级</label>
                                <input type="radio" name="scenario-difficulty" value="advanced" id="diff-advanced"> <label for="diff-advanced" style="font-size: 0.9em;">高级</label>
                            </div>
                            <p id="ai-scenario-description">点击下方按钮生成对话情境。</p>
                            <div id="ai-scenario-dialogue-history"></div>
                            <textarea id="user-scenario-response" placeholder="请输入您的韩语回应..."></textarea>
                            <button class="ai-action-btn" id="submit-scenario-response-btn">发送回应</button>
                            <div id="ai-scenario-feedback" class="ai-output-box" style="margin-top:5px; display:none;"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-scenario-btn" style="margin-top:10px;">获取新对话情境</button>
                    </div>
                </div>

                <div id="feature-essay-correction" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">📝 AI 批改作文</h3>
                        <textarea id="essay-input" placeholder="在此输入您的韩语作文..."></textarea>
                        <button class="ai-action-btn" id="correct-essay-btn">AI 批改作文</button>
                        <div id="essay-feedback-area" class="ai-output-box" style="display:none;"></div>
                    </div>
                </div>

                <div id="feature-mc-questions" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">❓ AI 自动生成选择题</h3>
                        <div class="mc-category-select">
                            <label>选择题类型:</label>
                            <input type="radio" name="mc-category" value="grammar" id="mc-grammar" checked> <label for="mc-grammar">语法</label>
                            <input type="radio" name="mc-category" value="proverb" id="mc-proverb"> <label for="mc-proverb">谚语俗语</label>
                        </div>
                        <div class="mc-question-controls">
                            <label for="mc-count">数量:</label>
                            <input type="number" id="mc-count" value="3" min="1" max="5">
                            <button class="ai-action-btn" id="generate-mc-btn">生成选择题</button>
                        </div>
                        <div id="mc-questions-area" style="margin-top: 15px;">
                            <p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">点击上方按钮生成题目。</p>
                        </div>
                        <button class="ai-action-btn" id="submit-mc-answers-btn" style="display: none; margin-top: 15px;">提交答案</button>
                    </div>
                </div>

            </div>

            <div id="page-settings" class="content-page">
                <div class="profile-section">
                    <span class="profile-icon">👤</span>
                    <div class="profile-info">
                        <h3><span id="current-username-display">用户名</span></h3>
                        <p>欢迎回来！</p>
                    </div>
                </div>

                <div class="settings-list" id="settings-main-menu">
                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">学习设置</div>
                    <ul>
                        <li class="setting-item" id="learning-goals-menu-item">
                            <label><span class="icon">🎯</span> 学习目标</label>
                            <span class="arrow">▶</span>
                        </li>
                        <li class="setting-item">
                            <label for="word-list-select">字库:</label>
                            <select id="word-list-select" style="width: 150px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 4px; display: inline-block; margin-bottom:0; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);">
                                <option value="general">通用词汇</option>
                                <option value="computer">计算机专业词汇</option>
                                <option value="business">经营专业词汇</option>
                            </select>
                        </li>
                        <li class="setting-item">
                            <label for="auto-pronounce-next"><span class="icon">🔊</span> 自动发音下一个单词</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-pronounce-next" checked>
                                <span class="slider"></span>
                            </label>
                        </li>
                    </ul>

                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">UI 设置</div>
                    <ul>
                        <li class="setting-item">
                            <label for="dark-mode-toggle"><span class="icon">🌙</span> 暗黑模式</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </li>
                        <li class="setting-item" style="padding-bottom: 15px;">
                            <label><span class="icon">🎨</span> 主题颜色</label>
                            <div>
                                <span class="color-option color-red" data-color="red" title="红色"></span>
                                <span class="color-option color-orange" data-color="orange" title="橙色"></span>
                                <span class="color-option color-yellow" data-color="yellow" title="黄色"></span>
                                <span class="color-option color-green" data-color="green" title="绿色"></span>
                                <span class="color-option color-cyan" data-color="cyan" title="青色"></span>
                                <span class="color-option color-blue" data-color="blue" title="蓝色"></span>
                                <span class="color-option color-purple" data-color="purple" title="紫色"></span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="about-section">
                    <button class="about-button" onclick="showAboutPage()">
                        <span class="icon">ℹ️</span> 关于
                    </button>
                </div>
            </div>

            <div id="page-study-goals" class="content-page">
                <button class="back-button" onclick="showSettingsMainMenu()">← 返回</button>
                <div class="goals-container">
                    <h3>学习目标设定</h3>
                    <div class="goal-item">
                        <label for="daily-study-amount">每日新词学习量:</label>
                        <input type="number" id="daily-study-amount" value="10" min="1" max="50">
                    </div>
                </div>

                <div class="streak-calendar">
                    <h3>学习打卡日历</h3>
                    <div class="calendar-header">
                        <span id="calendar-month-year"></span>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <div class="calendar-day-header">日</div>
                        <div class="calendar-day-header">一</div>
                        <div class="calendar-day-header">二</div>
                        <div class="calendar-day-header">三</div>
                        <div class="calendar-day-header">四</div>
                        <div class="calendar-day-header">五</div>
                        <div class="calendar-day-header">六</div>
                        </div>
                     <p style="font-size: 0.85em; color: var(--wechat-text-secondary); text-align: center; margin-top: 15px;">
                        每日学习新词达到目标数量后自动打卡。
                    </p>
                </div>
            </div>


            <div id="page-about" class="content-page">
                <button class="back-button" onclick="setActivePage('page-settings', '我')">← 返回</button>
                <div class="about-content-area">
                    <h3>关于本应用</h3>
                    <p>
                        <strong>中文:</strong> 本软件由MiniWorld团队开发。<br>
                        <strong>有问题请联系:</strong> haechojo@gmail.com<br>
                        <strong>版本号:</strong> 0.9beta<br>
                        <strong>发布日期:</strong> 2025年5月27日
                    </p>
                    <p>
                        <strong>한국어:</strong> 이 소프트웨어는 MiniWorld 팀에 의해 개발되었습니다.<br>
                        <strong>문의:</strong> haechojo@gmail.com<                        strong>버전:</strong> 0.9beta<br>
                        <strong>출시일:</strong> 2025년 5月27日
                    </p>
                </div>
            </div>
        </main>

        <nav class="wechat-tabbar">
            <div class="tab-item active" data-page="page-memorize" data-title="背单词"><div class="tab-item-icon">🧠</div><div class="tab-item-label">背单词</div></div>
            <div class="tab-item" data-page="page-review-plan" data-title="复习"><div class="tab-item-icon">📅</div><div class="tab-item-label">复习</div></div>
            <div class="tab-item" data-page="page-ai-functions" data-title="AI功能"><div class="tab-item-icon">🤖</div><div class="tab-item-label">AI功能</div></div>
            <div class="tab-item" data-page="page-settings" data-title="我"><div class="tab-item-icon">👤</div><div class="tab-item-label">我</div></div>
        </nav>
    </div>


<script>
    const GEMINI_API_KEY = "AIzaSyDlBJ3rTN0VlfLDKHgyJiqQ1VoYIcw9bXs"; // 確保這裡是您的有效API密鑰

    const appWrapperEl = document.getElementById('app-wrapper');
    const appHeaderTitleEl = document.getElementById('app-header-title');
    const contentPages = document.querySelectorAll('.content-page');
    const tabItems = document.querySelectorAll('.tab-item');

    const koreanWordEl = document.getElementById('korean-word');
    const pronunciationEl = document.getElementById('pronunciation');
    const chineseTranslationEl = document.getElementById('chinese-translation');
    const exampleSentenceEl = document.getElementById('example-sentence');
    const koreanExampleEl = document.getElementById('korean-example');
    const chineseExampleEl = document.getElementById('chinese-example');
    const wordCardEl = document.getElementById('word-card');
    const progressBarEl = document.getElementById('progress-bar');
    const currentWordIndexEl = document.getElementById('current-word-index');
    const totalWordsEl = document.getElementById('total-words');
    const aiHelperBoxEl = document.getElementById('ai-helper-box');
    const aiHelperContentEl = document.getElementById('ai-helper-content');
    const aiSentenceGeneratorBoxEl = document.getElementById('ai-sentence-generator-box');
    const aiGeneratedSentencesEl = document.getElementById('ai-generated-sentences');
    const aiUsageNotesBoxEl = document.getElementById('ai-usage-notes-box');
    const aiUsageNotesContentEl = document.getElementById('ai-usage-notes-content');
    const pronounceBtnEl = document.querySelector('#page-memorize .pronounce-btn');

    const reviewListContainerEl = document.getElementById('review-list-container');
    const totalLearnedCountEl = document.getElementById('total-learned-count');
    const dueTodayCountEl = document.getElementById('due-today-count');
    const filterButtonsReview = document.querySelectorAll('#page-review-plan .filter-buttons button');

    const pageAiFunctionsEl = document.getElementById('page-ai-functions');
    const aiFunctionMenuBtns = document.querySelectorAll('#page-ai-functions .ai-function-menu-item');
    const aiSubFeatureSections = document.querySelectorAll('#page-ai-functions .ai-sub-feature-section');

    const textToTranslateAutoEl = document.getElementById('text-to-translate-auto');
    const doTranslateAutoBtnEl = document.getElementById('do-translate-auto-btn');
    const translationOutputAutoEl = document.getElementById('translation-output-auto');
    const aiTranslationAnalysisAreaEl = document.getElementById('ai-translation-analysis-area');

    const koreanWordInputEl = document.getElementById('korean-word-input');
    const searchDictionaryBtnEl = document.getElementById('search-dictionary-btn');
    const dictionaryOutputEl = document.getElementById('dictionary-output');

    const imageUploadInputRecEl = document.getElementById('image-upload-rec');
    const imagePreviewRecEl = document.getElementById('image-preview-rec');
    const recognizeImageKoreanBtnEl = document.getElementById('recognize-image-korean-btn');
    const imageRecognizedKoTextEl = document.getElementById('image-recognized-ko-text');
    const imageRecognizedZhTextEl = document.getElementById('image-recognized-zh-text');
    let uploadedImageBase64Rec = null;
    let uploadedImageMimeTypeRec = null;

    const videoUploadInputEl = document.getElementById('video-upload-input');
    const videoPlayerEl = document.getElementById('video-player');
    const videoFileNameDisplayEl = document.getElementById('video-file-name');

    const clozeQuestionTextEl = document.getElementById('cloze-question-text');
    const clozeHintTextEl = document.getElementById('cloze-hint-text');
    const clozeAnswerInputEl = document.getElementById('cloze-answer-input');
    const clozeFeedbackEl = document.getElementById('cloze-feedback');
    const clozeCorrectSentenceEl = document.getElementById('cloze-correct-sentence');
    const generateClozeBtnEl = document.getElementById('generate-cloze-btn');
    const submitClozeBtnEl = document.getElementById('submit-cloze-btn');
    let currentClozeWordData = null;

    const storyWordSelectEl = document.getElementById('story-word-select');
    const generateStoryBtnEl = document.getElementById('generate-story-btn');
    const aiGeneratedStoryKoBox = document.getElementById('ai-generated-story-ko');
    const storyKoTextEl = document.getElementById('story-ko-text');
    const aiGeneratedStoryZhBox = document.getElementById('ai-generated-story-zh');
    const storyZhTextEl = document.getElementById('story-zh-text');

    const aiScenarioDescriptionEl = document.getElementById('ai-scenario-description');
    const aiScenarioDialogueHistoryEl = document.getElementById('ai-scenario-dialogue-history');
    const userScenarioResponseEl = document.getElementById('user-scenario-response');
    const submitScenarioResponseBtnEl = document.getElementById('submit-scenario-response-btn');
    const aiScenarioFeedbackEl = document.getElementById('ai-scenario-feedback');
    const generateScenarioBtnEl = document.getElementById('generate-scenario-btn');
    let currentAIScenarioContext = [];

    const essayInputEl = document.getElementById('essay-input');
    const correctEssayBtnEl = document.getElementById('correct-essay-btn');
    const essayFeedbackAreaEl = document.getElementById('essay-feedback-area');

    const mcCategoryRadioBtns = document.querySelectorAll('input[name="mc-category"]');
    const mcTopicInputEl = document.getElementById('mc-topic');
    const mcCountInputEl = document.getElementById('mc-count');
    const generateMcBtnEl = document.getElementById('generate-mc-btn');
    const mcQuestionsAreaEl = document.getElementById('mc-questions-area');
    const submitMcAnswersBtnEl = document.getElementById('submit-mc-answers-btn');
    let currentMCQuestions = [];

    const currentUsernameDisplayEl = document.getElementById('current-username-display');
    const dailyStudyAmountInput = document.getElementById('daily-study-amount');
    const autoPronounceNextCheckbox = document.getElementById('auto-pronounce-next');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const colorOptions = document.querySelectorAll('.color-option');
    const pageAboutEl = document.getElementById('page-about');
    const pageStudyGoalsEl = document.getElementById('page-study-goals');
    const learningGoalsMenuItem = document.getElementById('learning-goals-menu-item');
    const wordListSelectEl = document.getElementById('word-list-select');

    const calendarGridEl = document.getElementById('calendar-grid');
    const calendarMonthYearEl = document.getElementById('calendar-month-year');

    // 新增開屏動畫和煙花相關元素
    const splashScreen = document.getElementById('splash-screen');
    const fireworksContainer = document.getElementById('fireworks-container');
    const congratulationsModal = document.getElementById('congratulations-modal');
    const closeCongratsModalButton = document.getElementById('close-congrats-modal');


    let allWordLists = {
        general: [
            { korean: "안녕하세요", pronunciation: "[an-nyeong-ha-se-yo]", chinese: "你好", korean_example: "A: 안녕하세요, 처음 뵙겠습니다.\nB: 네, 안녕하세요. 만나서 반갑습니다.", chinese_example: "A: 你好，初次见面。\nB: 是的，你好。见到你很高兴。" },
            { korean: "감사합니다", pronunciation: "[gam-sa-ham-ni-da]", chinese: "谢谢", korean_example: "도와주셔서 정말 감사합니다.", chinese_example: "非常感谢您的帮助。" },
            { korean: "공부하다", pronunciation: "[gong-bu-ha-da]", chinese: "学习", korean_example: "저는 한국어를 공부해요.", chinese_example: "我学习韩语。" },
            { korean: "영화", pronunciation: "[yeong-hwa]", chinese: "电影", korean_example: "어떤 영화를 좋아해요?", chinese_example: "你喜欢什么电影？" },
            { korean: "음악", pronunciation: "[eu-mak]", chinese: "音乐", korean_example: "저는 클래식 음악을 즐겨 들어요.", chinese_example: "我喜欢听古典音乐。" },
            { korean: "여행", pronunciation: "[yeo-haeng]", chinese: "旅行", korean_example: "다음 휴가 때 여행 갈 계획이에요.", chinese_example: "我计划下次休假去旅行。" },
            { korean: "가족", pronunciation: "[ga-jok]", chinese: "家庭", korean_example: "우리 가족은 모두 다섯 명이에요.", chinese_example: "我们家一共五口人。" },
            { korean: "사랑", pronunciation: "[sa-rang]", chinese: "爱", korean_example: "사랑은 아름다운 감정이에요.", chinese_example: "爱是一种美丽的情感。" },
            { korean: "행복", pronunciation: "[haeng-bok]", chinese: "幸福", korean_example: "모두가 행복하길 바라요.", chinese_example: "希望所有人都幸福。" },
            { korean: "시간", pronunciation: "[si-gan]", chinese: "时间", korean_example: "시간就是金钱。", chinese_example: "时间就是金钱。" },
            { korean: "책", pronunciation: "[chaek]", chinese: "书", korean_example: "저는 책을 읽는 것을 좋아해요.", chinese_example: "我喜欢读书。" },
            { korean: "친구", pronunciation: "[chin-gu]", chinese: "朋友", korean_example: "저는 좋은 친구가 많아요.", chinese_example: "我有很多好朋友。" },
            { korean: "학교", pronunciation: "[hak-gyo]", chinese: "学校", korean_example: "학교에 매일 가요.", chinese_example: "我每天去学校。" },
            { korean: "음식", pronunciation: "[eum-sik]", chinese: "食物", korean_example: "한국 음식을 좋아해요.", chinese_example: "我喜欢韩国食物。" },
            { korean: "물", pronunciation: "[mul]", chinese: "水", korean_example: "목마를 때 물을 마셔요.", chinese_example: "口渴的时候喝水。" },
            { korean: "집", pronunciation: "[jip]", chinese: "家", korean_example: "집에서 쉬고 싶어요.", chinese_example: "我想在家休息。" },
            { korean: "말하다", pronunciation: "[mal-ha-da]", chinese: "说", korean_example: "한국어로 말하고 싶어요.", chinese_example: "我想说韩语。" },
            { korean: "듣다", pronunciation: "[deut-da]", chinese: "听", korean_example: "음악을 듣는 중이에요.", chinese_example: "我正在听音乐。" },
            { korean: "보다", pronunciation: "[bo-da]", chinese: "看", korean_example: "영화를 볼까요?", chinese_example: "我们看电影吗？" },
            { korean: "먹다", pronunciation: "[meok-da]", chinese: "吃", korean_example: "점심을 먹어요.", chinese_example: "我吃午饭。" },
            { korean: "가다", pronunciation: "[ga-da]", chinese: "去", korean_example: "학교에 가요.", chinese_example: "我去学校。" },
            { korean: "오다", pronunciation: "[o-da]", chinese: "来", korean_example: "집에 왔어요.", chinese_example: "我到家了。" },
            { korean: "하다", pronunciation: "[ha-da]", chinese: "做", korean_example: "숙제를 해요.", chinese_example: "我做作业。" },
            { korean: "크다", pronunciation: "[keu-da]", chinese: "大", korean_example: "집이 커요.", chinese_example: "房子很大。" },
            { korean: "작다", pronunciation: "[jak-da]", chinese: "小", korean_example: "방이 작아요.", chinese_example: "房间很小。" },
            { korean: "예쁘다", pronunciation: "[ye-ppeu-da]", chinese: "漂亮", korean_example: "꽃이 예뻐요.", chinese_example: "花很漂亮。" },
            { korean: "좋다", pronunciation: "[jot-da]", chinese: "好", korean_example: "날씨가 좋아요.", chinese_example: "天气很好。" },
            { korean: "나쁘다", pronunciation: "[na-ppeu-da]", chinese: "不好", korean_example: "기분이 나빠요.", chinese_example: "心情不好。" },
            { korean: "많다", pronunciation: "[man-ta]", chinese: "多", korean_example: "친구가 많아요.", chinese_example: "朋友很多。" },
            { korean: "없다", pronunciation: "[eop-da]", chinese: "没有", korean_example: "돈이 없어요.", chinese_example: "我没有钱。" }
        ],
        computer: [
            { korean: "컴퓨터", pronunciation: "[keom-pyu-teo]", chinese: "电脑", korean_example: "새 컴퓨터를 샀어요.", chinese_example: "我买了新电脑。" },
            { korean: "소프트웨어", pronunciation: "[so-peu-teu-we-eo]", chinese: "软件", korean_example: "이 소프트웨어를 설치해야 해요.", chinese_example: "我需要安装这个软件。" },
            { korean: "하드웨어", pronunciation: "[ha-deu-we-eo]", chinese: "硬件", korean_example: "컴퓨터 하드웨어는 중요해요.", chinese_example: "电脑硬件很重要。" },
            { korean: "프로그래밍", pronunciation: "[peu-ro-geu-rae-ming]", chinese: "编程", korean_example: "저는 파이썬으로 프로그래밍을 공부하고 있어요.", chinese_example: "我正在学习用Python编程。" },
            { korean: "네트워크", pronunciation: "[ne-teu-weo-keu]", chinese: "网络", korean_example: "네트워크 연결이 불안정해요.", chinese_example: "网络连接不稳定。" },
            { korean: "데이터", pronunciation: "[de-i-teo]", chinese: "数据", korean_example: "빅데이터 분석은 중요해요.", chinese_example: "大数据分析很重要。" },
            { korean: "알고리즘", pronunciation: "[al-go-ri-jeum]", chinese: "算法", korean_example: "이 알고리즘은 매우 효율적이에요.", chinese_example: "这个算法非常高效。" },
            { korean: "인공지능", pronunciation: "[in-gong-ji-neung]", chinese: "人工智能", korean_example: "인공지능은 미래 기술이에요.", chinese_example: "人工智能是未来的技术。" },
            { korean: "클라우드", pronunciation: "[keul-la-u-deu]", chinese: "云（计算）", korean_example: "클라우드 서비스를 이용하고 있어요.", chinese_example: "我正在使用云计算服务。" },
            { korean: "보안", pronunciation: "[bo-an]", chinese: "安全（信息安全）", korean_example: "정보 보안이 매우 중요해요.", chinese_example: "信息安全非常重要。" }
        ],
        business: [
            { korean: "경제", pronunciation: "[gyeong-je]", chinese: "经济", korean_example: "세계 경제가 어렵습니다.", chinese_example: "世界经济很困难。" },
            { korean: "경영", pronunciation: "[gyeong-yeong]", chinese: "经营/管理", korean_example: "경영학을 전공했어요.", chinese_example: "我主修经营学。" },
            { korean: "마케팅", pronunciation: "[ma-ke-ting]", chinese: "市场营销", korean_example: "새로운 마케팅 전략이 필요해요.", chinese_example: "我们需要新的市场营销策略。" },
            { korean: "회계", pronunciation: "[hoe-gye]", chinese: "会计", korean_example: "회계 보고서를 작성해야 해요.", chinese_example: "我需要准备会计报告。" },
            { korean: "투자", pronunciation: "[tu-ja]", chinese: "投资", korean_example: "부동산에 투자했어요.", chinese_example: "我投资了房地产。" },
            { korean: "수익", pronunciation: "[su-ik]", chinese: "收益/利润", korean_example: "회사의 수익이 증가했어요.", chinese_example: "公司的收益增加了。" },
            { korean: "비용", pronunciation: "[bi-yong]", chinese: "费用/成本", korean_example: "불필요한 비용을 줄여야 해요.", chinese_example: "我们需要削减不必要的成本。" },
            { korean: "시장", pronunciation: "[si-jang]", chinese: "市场", korean_example: "한국 시장을 분석하고 있어요.", chinese_example: "我正在分析韩国市场。" },
            { korean: "전략", pronunciation: "[jeon-llyak]", chinese: "战略", korean_example: "장기적인 전략을 세워야 해요.", chinese_example: "我们需要制定长期战略。" },
            { korean: "고객", pronunciation: "[go-gaek]", chinese: "顾客/客户", korean_example: "고객 만족이 최우선이에요.", chinese_example: "顾客满意是我们的首要任务。" }
        ]
    };

    let currentWordListName = 'general';
    let wordList = allWordLists[currentWordListName];

    let currentWordIndex = 0;
    let isCardFlipped = false;
    let synth = window.speechSynthesis;
    let learnedWordsData = {};
    const srsIntervals = [1, 3, 7, 15, 30, 60, 120];

    let dailyNewWordsLimit = 10;
    let dailyNewWordsLearnedToday = 0;
    let studyStreak = {};

    function getTodayDateString() {
        const today = new Date();
        return today.toISOString().slice(0, 10);
    }

    function loadLearnedWords() {
        const savedCurrentList = localStorage.getItem('hanyangKoreanCurrentWordList_AI_Advanced_v10');
        if (savedCurrentList && allWordLists[savedCurrentList]) {
            currentWordListName = savedCurrentList;
        } else {
            currentWordListName = 'general';
        }
        wordList = allWordLists[currentWordListName];

        if (wordListSelectEl) {
            wordListSelectEl.value = currentWordListName;
        }

        const data = localStorage.getItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`);
        if (data) {
            learnedWordsData = JSON.parse(data);
        } else {
            learnedWordsData = {};
        }

        const savedLimit = localStorage.getItem('dailyNewWordsLimit');
        if (savedLimit) dailyNewWordsLimit = parseInt(savedLimit, 10);
        if (dailyStudyAmountInput) dailyStudyAmountInput.value = dailyNewWordsLimit;

        const savedLearnedToday = localStorage.getItem('dailyNewWordsLearnedToday');
        const savedDate = localStorage.getItem('lastDailyNewWordsDate');
        const todayStr = getTodayDateString();

        if (savedDate === todayStr) {
            dailyNewWordsLearnedToday = parseInt(savedLearnedToday, 10);
        } else {
            dailyNewWordsLearnedToday = 0;
            localStorage.setItem('dailyNewWordsLearnedToday', 0);
            localStorage.setItem('lastDailyNewWordsDate', todayStr);
        }

        const savedStreak = localStorage.getItem('hanyangKoreanStudyStreak');
        if (savedStreak) {
            try {
                studyStreak = JSON.parse(savedStreak);
            } catch (e) {
                console.error("Error parsing study streak from localStorage", e);
                studyStreak = {};
            }
        } else {
            studyStreak = {};
        }
    }

    function saveLearnedWords() {
        localStorage.setItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`, JSON.stringify(learnedWordsData));
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);
        localStorage.setItem('dailyNewWordsLearnedToday', dailyNewWordsLearnedToday);
        localStorage.setItem('lastDailyNewWordsDate', getTodayDateString());
        localStorage.setItem('hanyangKoreanStudyStreak', JSON.stringify(studyStreak));
    }

    function renderCalendar() {
        if (!calendarGridEl) return;

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        calendarMonthYearEl.textContent = `${year}年 ${month + 1}月`;
        calendarGridEl.innerHTML = `
            <div class="calendar-day-header">日</div>
            <div class="calendar-day-header">一</div>
            <div class="calendar-day-header">二</div>
            <div class="calendar-day-header">三</div>
            <div class="calendar-day-header">四</div>
            <div class="calendar-day-header">五</div>
            <div class="calendar-day-header">六</div>
        `;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const numDaysInMonth = lastDayOfMonth.getDate();
        const firstDayOfWeek = firstDayOfMonth.getDay();

        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarGridEl.appendChild(emptyDay);
        }

        for (let day = 1; day <= numDaysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = day;

            const currentDay = new Date(year, month, day);
            const dayString = currentDay.toISOString().slice(0, 10);

            if (dayString === getTodayDateString()) {
                dayEl.classList.add('today');
            }
            if (studyStreak[dayString]) {
                dayEl.classList.add('checked');
            }
            calendarGridEl.appendChild(dayEl);
        }
    }

    // 修改 checkDailyStudyGoal 函數以顯示煙花和彈窗
    function checkDailyStudyGoal() {
        const todayStr = getTodayDateString();
        // 重新計算今日學習新詞數量
        const wordsLearnedToday = Object.values(learnedWordsData).filter(word => {
            const firstLearnedDate = new Date(word.firstLearned).toISOString().slice(0, 10);
            return firstLearnedDate === todayStr && word.reviewCount === 1; // 第一次學習才算新詞
        }).length;

        if (wordsLearnedToday >= dailyNewWordsLimit && !studyStreak[todayStr]) {
            studyStreak[todayStr] = true;
            saveLearnedWords(); // 保存打卡記錄
            renderCalendar(); // 更新日曆
            showFireworks(); // 顯示煙花
            showCongratulationsModal(); // 顯示恭喜彈窗
            console.log("今日學習目標已完成，打卡成功！");
        }
    }

    function showFireworks() {
        fireworksContainer.innerHTML = ''; // 清空之前的煙花
        const numberOfFireworks = 20; // 煙花數量
        for (let i = 0; i < numberOfFireworks; i++) {
            const firework = document.createElement('div');
            firework.classList.add('firework');
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6; // 煙花出現的上半部分
            firework.style.left = `${x}px`;
            firework.style.top = `${y}px`;
            const color = `hsl(${Math.random() * 360}, 100%, 50%)`; // 隨機顏色
            firework.style.backgroundColor = color;
            const animationDelay = Math.random() * 0.5; // 隨機延遲
            firework.style.animationDelay = `${animationDelay}s`;
            fireworksContainer.appendChild(firework);
        }
        // 煙花動畫結束後清空容器
        setTimeout(() => {
            fireworksContainer.innerHTML = '';
        }, 2000); // 煙花顯示 2 秒後消失
    }

    function showCongratulationsModal() {
        congratulationsModal.style.display = 'block';
        congratulationsModal.style.opacity = '1'; // 確保顯示時透明度為 1
    }

    function hideCongratulationsModal() {
        congratulationsModal.style.display = 'none';
    }


    function applySavedSettings() {
        const savedTheme = localStorage.getItem('hanyangKoreanTheme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            if (darkModeToggle) darkModeToggle.checked = true;
        } else {
            document.body.removeAttribute('data-theme');
            if (darkModeToggle) darkModeToggle.checked = false;
        }

        const savedColorTheme = localStorage.getItem('hanyangKoreanColorTheme');
        if (savedColorTheme) {
            document.body.setAttribute('data-color-theme', savedColorTheme);
            selectThemeColor(savedColorTheme, false);
        } else {
            document.body.setAttribute('data-color-theme', 'green');
            selectThemeColor('green', false);
        }
    }

    function toggleDarkMode() {
        if (darkModeToggle.checked) {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('hanyangKoreanTheme', 'dark');
        } else {
            document.body.removeAttribute('data-theme');
            localStorage.removeItem('hanyangKoreanTheme');
        }
    }

    function selectThemeColor(color, save = true) {
        document.body.setAttribute('data-color-theme', color);
        colorOptions.forEach(option => {
            option.style.cursor = 'pointer';
            option.classList.toggle('selected', option.dataset.color === color);
        });
        if (save) {
            localStorage.setItem('hanyangKoreanColorTheme', color);
        }
    }

    async function callGeminiAPI(contents, purpose = "general", targetElementForLoading = null) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            const msg = "錯誤：Gemini API密鑰無效或未在JS中正確設置。"; console.error(msg);
            if (targetElementForLoading) { targetElementForLoading.textContent = msg; targetElementForLoading.classList.add('error'); targetElementForLoading.classList.remove('loading'); }
            return null;
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        
        // Ensure contents is always an array of objects with role and parts
        let formattedContents;
        if (Array.isArray(contents)) {
            // If it's already an array, ensure each item has role/parts structure
            formattedContents = contents.map(item => {
                if (item.role && item.parts) {
                    return item;
                } else if (item.text || item.inline_data) { // Assume it's a part and wrap it
                    return { role: "user", parts: [item] };
                }
                return { role: "user", parts: [{ text: JSON.stringify(item) }] }; // Fallback for unexpected formats
            });
        } else if (contents.text || contents.inline_data) { // If it's a single part
            formattedContents = [{ role: "user", parts: [contents] }];
        } else { // Fallback for unexpected single object formats
            formattedContents = [{ role: "user", parts: [{ text: JSON.stringify(contents) }] }];
        }

        const requestBody = { contents: formattedContents, generationConfig: { "candidateCount": 1, "temperature": 0.6 } };

        if (targetElementForLoading) { targetElementForLoading.innerHTML = ""; targetElementForLoading.classList.add('loading'); targetElementForLoading.classList.remove('error');}

        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (targetElementForLoading) targetElementForLoading.classList.remove('loading');
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: "無法解析API錯誤回應" } }));
                throw new Error(`API 錯誤 (${response.status}): ${errorData.error?.message || '未知錯誤'}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                return data.candidates[0].content.parts[0].text.trim();
            } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                 throw new Error(`請求被阻止: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`);
            } else { throw new Error("AI未能生成有效內容或返回了預期外的数据結構。"); }
        } catch (error) {
            console.error(`Gemini API 調用失敗，目的 "${purpose}":`, error);
            if (targetElementForLoading) { targetElementForLoading.textContent = `AI調用失敗: ${error.message}`; targetElementForLoading.classList.add('error');}
            return null;
        }
    }

    async function getAITipForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiHelperContentEl.textContent = ""; aiHelperBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `我正在學習韓語單字 "${korean}"，它的中文意思是 "${chinese}"。請用簡體中文給我一個非常簡短、有趣且易於記憶的助記方法，或者一個與這個單字緊密相關的韓國文化小知識，幫助我記住它。請專注於一個點，保持在一兩句話之內。`;
        const aiTip = await callGeminiAPI([{text: prompt}], "ai_tip", aiHelperContentEl);
        if (aiTip && !aiHelperContentEl.classList.contains('error')) aiHelperContentEl.textContent = aiTip;
    }
    async function getAISentencesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiGeneratedSentencesEl.innerHTML = ""; aiSentenceGeneratorBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `為韓語單字 "${korean}" (意思是 "${chinese}") 生成2-3個簡短實用的韓語例句，並為每個例句提供對應的簡體中文翻譯。請確保例句簡單易懂，適合初學者。格式如下：\n1. 韓語例句1\n   中文翻譯1\n2. 韓語例句2\n   中文翻譯2`;
        const sentencesText = await callGeminiAPI([{text: prompt}], "ai_sentence", aiGeneratedSentencesEl);
        if (sentencesText && !aiGeneratedSentencesEl.classList.contains('error')) {
            const lines = sentencesText.split('\n').filter(line => line.trim() !== ''); let htmlContent = "<ul>";
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].match(/^\d+\.\s*/)) { htmlContent += `<li><strong>${lines[i].replace(/^\d+\.\s*/, '')}</strong><br>`;
                    if (lines[i+1] && !lines[i+1].match(/^\d+\.\s*/)) { htmlContent += `<span style="font-size:0.9em; color:var(--wechat-text-secondary);">${lines[i+1]}</span></li>`; i++; }
                    else { htmlContent += `</li>`; }
                }
            } htmlContent += "</ul>"; aiGeneratedSentencesEl.innerHTML = htmlContent;
        }
    }
    async function getAIUsageNotesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiUsageNotesContentEl.textContent = ""; aiUsageNotesBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `關於韓語單字 "${korean}" (意思是 "${chinese}")：\n1. 它最常見的用法或搭配是什麼？\n2. 有沒有初學者容易混淆的用法或者和中文意思的細微差別？\n3. 如果有相關的近義詞或反義詞，請舉一例。\n請用簡體中文簡明扼要地回答，每個點一兩句話即可。`;
        const usageNotes = await callGeminiAPI([{text: prompt}], "ai_usage", aiUsageNotesContentEl);
        if (usageNotes && !aiUsageNotesContentEl.classList.contains('error')) aiUsageNotesContentEl.textContent = usageNotes;
    }

    async function translateAutoDetect() {
        const text = textToTranslateAutoEl.value.trim();
        if (!text) { translationOutputAutoEl.textContent = "請輸入要翻譯的內容。"; aiTranslationAnalysisAreaEl.innerHTML = ""; return; }
        const prompt = `請自動檢測以下文本是中文還是韓語。\n- 如果是中文，請將其翻譯成韓語。\n- 如果是韓語，請將其翻譯成簡體中文。\n請只提供翻譯後的文本，不要包含任何額外的解釋、介紹或圍繞翻譯本身的引號。\n文本內容如下：\n"${text}"`;
        aiTranslationAnalysisAreaEl.innerHTML = "";
        const translatedText = await callGeminiAPI([{text: prompt}], "auto_translate", translationOutputAutoEl);
        if (translatedText && !translationOutputAutoEl.classList.contains('error')) {
            translationOutputAutoEl.textContent = translatedText;
        }
    }

    async function searchAIDictionary() {
        const koreanWord = koreanWordInputEl.value.trim();
        if (!koreanWord) { dictionaryOutputEl.textContent = "請輸入要查詢的韓語單字。"; dictionaryOutputEl.classList.remove('loading', 'error'); return; }
        const prompt = `請為韓語單字 "${koreanWord}" 提供一個詳細的中文詞典條目，包含以下部分：\n1. **發音**：[羅馬音標記]\n2. **詞性**：例如 名詞, 動詞, 形容詞等。\n3. **中文釋義**：列出1-3個主要意思，每個意思後附帶一個韓語例句及其簡體中文翻譯。\n   - 意思1: [中文意思1]\n     例句 (韓): [韓語例句1]\n     例句 (中): [中文翻譯1]\n   - 意思2: [中文意思2]\n     例句 (韓): [韓語例句2]\n     例句 (中): [中文翻譯2]\n4. **常用搭配** (可選，1-2個)：例如 "${koreanWord} + (名詞/動詞)"\n5. **近義詞** (可選，1個)：[韓語近義詞] - [中文意思]\n6. **反義詞** (可選，1個)：[韓語反義詞] - [中文意思]\n7. **詞源/助記** (可選，一句話簡述，若有意義)：\n請確保格式清晰，例句實用。如果某些部分不適用或難以找到，可以省略該部分，但請盡量提供核心信息。`;
        const dictionaryEntryText = await callGeminiAPI([{text: prompt}], "ai_dictionary", dictionaryOutputEl);
        if (dictionaryEntryText && !dictionaryOutputEl.classList.contains('error')) {
            dictionaryOutputEl.innerHTML = dictionaryEntryText.replace(/\n/g, '<br>');
        }
    }

    async function generateImageRecognition() {
        if (!uploadedImageBase64Rec || !uploadedImageMimeTypeRec) { alert("請先選擇一張圖片。"); return; }
        imageRecognizedKoTextEl.textContent = ""; imageRecognizedZhTextEl.textContent = "";
        const recognitionOutputKoBox = document.getElementById('ai-image-recognition-output-ko');
        const recognitionOutputZhBox = document.getElementById('ai-image-recognition-output-zh');

        recognitionOutputKoBox.classList.add('loading');
        recognitionOutputKoBox.style.display = 'block';
        recognitionOutputZhBox.style.display = 'none';

        const promptParts = [
            { inline_data: { mime_type: uploadedImageMimeTypeRec, data: uploadedImageBase64Rec } },
            { text: "請識別圖片中的韓語文字（如果有的话）。然後，請在下一行用 '---中文翻譯及解釋---' 分隔，提供識別到的韓語文字的簡體中文翻譯和簡要解釋（例如，這是什麼意思，或者在什麼情境下使用）。如果圖片中沒有韓語文字，請說明圖片內容，並說明未找到韓語文字。"}
        ];
        const resultText = await callGeminiAPI([{role: "user", parts: promptParts}], "image_recognition", recognitionOutputKoBox);

        if (resultText && !recognitionOutputKoBox.classList.contains('error')) {
            const parts = resultText.split("---中文翻譯及解釋---");
            imageRecognizedKoTextEl.textContent = parts[0] ? parts[0].trim() : "AI未能識別到韓語文字。";
            if (parts[1]) {
                imageRecognizedZhTextEl.textContent = parts[1].trim();
                recognitionOutputZhBox.style.display = 'block';
            } else {
                imageRecognizedZhTextEl.textContent = "AI未能提供中文翻譯和解釋。";
                recognitionOutputZhBox.style.display = 'block';
            }
        } else if (!resultText && !recognitionOutputKoBox.classList.contains('error')) {
            imageRecognizedKoTextEl.textContent = "AI看圖識別韓文失敗或未返回內容。";
        }
    }

    function handleVideoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const fileURL = URL.createObjectURL(file);
            videoPlayerEl.src = fileURL;
            videoPlayerEl.style.display = 'block';
            videoPlayerEl.load();
            videoFileNameDisplayEl.textContent = `目前文件: ${file.name}`;
        } else {
            videoPlayerEl.src = '';
            videoPlayerEl.style.display = 'none';
            videoFileNameDisplayEl.textContent = '未選擇文件';
        }
    }

    async function generateAIClozeTest() {
        clozeQuestionTextEl.textContent = ""; clozeHintTextEl.textContent = ""; clozeAnswerInputEl.value = "";
        clozeFeedbackEl.textContent = ""; clozeCorrectSentenceEl.textContent = ""; currentClozeWordData = null;
        const learnedKeys = Object.keys(learnedWordsData);
        if (learnedKeys.length === 0) { clozeQuestionTextEl.textContent = "請先學習一些單字才能進行填空練習。"; return; }
        const randomWordKey = learnedKeys[Math.floor(Math.random() * learnedKeys.length)];
        const wordData = wordList.find(w => w.korean === randomWordKey) || {};
        if (!wordData.korean_example || !wordData.chinese_example) {
            clozeQuestionTextEl.textContent = "未能找到含有例句的已學單字，請多學習一些單字或重試。";
            return;
        }
        currentClozeWordData = wordData;

        const exampleSentence = wordData.korean_example.split('\n')[0];
        const chineseExample = wordData.chinese_example.split('\n')[0];
        const clozeSentence = exampleSentence.replace(wordData.korean, "_____");

        clozeQuestionTextEl.textContent = clozeSentence;
        clozeHintTextEl.textContent = `提示 (中文): ${chineseExample}`;
        clozeCorrectSentenceEl.style.display = 'none';
    }
    function submitClozeAnswer() {
        const userAnswer = clozeAnswerInputEl.value.trim();
        if (!currentClozeWordData || !userAnswer) { clozeFeedbackEl.textContent = "請輸入答案。"; clozeFeedbackEl.style.color = "var(--warning-color)"; return; }
        if (userAnswer === currentClozeWordData.korean) { clozeFeedbackEl.textContent = "回答正確！🎉"; clozeFeedbackEl.style.color = "var(--primary-color)"; }
        else { clozeFeedbackEl.textContent = `回答錯誤。正確答案是: ${currentClozeWordData.korean}`; clozeFeedbackEl.style.color = "var(--danger-color)"; }
        if(currentClozeWordData.korean_example) clozeCorrectSentenceEl.textContent = `正確句子: ${currentClozeWordData.korean_example.split('\n')[0]}`;
        clozeCorrectSentenceEl.style.display = 'block';
    }

    function populateStoryWordSelect() {
        storyWordSelectEl.innerHTML = ""; const learnedKeys = Object.keys(learnedWordsData);
        if (learnedKeys.length < 2) { const opt = document.createElement('option'); opt.textContent = "請至少學習2個單字"; opt.disabled = true; storyWordSelectEl.appendChild(opt); return; }
        learnedKeys.forEach(key => { const opt = document.createElement('option'); opt.value = key; opt.textContent = `${key} (${learnedWordsData[key].chinese})`; storyWordSelectEl.appendChild(opt); });
    }
    async function generateAIStory() {
        const selectedOptions = Array.from(storyWordSelectEl.selectedOptions).map(opt => opt.value);
        if (selectedOptions.length < 2 || selectedOptions.length > 5) { alert("請選擇 2 到 5 個單字來創作故事。"); return; }
        storyKoTextEl.textContent = ""; storyZhTextEl.textContent = "";
        aiGeneratedStoryKoBox.classList.add('loading'); aiGeneratedStoryKoBox.style.display = 'block'; aiGeneratedStoryZhBox.style.display = 'none';
        const prompt = `請用以下韓語單字創作一個非常簡短 (2-4句話)、簡單且連貫的小故事，適合韓語初學者閱讀。單字列表: ${selectedOptions.join("、")}。\n請在故事後另起一行，用 "---中文翻譯---" 分隔後，提供該韓語故事的簡體中文翻譯。`;
        const storyResult = await callGeminiAPI([{text: prompt}], "story_generation", aiGeneratedStoryKoBox);
        if (storyResult && !aiGeneratedStoryKoBox.classList.contains('error')) {
            const parts = storyResult.split("---中文翻譯---");
            storyKoTextEl.textContent = parts[0] ? parts[0].trim() : "AI未能生成韓語故事。";
            if (parts[1]) { storyZhTextEl.textContent = parts[1].trim(); aiGeneratedStoryZhBox.style.display = 'block'; }
            else { storyZhTextEl.textContent = "AI未能生成中文翻譯。"; aiGeneratedStoryZhBox.style.display = 'block'; }
        } else if (!storyResult && !aiGeneratedStoryKoBox.classList.contains('error')) { storyKoTextEl.textContent = "AI故事創作失敗。"; }
    }

    async function generateAIScenario() {
        currentAIScenarioContext = []; aiScenarioDescriptionEl.textContent = "AI 構思情境中...";
        aiScenarioDialogueHistoryEl.innerHTML = ""; aiScenarioDialogueHistoryEl.style.display = 'none';
        userScenarioResponseEl.value = ""; aiScenarioFeedbackEl.textContent = ""; aiScenarioFeedbackEl.style.display = 'none';
        const selectedDifficulty = document.querySelector('input[name="scenario-difficulty"]:checked').value;
        const learnedWordKeys = Object.keys(learnedWordsData);
        const setupPrompt = `你是一個韓語學習助手，現在要為我創建一個韓語口語情景對話。
        對話難度級別為"${selectedDifficulty}"。
        請給我一個簡短的中文場景描述，以及你（作為AI角色）的第一句韓語台詞，並明確指出你扮演的角色。
        最後，給用戶一個用中文描述的任務提示，告訴他們需要如何開始回應。
        請確保你的韓語台詞的詞彙和語法複雜度符合"${selectedDifficulty}"水平。
        如果可能，可以在場景描述或任務提示中暗示使用一些已學詞彙（例如：${learnedWordKeys.slice(0, 3).join(", ") || "一些基礎詞彙"}）。

        嚴格按照以下格式輸出，並用 "---" 分隔：
        場景描述 (中文)
        ---
        AI角色: 韓語台詞
        ---
        用戶任務提示 (中文)`;

        const scenarioData = await callGeminiAPI([{ role: "user", parts: [{ text: setupPrompt }] }], "scenario_setup", aiScenarioDescriptionEl);

        if (scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) {
            const parts = scenarioData.split("---").map(p => p.trim());
            if (parts.length >= 3) {
                aiScenarioDescriptionEl.textContent = `情景 (${selectedDifficulty}): ${parts[0]}`;
                const aiFullLine = parts[1];
                const aiTextMatch = aiFullLine.match(/^(.*?):\s*(.*)$/);
                let aiRole = "AI";
                let aiDialogue = aiFullLine;

                if (aiTextMatch && aiTextMatch.length >= 3) {
                    aiRole = aiTextMatch[1].trim();
                    aiDialogue = aiTextMatch[2].trim();
                } else {
                    aiDialogue = aiFullLine;
                }

                currentAIScenarioContext.push({ role: "model", parts: [{ text: aiDialogue }] });
                updateScenarioDialogueHistory();
                aiScenarioDialogueHistoryEl.style.display = 'block';
                userScenarioResponseEl.placeholder = `你的任務: ${parts[2]}`;

            } else { aiScenarioDescriptionEl.textContent = "AI場景生成格式錯誤。請重試。"; }
        } else if (!scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) { aiScenarioDescriptionEl.textContent = "AI場景生成失敗。"; }
    }

    async function submitScenarioResponse() {
        const userResponse = userScenarioResponseEl.value.trim();
        if (!userResponse) {
            aiScenarioFeedbackEl.textContent = "請輸入您的回應。";
            aiScenarioFeedbackEl.style.color = "var(--warning-color)";
            aiScenarioFeedbackEl.style.display = 'block';
            return;
        }

        currentAIScenarioContext.push({ role: "user", parts: [{ text: userResponse }] });
        updateScenarioDialogueHistory();
        userScenarioResponseEl.value = "";

        aiScenarioFeedbackEl.textContent = "AI 思考回應中...";
        aiScenarioFeedbackEl.style.display = 'block';
        aiScenarioFeedbackEl.classList.remove('error', 'success');

        // Create the full prompt for the model to continue the conversation
        const fullPromptContents = [
            { role: "user", parts: [{ text: "你是一個韓語學習助手。我們正在進行情景對話練習。你的任務是評估用戶的韓語回應，然後以你的角色繼續對話。請嚴格遵守以下格式，先是中文反饋，然後用 '---反饋---' 分隔，最後是AI的韓語回應。如果對話可以自然結束，可以說一句韓語結束語（例如：고맙습니다. 다음에 또 만나요.）。如果用戶表達不清或任務未完成，可以嘗試引導或提問。" }] },
            ...currentAIScenarioContext
        ];

        const aiFullResponse = await callGeminiAPI(fullPromptContents, "scenario_continue");

        if (aiFullResponse) {
            const parts = aiFullResponse.split("---反饋---");
            const feedbackText = parts[0] ? parts[0].trim() : "AI 未提供明確反饋。";
            const aiNextKoreanUtterance = parts[1] ? parts[1].trim() : "음... 다시 한번 말씀해주시겠어요? (嗯...能再說一遍？)";

            aiScenarioFeedbackEl.textContent = `AI反饋: ${feedbackText}`;
            aiScenarioFeedbackEl.style.color = "var(--wechat-text-secondary)";

            currentAIScenarioContext.push({ role: "model", parts: [{ text: aiNextKoreanUtterance }] });
            updateScenarioDialogueHistory();

            if (aiNextKoreanUtterance.includes("감사합니다") || aiNextKoreanUtterance.includes("안녕히 가세요") || currentAIScenarioContext.length > 8) {
                aiScenarioFeedbackEl.textContent += "\n對話結束。";
            }
        } else {
            aiScenarioFeedbackEl.textContent = "AI回應生成失敗。";
            aiScenarioFeedbackEl.classList.add('error');
            // Revert the last user utterance if AI failed to respond
            currentAIScenarioContext.pop();
            updateScenarioDialogueHistory(); // Re-render to reflect the pop
        }
    }
    function updateScenarioDialogueHistory() {
        aiScenarioDialogueHistoryEl.innerHTML = currentAIScenarioContext.map(turn => {
            const speaker = turn.role === 'user' ? '您' : 'AI';
            const cssClass = turn.role === 'user' ? 'user-utterance' : 'ai-utterance';
            return `<p class="${cssClass}"><strong>${speaker}:</strong> ${turn.parts[0].text.replace(/\n/g, "<br>")}</p>`;
        }).join('');
        aiScenarioDialogueHistoryEl.scrollTop = aiScenarioDialogueHistoryEl.scrollHeight;
    }

    async function correctEssay() {
        const essayText = essayInputEl.value.trim();
        if (!essayText) {
            essayFeedbackAreaEl.textContent = "請輸入您要批改的韓語作文。";
            essayFeedbackAreaEl.classList.remove('loading', 'error');
            essayFeedbackAreaEl.style.display = 'block';
            return;
        }
        const prompt = `請作為一名資深的韓語老師，為以下韓語作文進行批改和評價。請提供：
        1. **整體評價** (Overall Assessment): 簡要評價作文的優點和不足。
        2. **語法修正與解釋** (Grammar Correction & Explanation): 列出具體的語法錯誤並提供正確版本，解釋為什麼是錯誤的。
        3. **詞彙用法建議** (Vocabulary Usage Suggestions): 針對不恰當的詞彙提供替換建議，或指出詞彙使用的亮點。
        4. **表達流暢度與自然度** (Fluency & Naturalness): 針對不自然的表達進行潤色。
        5. **TOPIK相關建議** (TOPIK-specific Advice): 如果有，提供針對TOPIK考試的寫作建議。
        6. **修訂後的作文** (Revised Essay): 提供一個完整的、修正後的韓語作文版本。
        請確保反饋詳細、有建設性，並且易於理解。
        作文內容:
        "${essayText}"`;

        const feedback = await callGeminiAPI([{text: prompt}], "essay_correction", essayFeedbackAreaEl);
        if (feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.innerHTML = feedback.replace(/\n/g, '<br>');
            essayFeedbackAreaEl.style.display = 'block';
        } else if (!feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.textContent = "AI批改作文失敗或未返回內容。";
            essayFeedbackAreaEl.style.display = 'block';
        }
    }

    async function generateMultipleChoiceQuestions() {
        const category = document.querySelector('input[name="mc-category"]:checked').value;
        const count = parseInt(mcCountInputEl.value, 10);

        if (count < 1 || count > 5) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">請輸入問題數量（1-5）。</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
            return;
        }

        mcQuestionsAreaEl.innerHTML = `<p style="text-align:center; color:var(--ai-accent-color); font-style:italic;">AI 正在生成題目...</p>`;
        submitMcAnswersBtnEl.style.display = 'none';
        currentMCQuestions = [];

        let prompt = "";
        if (category === "grammar") {
            prompt = `請生成 ${count} 道韓語語法選擇題，適合TOPIK初級或中級水平的學習者。
            每道題包括：
            1. 題目 (韓語句子，其中某個語法點被挖空或需要選擇正確形式)
            2. 四個選項 (A, B, C, D，韓語語法點或詞彙)
            3. 正確答案 (字母)
            4. 詳細的中文解釋 (為什麼正確，為什麼其他選項錯誤，可以擴展相關語法知識點)

            請嚴格按照以下格式輸出，每道題之間用 "---" 分隔，每個部分用 "&&&" 分隔：
            題目&&&A. 選項A&&&B. 選項B&&&C. 選項C&&&D. 選項D&&&正確答案: X&&&解釋: 中文解釋
            例如：
            저는 주말에 영화____ 볼 거예요.&&&A. -를&&&B. -은&&&C. -와&&&D. -이&&&正確答案: A&&&解釋: '영화'는 목적어로, '보다' 동사와 함께 쓰일 때 목적격 조사 '-를'이 붙습니다。
            ---
            [下一道題目]`;
        } else if (category === "proverb") {
            prompt = `請生成 ${count} 道韓語諺語/俗語選擇題，適合TOPIK中級或高級水平的學習者。
            每道題包括：
            1. 題目 (一個韓語諺語或俗語的挖空形式，或给出情境選擇諺語)
            2. 四個選項 (A, B, C, D，韓語諺語/俗語或其部分)
            3. 正確答案 (字母)
            4. 詳細的中文解釋 (諺語/俗語的字面意思和引申義，以及使用情境)

            請嚴格按照以下格式輸出，每道題之間用 "---" 分隔，每個部分用 "&&&" 分隔：
            題目&&&[挖空或情境]____&&&A. 選項A&&&B. 選項B&&&C. 選項C&&&D. 選項D&&&正確答案: X&&&解釋: 中文解釋
            例如：
            늦게 배운 도둑질이 ____ 날 새는 줄 모른다.&&&A. 밤&&&B. 낮&&&C. 아침&&&D. 저녁&&&正確答案: A&&&解釋: '늦게 배운 도둑질이 밤 새는 줄 모른다'는 늦게 시작한 일이 재미있어서 시간 가는 줄 모른다는 뜻입니다。
            ---
            [下一道題目]`;
        }


        const rawQuestions = await callGeminiAPI([{text: prompt}], "mc_generation", mcQuestionsAreaEl);

        if (rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            const questionBlocks = rawQuestions.split('---').filter(block => block.trim() !== '');
            let htmlContent = '';
            questionBlocks.forEach((block, index) => {
                const parts = block.split('&&&').map(p => p.trim());
                if (parts.length >= 6) {
                    const questionText = parts[0];
                    const options = parts.slice(1, 5);
                    const correctAnswerMatch = parts[5].match(/正確答案:\s*([A-D])/i);
                    const explanationText = parts[6] || '';

                    const correctAnswer = correctAnswerMatch ? correctAnswerMatch[1].toUpperCase() : '';

                    currentMCQuestions.push({
                        id: `q${index}`,
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        explanation: explanationText,
                        userAnswer: null
                    });

                    htmlContent += `<div class="mc-question" data-question-id="q${index}">
                        <p>${index + 1}. ${questionText}</p>
                        <div class="mc-options">`;
                    options.forEach((opt, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex);
                        htmlContent += `<label>
                            <input type="radio" name="question-${index}" value="${optionLetter}">
                            ${opt}
                        </label>`;
                    });
                    htmlContent += `</div>
                        <div class="mc-feedback" id="feedback-q${index}"></div>
                        <div class="mc-explanation" id="explanation-q${index}" style="display: none;">${explanationText}</div>
                    </div>`;
                }
            });

            if (currentMCQuestions.length > 0) {
                mcQuestionsAreaEl.innerHTML = htmlContent;
                submitMcAnswersBtnEl.style.display = 'block';
            } else {
                mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AI未能生成有效題目。請嘗試更改話題或數量。</p>`;
            }

        } else if (!rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AI題目生成失敗。</p>`;
        }
    }

    function submitMultipleChoiceAnswers() {
        let allCorrect = true;
        currentMCQuestions.forEach(q => {
            const selectedOption = document.querySelector(`input[name="question-${q.id.replace('q', '')}"]:checked`);
            const feedbackEl = document.getElementById(`feedback-${q.id}`);
            const explanationEl = document.getElementById(`explanation-${q.id}`);

            if (!selectedOption) {
                feedbackEl.textContent = "請選擇一個答案。";
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'none';
                return;
            }

            q.userAnswer = selectedOption.value;
            if (q.userAnswer === q.correctAnswer) {
                feedbackEl.textContent = "回答正確！🎉";
                feedbackEl.className = 'mc-feedback correct';
                explanationEl.style.display = 'block';
            } else {
                feedbackEl.textContent = `回答錯誤。正確答案是 ${q.correctAnswer}。`;
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'block';
            }
        });

        if (currentMCQuestions.length > 0 && allCorrect) {
            alert("恭喜！所有題目都答對了！");
        }
    }

    function setActivePage(pageId, title) {
        contentPages.forEach(page => page.classList.toggle('active', page.id === pageId));
        tabItems.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
        appHeaderTitleEl.textContent = title;
        document.querySelector('.wechat-content').scrollTop = 0;

        if (pageId === 'page-ai-functions') {
            showAIFunctionsMenu();
        } else {
            pageAiFunctionsEl.classList.remove('menu-active', 'sub-feature-active');
            aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        }

        if (pageId === 'page-settings') {
             showSettingsMainMenu();
        } else {
            pageStudyGoalsEl.classList.remove('active');
        }


        if (pageId === 'page-review-plan') {
            renderReviewList('all');
            updateActiveFilterButton('all');
        } else if (pageId === 'page-memorize') {
            loadWordForMemorizePage(true); // Always force reload current word when navigating to memorize page
        } else if (pageId === 'page-study-goals') {
            renderCalendar();
        }
        if (pageId !== 'page-about') {
            pageAboutEl.classList.remove('active');
        }
    }

    function showAIFunctionSubFeature(featureId, title) {
        pageAiFunctionsEl.classList.remove('menu-active');
        pageAiFunctionsEl.classList.add('sub-feature-active');

        aiSubFeatureSections.forEach(section => {
            section.classList.toggle('active', section.id === featureId);
        });
        appHeaderTitleEl.textContent = title;

        if (featureId === 'feature-cloze') {
            generateAIClozeTest();
        } else if (featureId === 'feature-story') {
            populateStoryWordSelect();
        } else if (featureId === 'feature-scenario') {
            aiScenarioDescriptionEl.textContent = "點擊下方按鈕生成對話情境。";
            aiScenarioDialogueHistoryEl.innerHTML = "";
            aiScenarioDialogueHistoryEl.style.display = 'none';
            userScenarioResponseEl.value = "";
            aiScenarioFeedbackEl.textContent = "";
            aiScenarioFeedbackEl.style.display = 'none';
            currentAIScenarioContext = [];
        } else if (featureId === 'feature-essay-correction') {
             essayInputEl.value = "";
             essayFeedbackAreaEl.style.display = 'none';
        } else if (featureId === 'feature-mc-questions') {
            mcQuestionsAreaEl.innerHTML = `<p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">點擊上方按鈕生成題目。</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
        } else if (featureId === 'page-image-recognition') {
            imagePreviewRecEl.src = '';
            imagePreviewRecEl.style.display = 'none';
            recognizeImageKoreanBtnEl.disabled = true;
            imageRecognizedKoTextEl.parentElement.style.display = 'none';
            imageRecognizedZhTextEl.parentElement.style.display = 'none';
            imageUploadInputRecEl.value = '';
        } else if (featureId === 'page-local-video') {
            videoPlayerEl.src = '';
            videoPlayerEl.style.display = 'none';
            videoFileNameDisplayEl.textContent = '未選擇文件';
            videoUploadInputEl.value = '';
        }
    }

    function showAIFunctionsMenu() {
        pageAiFunctionsEl.classList.add('menu-active');
        pageAiFunctionsEl.classList.remove('sub-feature-active');
        aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        appHeaderTitleEl.textContent = "AI 功能";
    }

    function showSettingsMainMenu() {
        document.getElementById('page-settings').classList.add('active');
        document.getElementById('page-settings').classList.remove('sub-page-active');
        pageStudyGoalsEl.classList.remove('active');
        appHeaderTitleEl.textContent = "我";
    }

    function showStudyGoalsPage() {
        document.getElementById('page-settings').classList.remove('active');
        pageStudyGoalsEl.classList.add('active');
        appHeaderTitleEl.textContent = "學習目標";
        renderCalendar();
    }

    function switchWordList(listName) {
        if (currentWordListName === listName) return;

        currentWordListName = listName;
        wordList = allWordLists[currentWordListName];
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);

        loadLearnedWords();

        currentWordIndex = 0;
        loadWordForMemorizePage(true); // Force reload to start from beginning of new list
        if (isCardFlipped) flipCard(false);

        if (document.getElementById('page-review-plan').classList.contains('active')) {
            renderReviewList(currentReviewFilter);
        }
        alert(`已切換到“${wordListSelectEl.options[wordListSelectEl.selectedIndex].text}”字庫！`);
    }


    function loadWord(wordIndexInList = null, fromReview = false, shouldSpeak = false) {
        let wordToLoad = null;

        if (fromReview && wordIndexInList !== null) {
            currentWordIndex = wordIndexInList;
            wordToLoad = wordList[currentWordIndex];
        } else {
            const now = Date.now();
            const dueWords = Object.values(learnedWordsData).filter(word => word.nextReviewDue <= now);
            const newWords = wordList.filter(word => !learnedWordsData[word.korean]);

            if (dueWords.length > 0) {
                dueWords.sort((a, b) => a.nextReviewDue - b.nextReviewDue);
                wordToLoad = wordList.find(w => w.korean === dueWords[0].korean);
                currentWordIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            } else if (dailyNewWordsLearnedToday < dailyNewWordsLimit && newWords.length > 0) {
                wordToLoad = newWords[0];
                currentWordIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            } else {
                // If no due words and no new words to learn, cycle through all words
                if (wordList.length > 0) {
                    currentWordIndex = (currentWordIndex + 1) % wordList.length;
                    wordToLoad = wordList[currentWordIndex];
                }
            }
        }

        if (!wordToLoad) {
            koreanWordEl.textContent = "暫無單字可學/復習。";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = wordList.length;
            return;
        }

        koreanWordEl.textContent = wordToLoad.korean;
        pronunciationEl.textContent = wordToLoad.pronunciation || "";
        chineseTranslationEl.textContent = wordToLoad.chinese;
        if (wordToLoad.korean_example && wordToLoad.chinese_example) {
            koreanExampleEl.innerHTML = `🇰🇷 ${wordToLoad.korean_example.replace(/\n/g, '<br>')}`;
            chineseExampleEl.innerHTML = `🇨🇳 ${wordToLoad.chinese_example.replace(/\n/g, '<br>')}`;
            exampleSentenceEl.style.display = 'block';
        } else {
            exampleSentenceEl.style.display = 'none';
        }
        if (isCardFlipped) flipCard(false); // Always flip to front when loading new word
        aiHelperBoxEl.style.display = 'none'; aiHelperContentEl.textContent = "點擊下方 \"AI提示\" 獲取。";
        aiSentenceGeneratorBoxEl.style.display = 'none'; aiGeneratedSentencesEl.innerHTML = "";
        aiUsageNotesBoxEl.style.display = 'none'; aiUsageNotesContentEl.textContent = "";

        updateProgress();
        if (shouldSpeak && autoPronounceNextCheckbox && autoPronounceNextCheckbox.checked) {
            setTimeout(() => speakKoreanWord(), 100);
        }
    }

    function flipCard(forceState = null) { if (!wordCardEl) return; isCardFlipped = (forceState !== null) ? forceState : !isCardFlipped; wordCardEl.classList.toggle('is-flipped', isCardFlipped); }
    function speakKoreanWord(event) {
        if (event) event.stopPropagation();
        if (!synth || !wordList[currentWordIndex]) return;
        if (synth.speaking) synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(wordList[currentWordIndex].korean);
        let koreanVoice = synth.getVoices().find(v => v.lang === 'ko-KR' || v.lang.startsWith('ko'));
        if (koreanVoice) utterThis.voice = koreanVoice; else utterThis.lang = 'ko-KR';
        utterThis.rate = 0.9;
        utterThis.pitch = 1;
        synth.speak(utterThis);
    }
    function nextWord() {
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex + 1) % wordList.length;
        loadWord(currentWordIndex, false, true); // Pass true to shouldSpeak
    }
    function prevWord() {
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex - 1 + wordList.length) % wordList.length;
        loadWord(currentWordIndex, false, true); // Pass true to shouldSpeak
    }

    function calculateNextReviewTimestamp(reviewCount, lastSeenTimestamp) {
        const now = Date.now();
        lastSeenTimestamp = lastSeenTimestamp || now;

        let intervalDays;
        if (reviewCount === 0) {
            intervalDays = 0;
        } else if (reviewCount === 1) {
            intervalDays = srsIntervals[0];
        } else if (reviewCount <= srsIntervals.length) {
            intervalDays = srsIntervals[reviewCount - 1];
        } else {
            intervalDays = srsIntervals[srsIntervals.length - 1] * Math.pow(1.8, (reviewCount - srsIntervals.length));
        }
        return lastSeenTimestamp + (intervalDays * 24 * 60 * 60 * 1000);
    }

    function markAsKnown() {
        if (!wordList[currentWordIndex]) return;
        const wordKey = wordList[currentWordIndex].korean;
        const currentTimestamp = Date.now();

        let wordEntry = learnedWordsData[wordKey];
        const isNewWord = !wordEntry;

        if (isNewWord) {
            wordEntry = {
                korean: wordList[currentWordIndex].korean,
                chinese: wordList[currentWordIndex].chinese,
                pronunciation: wordList[currentWordIndex].pronunciation,
                firstLearned: currentTimestamp,
                lastSeen: currentTimestamp,
                reviewCount: 1,
            };
            dailyNewWordsLearnedToday++; // 這裡應該在 checkDailyStudyGoal 中根據實際判斷是否為新詞而增加
        } else {
            wordEntry.reviewCount = (wordEntry.reviewCount || 0) + 1;
            wordEntry.lastSeen = currentTimestamp;
        }
        wordEntry.nextReviewDue = calculateNextReviewTimestamp(wordEntry.reviewCount, wordEntry.lastSeen);
        learnedWordsData[wordKey] = wordEntry;
        saveLearnedWords();

        console.log(`已標記: ${wordKey}, 次數: ${wordEntry.reviewCount}, 下次: ${new Date(wordEntry.nextReviewDue).toLocaleDateString()}, 今日新詞: ${dailyNewWordsLearnedToday}/${dailyNewWordsLimit}`);

        checkDailyStudyGoal(); // 在標記為已認識後檢查學習目標
        loadWordForMemorizePage(true); // Force reload and also trigger speak logic
    }

    function updateProgress() {
        if (!wordList || wordList.length === 0 || !progressBarEl || !currentWordIndexEl || !totalWordsEl) return;
        const percentage = ((currentWordIndex + 1) / wordList.length) * 100;
        progressBarEl.style.width = percentage + '%';
        currentWordIndexEl.textContent = currentWordIndex + 1;
        totalWordsEl.textContent = wordList.length;
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function jumpToWordForReview(wordKey) {
        const wordIndexInList = wordList.findIndex(w => w.korean === wordKey);
        if (wordIndexInList !== -1) {
            setActivePage('page-memorize', '背單字');
            currentWordIndex = wordIndexInList;
            loadWord(currentWordIndex, true, true); // Force reload and speak
        } else {
            alert(`單字 "${wordKey}" 在目前字庫中未找到。`);
        }
    }

    let currentReviewFilter = 'all';
    function renderReviewList(filter = 'all') {
        currentReviewFilter = filter;
        if (!reviewListContainerEl || !learnedWordsData) return;
        reviewListContainerEl.innerHTML = '';

        const now = Date.now();
        let wordsToReview = Object.values(learnedWordsData);

        let dueCount = 0;
        wordsToReview.forEach(word => {
            if (word.nextReviewDue <= now) dueCount++;
        });
        if (totalLearnedCountEl) totalLearnedCountEl.textContent = Object.keys(learnedWordsData).length;
        if (dueTodayCountEl) dueTodayCountEl.textContent = dueCount;


        if (filter === 'due') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue <= now);
        } else if (filter === 'overdue') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue < (now - 24 * 60 * 60 * 1000));
        }

        wordsToReview.sort((a, b) => (a.nextReviewDue || 0) - (b.nextReviewDue || 0));

        if (wordsToReview.length === 0) {
            reviewListContainerEl.innerHTML = `<p class="no-reviews">${filter === 'all' ? '暫無學習記錄。' : '目前篩選條件下沒有需要復習的單字。'}</p>`;
            return;
        }

        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.paddingLeft = '0';

        wordsToReview.forEach(word => {
            const li = document.createElement('li');
            li.className = 'review-list-item';
            li.dataset.wordKey = word.korean;

            const wordInfoDiv = document.createElement('div');
            wordInfoDiv.className = 'review-word-info';
            wordInfoDiv.innerHTML = `<div class="word">${word.korean}</div><div class="meaning">${word.chinese || 'N/A'}</div>`;

            const reviewStatusDiv = document.createElement('div');
            reviewStatusDiv.className = 'review-status';
            let nextReviewText = formatDate(word.nextReviewDue);
            let statusClass = '';
            if (word.nextReviewDue <= now) {
                statusClass = 'overdue';
                nextReviewText = "立即復習";
            } else if (word.nextReviewDue <= now + 2 * 24 * 60 * 60 * 1000) {
                statusClass = 'due-soon';
            }

            reviewStatusDiv.innerHTML = `<div class="next-review">下次復習: <span class="date ${statusClass}">${nextReviewText}</span></div><div style="font-size:0.75em; color: #aaa;">上次: ${formatDate(word.lastSeen)} (次數: ${word.reviewCount || 0})</div>`;

            li.appendChild(wordInfoDiv);
            li.appendChild(reviewStatusDiv);
            ul.appendChild(li);
        });
        reviewListContainerEl.appendChild(ul);
    }

    function updateActiveFilterButton(activeFilter) { filterButtonsReview.forEach(button => button.classList.toggle('active', button.id === `filter-${activeFilter}`)); }

    function showAboutPage() {
        setActivePage('page-about', '關於本應用');
    }

    function initializeApp() {
        currentUsernameDisplayEl.textContent = localStorage.getItem('lastLoggedInUser') || "學習者";

        loadLearnedWords();
        applySavedSettings();

        if (dailyStudyAmountInput) {
            dailyStudyAmountInput.addEventListener('change', (e) => {
                let value = parseInt(e.target.value, 10);
                if (isNaN(value) || value < 1) value = 1;
                if (value > 50) value = 50;
                dailyNewWordsLimit = value;
                localStorage.setItem('dailyNewWordsLimit', dailyNewWordsLimit);
                e.target.value = dailyNewWordsLimit;
                checkDailyStudyGoal(); // 更新目標後檢查是否已達成
            });
        }

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            console.warn("警告: Gemini API 金鑰無效或未在 JavaScript 中正確設定。AI 功能將受限。");
            const aiButtons = document.querySelectorAll('.ai-btn, .generic-button, .ai-action-btn');
            aiButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = 0.5; btn.title = "API Key 未設定或無效"; btn.style.cursor = "not-allowed"; });

            const aiSections = [
                document.getElementById('page-translate'),
                document.getElementById('page-ai-dictionary'),
                document.getElementById('page-image-recognition'),
                document.getElementById('feature-cloze'),
                document.getElementById('feature-story'),
                document.getElementById('feature-scenario'),
                document.getElementById('feature-essay-correction'),
                document.getElementById('feature-mc-questions')
            ];

            aiSections.forEach(section => {
                if (section && !section.querySelector('.api-error-message')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'var(--danger-color)';
                    errorDiv.style.fontWeight = 'bold';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.marginBottom = '10px';
                    errorDiv.className = 'api-error-message';
                    errorDiv.textContent = '🚫 AI 功能受限：Gemini API 密鑰無效或未設置。';
                    section.querySelector('.section-container')?.prepend(errorDiv) || section.prepend(errorDiv);
                }
            });
        }

        loadWordForMemorizePage(true); // Initial load with speak enabled

        if(wordCardEl) {
            wordCardEl.addEventListener('click', (event) => {
                if (event.target.closest('.pronounce-btn') || event.target.closest('.ai-btn') || event.target.tagName === 'A') return;
                flipCard();
            });
        }

        if(pronounceBtnEl) {
            pronounceBtnEl.addEventListener('click', speakKoreanWord);
        }

        document.getElementById('prev-word-btn').addEventListener('click', prevWord);
        document.getElementById('next-word-btn').addEventListener('click', nextWord);
        document.getElementById('mark-known-btn').addEventListener('click', markAsKnown);

        document.getElementById('ai-tip-btn').addEventListener('click', getAITipForWord);
        document.getElementById('ai-sentence-btn').addEventListener('click', getAISentencesForWord);
        document.getElementById('ai-usage-btn').addEventListener('click', getAIUsageNotesForWord);

        if(reviewListContainerEl) {
            reviewListContainerEl.addEventListener('click', (event) => {
                const listItem = event.target.closest('.review-list-item');
                if (listItem && listItem.dataset.wordKey) {
                    jumpToWordForReview(listItem.dataset.wordKey);
                }
            });
        }

        if(doTranslateAutoBtnEl){ doTranslateAutoBtnEl.addEventListener('click', translateAutoDetect); }
        if(searchDictionaryBtnEl){
            searchDictionaryBtnEl.addEventListener('click', searchAIDictionary);
            koreanWordInputEl.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchAIDictionary(); });
        }
        if(imageUploadInputRecEl){
            imageUploadInputRecEl.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 4 * 1024 * 1024) { alert("圖片文件過大，請選擇小於 4MB 的圖片。"); imageUploadInputRecEl.value = ""; return; }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreviewRecEl.src = e.target.result; imagePreviewRecEl.style.display = 'block';
                        uploadedImageBase64Rec = e.target.result.split(',')[1]; uploadedImageMimeTypeRec = file.type;
                        recognizeImageKoreanBtnEl.disabled = false;
                        imageRecognizedKoTextEl.parentElement.style.display = 'none';
                        imageRecognizedZhTextEl.parentElement.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        if(recognizeImageKoreanBtnEl) { recognizeImageKoreanBtnEl.addEventListener('click', generateImageRecognition); }
        if (videoUploadInputEl) { videoUploadInputEl.addEventListener('change', handleVideoUpload); }
        if(generateClozeBtnEl){ generateClozeBtnEl.addEventListener('click', generateAIClozeTest); }
        if(submitClozeBtnEl){ submitClozeBtnEl.addEventListener('click', submitClozeAnswer); }
        if(generateStoryBtnEl){ generateStoryBtnEl.addEventListener('click', generateAIStory); }
        if(generateScenarioBtnEl){ generateScenarioBtnEl.addEventListener('click', generateAIScenario); }
        if(submitScenarioResponseBtnEl){ submitScenarioResponseBtnEl.addEventListener('click', submitScenarioResponse); }
        if(correctEssayBtnEl) { correctEssayBtnEl.addEventListener('click', correctEssay); }
        if(generateMcBtnEl) { generateMcBtnEl.addEventListener('click', generateMultipleChoiceQuestions); }
        if(submitMcAnswersBtnEl) { submitMcAnswersBtnEl.addEventListener('click', submitMultipleChoiceAnswers); }


        filterButtonsReview.forEach(button => {
            button.addEventListener('click', () => { const filterType = button.id.replace('filter-', ''); renderReviewList(filterType); updateActiveFilterButton(filterType); });
        });
        tabItems.forEach(tab => {
            tab.addEventListener('click', () => {
                setActivePage(tab.dataset.page, tab.dataset.title);
            });
        });
        aiFunctionMenuBtns.forEach(button => {
            button.addEventListener('click', () => showAIFunctionSubFeature(button.dataset.subFeatureId, button.dataset.title));
        });

        if(darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleDarkMode);
        }
        colorOptions.forEach(option => {
            option.addEventListener('click', () => selectThemeColor(option.dataset.color));
        });

        const aboutButton = document.querySelector('#page-settings .about-section .about-button');
        if (aboutButton) {
            aboutButton.addEventListener('click', showAboutPage);
        }

        if(learningGoalsMenuItem) {
            learningGoalsMenuItem.addEventListener('click', showStudyGoalsPage);
        }

        if (wordListSelectEl) {
            wordListSelectEl.addEventListener('change', (event) => {
                switchWordList(event.target.value);
            });
        }

        setActivePage('page-memorize', '背單字');
        console.log("韓語學習助手 (AI高級定制版) 已初始化。");

        // 開屏動畫邏輯
        setTimeout(() => {
            splashScreen.classList.add('hidden');
        }, 3000); // 3 秒後隱藏開屏動畫

        // 關閉恭喜彈窗按鈕
        closeCongratsModalButton.addEventListener('click', hideCongratulationsModal);
    }

    function loadWordForMemorizePage(initialLoadOrMarkKnown = false) {
        const now = Date.now();
        const dueWords = Object.values(learnedWordsData).filter(word => word.nextReviewDue <= now);
        const newWordsNotLearned = wordList.filter(word => !learnedWordsData[word.korean]);

        let wordToLoad = null;

        if (dueWords.length > 0) {
            dueWords.sort((a, b) => a.nextReviewDue - b.nextReviewDue);
            wordToLoad = wordList.find(w => w.korean === dueWords[0].korean);
            currentWordIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
        } else if (dailyNewWordsLearnedToday < dailyNewWordsLimit && newWordsNotLearned.length > 0) {
            wordToLoad = newWordsNotLearned[0];
            currentWordIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
        } else {
            // If no due words and no new words to learn, cycle through all words
            // If it's an initial load or after marking a word known, try to load current or next available.
            if (wordList.length > 0) {
                if (initialLoadOrMarkKnown) {
                     // On initial load or after marking known, ensure we either stay on the current or move to next if current is no longer relevant
                     wordToLoad = wordList[currentWordIndex];
                     if (!wordToLoad) { // Fallback if currentWordIndex is somehow out of bounds
                         currentWordIndex = 0;
                         wordToLoad = wordList[0];
                     }
                } else {
                    currentWordIndex = (currentWordIndex + 1) % wordList.length;
                    wordToLoad = wordList[currentWordIndex];
                }
            }
        }

        if (wordToLoad) {
            currentWordIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            // Ensure we load the word and potentially speak it based on settings
            loadWord(currentWordIndex, true, true); // Pass true to shouldSpeak
        } else {
            koreanWordEl.textContent = "暫無單字可學/復習。";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = wordList.length;
        }
    }

    if (synth && synth.getVoices().length === 0) {
        synth.onvoiceschanged = () => { console.log("語音合成聲音已載入。"); };
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>