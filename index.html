<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éŸ©è¯­å­¦ä¹ åŠ©æ‰‹ (AIé«˜çº§å®šåˆ¶ç‰ˆ)</title>
    <style>
        :root {
            --wechat-bg-gray: #f0f2f5;
            --wechat-header-bg: #f7f7f7;
            --wechat-header-text: #1f1f1f;
            --wechat-tabbar-bg: #fdfdfd;
            --wechat-tab-text: #7a7a7a;
            --wechat-tab-text-active: #07c160;
            --wechat-border-color: #e1e1e1;
            --wechat-list-item-bg: #ffffff;
            --wechat-button-primary: #07c160;
            --wechat-text-primary: #333333;
            --wechat-text-secondary: #666666;
            --wechat-input-bg: #ffffff;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --ai-accent-color: #1677ff;
            --card-background: #ffffff;
            --primary-color: #07c160;
            --text-color: #2c3e50;
            --shadow-color: rgba(0, 0, 0, 0.06);
            --font-system: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", sans-serif;
        }

        body[data-theme="dark"] {
            --wechat-bg-gray: #1a1a1a;
            --wechat-header-bg: #2a2a2a;
            --wechat-header-text: #e0e0e0;
            --wechat-tabbar-bg: #2a2a2a;
            --wechat-tab-text: #b0b0b0;
            --wechat-border-color: #444444;
            --wechat-list-item-bg: #333333;
            --wechat-button-primary: var(--primary-color);
            --wechat-text-primary: #e0e0e0;
            --wechat-text-secondary: #aaaaaa;
            --wechat-input-bg: #444444;
            --card-background: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body[data-color-theme="red"] {
            --primary-color: #FF4136;
            --wechat-tab-text-active: #FF4136;
            --ai-accent-color: #FF4136;
        }
        body[data-color-theme="orange"] {
            --primary-color: #FF851B;
            --wechat-tab-text-active: #FF851B;
            --ai-accent-color: #FF851B;
        }
        body[data-color-theme="yellow"] {
            --primary-color: #FFDC00;
            --wechat-tab-text-active: #FFDC00;
            --ai-accent-color: #FFDC00;
        }
        body[data-color-theme="green"] {
            --primary-color: #07c160;
            --wechat-tab-text-active: #07c160;
            --ai-accent-color: #07c160;
        }
        body[data-color-theme="cyan"] {
            --primary-color: #00B8D4;
            --wechat-tab-text-active: #00B8D4;
            --ai-accent-color: #00B8D4;
        }
        body[data-color-theme="blue"] {
            --primary-color: #0074D9;
            --wechat-tab-text-active: #0074D9;
            --ai-accent-color: #0074D9;
        }
        body[data-color-theme="purple"] {
            --primary-color: #B10DC9;
            --wechat-tab-text-active: #B10DC9;
            --ai-accent-color: #B10DC9;
        }


        body {
            font-family: var(--font-system); margin: 0; padding: 0; background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary); display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; position: relative; font-size: 14px;
        }

        .app-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .wechat-header { background-color: var(--wechat-header-bg); border-bottom: 1px solid var(--wechat-border-color); padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-sizing: border-box; }
        .wechat-header-title { font-size: 17px; font-weight: 600; color: var(--wechat-header-text); }
        .wechat-content { flex-grow: 1; overflow-y: auto; padding: 15px; padding-top: 65px; padding-bottom: 70px; background-color: var(--wechat-bg-gray); }
        .content-page { display: none; animation: fadeInPage 0.3s ease-in-out; }
        .content-page.active { display: block; }
        @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        .wechat-tabbar { background-color: var(--wechat-tabbar-bg); border-top: 1px solid var(--wechat-border-color); height: 55px; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--wechat-tab-text); font-size: 10px; cursor: pointer; flex-grow: 1; text-align: center; padding: 5px 0; }
        .tab-item-icon { font-size: 22px; margin-bottom: 3px; }
        .tab-item.active .tab-item-icon, .tab-item.active .tab-item-label { color: var(--wechat-tab-text-active); }

        button.ai-action-btn, .generic-button { background-color: var(--ai-accent-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 5px; margin-right: 5px; transition: background-color 0.2s; }
        button.ai-action-btn:hover, .generic-button:hover { background-color: var(--primary-color); }
        button.ai-action-btn:disabled, .generic-button:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7;}
        input[type="text"], textarea, select {
            width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color);
            border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: var(--font-system);
            box-sizing: border-box; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="radio"], input[type="checkbox"] {
            accent-color: var(--primary-color);
        }
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #5a6268;
        }


        #page-memorize .status {font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px; text-align: center;}
        #page-memorize .progress-bar-container {width: 100%; background-color: #e0e0e0; border-radius: 25px; margin-bottom: 20px; height: 8px; overflow: hidden;}
        body[data-theme="dark"] #page-memorize .progress-bar-container { background-color: #555;}
        #page-memorize .progress-bar {width: 0%; height: 100%; background: var(--primary-color); border-radius: 25px; transition: width 0.4s ease-in-out;}
        #page-memorize .word-card-container {width: 100%; perspective: 1000px; margin-bottom: 20px;}
        #page-memorize .word-card {min-height: 250px; width: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); background-color: var(--card-background); border-radius: 12px; box-shadow: 0 3px 10px var(--shadow-color);}
        #page-memorize .word-card.is-flipped {transform: rotateY(180deg);}
        #page-memorize .card-face {position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; border-radius: 12px;}
        #page-memorize .card-face-back {transform: rotateY(180deg); justify-content: flex-start; padding-top: 15px; overflow-y: auto;}
        #page-memorize .korean-word-container {display: flex; align-items: center; margin-bottom: 8px;}
        #page-memorize .korean-word {font-family: 'Noto Sans KR', var(--font-system); font-size: 2.2em; font-weight: 500; color: var(--text-color); margin-right: 8px; line-height: 1.3;}
        #page-memorize .pronounce-btn {background: none; border: none; font-size: 1.6em; cursor: pointer; color: var(--primary-color); padding: 0 5px;}
        #page-memorize .pronunciation {font-size: 1em; color: var(--wechat-text-secondary); margin-bottom: 15px; font-style: italic;}
        #page-memorize .hint-to-flip {font-size: 0.8em; color: var(--wechat-text-secondary); position: absolute; bottom: 10px;}
        #page-memorize .translation {font-size: 1.4em; font-weight: 500; margin-bottom: 10px;}
        #page-memorize .chinese-translation {color: var(--primary-color);}
        #page-memorize .example-sentence {font-size: 0.95em; text-align: left; width: 100%; margin-top: 5px;}
        #page-memorize .korean-example, #page-memorize .chinese-example {font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 4px; line-height: 1.5;}
        #page-memorize .korean-example {font-family: 'Noto Sans KR', var(--font-system); color: #555;}
        body[data-theme="dark"] #page-memorize .korean-example { color: #ccc;}
        #page-memorize .ai-word-expansion-area {width: 100%; margin-top: 10px;}
        #page-memorize .ai-helper-container, #page-memorize .ai-sentence-generator-container, #page-memorize .ai-usage-notes-container {margin-top: 8px; padding: 8px; background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; font-size: 0.85em; display: none;}
        body[data-theme="dark"] #page-memorize .ai-helper-container, body[data-theme="dark"] #page-memorize .ai-sentence-generator-container, body[data-theme="dark"] #page-memorize .ai-usage-notes-container { background-color: #213d54; border-color: #3b6d91;}
        #page-memorize .ai-helper-title, #page-memorize .ai-sentence-generator-title, #page-memorize .ai-usage-notes-title {font-weight: 500; color: var(--ai-accent-color); margin-bottom: 5px;}
        #page-memorize .ai-helper-content, #page-memorize .ai-generated-sentences, #page-memorize .ai-usage-notes-content {white-space: pre-wrap; color: var(--wechat-text-primary); line-height: 1.4;}
        #page-memorize .ai-generated-sentences ul {padding-left: 15px; margin: 5px 0;}
        #page-memorize .ai-generated-sentences li {margin-bottom: 5px;}
        #page-memorize .controls {display: grid; grid-template-columns: 1fr 1.6fr 1fr; gap: 8px; width: 100%; margin-bottom: 8px;}
        #page-memorize .controls.secondary-controls {grid-template-columns: 1fr 1fr;}
        #page-memorize .controls.tertiary-controls { grid-template-columns: 1fr 1fr; margin-top: 5px; }
        #page-memorize .controls button {background-color: var(--card-background); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 8px; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease;}
        body[data-theme="dark"] #page-memorize .controls button { background-color: #2b2b2b;}
        #page-memorize .controls button:hover {background-color: #f0f0f0; transform: translateY(-1px);}
        body[data-theme="dark"] #page-memorize .controls button:hover {background-color: #444;}
        #page-memorize .controls button:active {transform: translateY(0px);}
        #page-memorize .controls button#show-translation-btn {background-color: var(--primary-color); color: white;}
        #page-memorize .controls button.ai-btn {background-color: var(--ai-accent-color); color: white; border-color: var(--ai-accent-color); font-size: 0.9em; padding: 10px 5px;}


        #page-review-plan .review-summary {background-color: var(--wechat-list-item-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px var(--shadow-color); text-align: center;}
        #page-review-plan .review-summary p {margin: 5px 0; font-size: 0.95em;}
        #page-review-plan .review-summary .count {font-weight: bold; color: var(--primary-color);}
        #page-review-plan .review-list-item {background-color: var(--wechat-list-item-bg); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px var(--shadow-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s;}
        #page-review-plan .review-list-item:hover {background-color: #f9f9f9;}
        body[data-theme="dark"] #page-review-plan .review-list-item:hover {background-color: #444;}
        #page-review-plan .review-word-info .word {font-size: 1.1em; font-weight: 500; color: var(--text-color);}
        #page-review-plan .review-word-info .meaning {font-size: 0.9em; color: var(--wechat-text-secondary);}
        #page-review-plan .review-status .next-review {font-size: 0.8em; text-align: right;}
        #page-review-plan .review-status .next-review .date {font-weight: bold;}
        #page-review-plan .review-status .next-review .overdue {color: var(--danger-color);}
        #page-review-plan .review-status .next-review .due-soon {color: var(--warning-color);}
        #page-review-plan .no-reviews {text-align: center; color: var(--wechat-text-secondary); margin-top: 30px;}
        #page-review-plan .filter-buttons {margin-bottom: 15px; text-align: center;}
        #page-review-plan .filter-buttons button {padding: 6px 12px; margin: 0 5px; border-radius: 15px; border: 1px solid var(--wechat-border-color); background-color: var(--wechat-list-item-bg); color: var(--wechat-text-secondary); cursor: pointer; font-size:0.85em;}
        body[data-theme="dark"] #page-review-plan .filter-buttons button { background-color: #2b2b2b; }
        #page-review-plan .filter-buttons button.active {background-color: var(--primary-color); color: white; border-color: var(--primary-color);}


        #page-ai-functions .ai-function-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #page-ai-functions.menu-active .ai-function-menu { display: flex; }
        #page-ai-functions.sub-feature-active .ai-function-menu { display: none; }

        #page-ai-functions .ai-function-menu-item {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.1em;
            color: var(--wechat-text-primary);
        }
        #page-ai-functions .ai-function-menu-item:hover {
            background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-ai-functions .ai-function-menu-item:hover {
            background-color: #444;
        }
        #page-ai-functions .ai-sub-feature-section {
            display: none;
        }
        #page-ai-functions.sub-feature-active .ai-sub-feature-section.active {
            display: block;
            background-color: var(--wechat-bg-gray);
            padding: 0;
            box-shadow: none;
        }
        .ai-sub-feature-section .section-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
         .ai-sub-feature-section .section-container:last-child {
            margin-bottom: 0;
        }


        #page-image-recognition #image-preview-container-rec { margin-bottom: 10px; text-align: center; }
        #page-image-recognition #image-preview-rec { max-width: 100%; max-height: 180px; border: 1px solid var(--wechat-border-color); border-radius: 6px; display: none; margin: 0 auto; }
        #page-image-recognition #image-upload-label-rec { display: inline-block; padding: 8px 12px; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-size: 0.9em; }
        #page-image-recognition #image-upload-rec { display: none; }
        #page-image-recognition .recognition-output-section { margin-top: 10px; }
        #page-image-recognition .recognition-output-section h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-cloze .cloze-question { margin-bottom: 10px; font-size: 1.1em; }
        #feature-cloze .cloze-hint { font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px;}
        #feature-cloze #cloze-answer-input { width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }
        #feature-cloze #cloze-feedback { font-weight: bold; min-height: 20px; margin-top: 5px; }
        #feature-cloze #cloze-correct-sentence { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px; }

        #feature-story .story-weaver-controls { margin-bottom: 10px; }
        #feature-story .story-weaver-controls label { font-size: 0.9em; margin-right: 5px;}
        #feature-story #story-word-select { width: 100%; min-height: 60px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 0.9em; margin-bottom: 10px; }
        #feature-story #story-word-select option { padding: 3px; }
        #feature-story #ai-generated-story-ko, #feature-story #ai-generated-story-zh { margin-top: 5px; }
        #feature-story #ai-generated-story-ko h5, #feature-story #ai-generated-story-zh h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-scenario .scenario-difficulty-selector {
            margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;
        }
        body[data-theme="dark"] #feature-scenario .scenario-difficulty-selector { background-color: #2b2b2b;}
        #feature-scenario .scenario-difficulty-selector label { font-size: 0.9em; margin-right: 5px; }
        #feature-scenario .scenario-difficulty-selector input[type="radio"] { margin-right: 2px; vertical-align: middle; }
        #feature-scenario .scenario-difficulty-selector label[for^="diff-"] { margin-right: 10px; }
        #feature-scenario #ai-scenario-description { font-style: italic; margin-bottom: 10px; }
        #feature-scenario #ai-scenario-dialogue-history { background-color: #f8f8f8; border: 1px solid #eee; border-radius: 4px; padding: 10px; min-height: 80px; margin-bottom:10px; display:none; max-height: 200px; overflow-y: auto;}
        body[data-theme="dark"] #feature-scenario #ai-scenario-dialogue-history { background-color: #222; border-color: #444;}
        #feature-scenario #ai-scenario-dialogue-history p { margin: 3px 0; padding: 4px; border-radius: 3px;}
        #feature-scenario #ai-scenario-dialogue-history .user-utterance { text-align: right; }
        #feature-scenario #ai-scenario-dialogue-history .user-utterance strong { color: var(--primary-color); }
        #feature-scenario #ai-scenario-dialogue-history .ai-utterance strong { color: var(--ai-accent-color); }
        #feature-scenario #user-scenario-response { width: calc(100% - 22px); min-height: 50px; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }

        #feature-essay-correction #essay-input { min-height: 150px; }
        #feature-essay-correction #essay-feedback-area { margin-top: 15px; padding: 12px; background-color: #f9f9f9; border: 1px solid var(--wechat-border-color); border-radius: 6px; min-height: 80px; color: var(--wechat-text-primary); white-space: pre-wrap; font-size: 15px; line-height: 1.6; }
        body[data-theme="dark"] #feature-essay-correction #essay-feedback-area { background-color: #2b2b2b; border-color: #555;}
        #feature-essay-correction #essay-feedback-area.loading::before { content: "AI æ‰¹æ”¹ä¸­..."; color: var(--ai-accent-color); }
        #feature-essay-correction #essay-feedback-area.error { color: var(--danger-color); }

        #feature-mc-questions .mc-category-select {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        body[data-theme="dark"] #feature-mc-questions .mc-category-select { background-color: #2b2b2b;}
        #feature-mc-questions .mc-category-select label {
            font-size: 0.9em;
            margin-right: 5px;
        }
        #feature-mc-questions .mc-category-select input[type="radio"] {
            margin-right: 2px;
            vertical-align: middle;
        }


        #feature-mc-questions .mc-question-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        #feature-mc-questions .mc-question-controls input[type="text"] { flex-grow: 1; margin-bottom: 0;}
        #feature-mc-questions .mc-question-controls input[type="number"] { width: 60px; margin-bottom: 0; text-align: center;}
        #feature-mc-questions .mc-question { margin-bottom: 15px; }
        #feature-mc-questions .mc-question p { font-size: 1.1em; font-weight: 500; margin-bottom: 10px; }
        #feature-mc-questions .mc-options label { display: block; margin-bottom: 8px; cursor: pointer; padding: 8px 10px; border: 1px solid var(--wechat-border-color); border-radius: 5px; transition: background-color 0.2s;}
        body[data-theme="dark"] #feature-mc-questions .mc-options label { border-color: #555;}
        #feature-mc-questions .mc-options label:hover { background-color: #f0f0f0; }
        body[data-theme="dark"] #feature-mc-questions .mc-options label:hover { background-color: #444;}
        #feature-mc-questions .mc-options input[type="radio"] { margin-right: 8px; }
        #feature-mc-questions .mc-feedback { margin-top: 10px; font-weight: bold; min-height: 20px; }
        #feature-mc-questions .mc-feedback.correct { color: var(--primary-color); }
        #feature-mc-questions .mc-feedback.incorrect { color: var(--danger-color); }
        #feature-mc-questions .mc-explanation { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px;}

        #page-local-video #video-player-container {
            text-align: center;
            margin-top: 15px;
        }
        #page-local-video #video-player {
            width: 100%;
            max-width: 600px;
            max-height: 300px;
            background-color: black;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }
        #page-local-video #video-upload-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 1em;
        }
        #page-local-video #video-upload-input {
            display: none;
        }
        #page-local-video .file-name-display {
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
            margin-top: 5px;
            word-break: break-all;
        }


        #page-settings {
            padding: 0;
        }
        #page-settings .profile-section {
            background-color: var(--wechat-list-item-bg);
            padding: 20px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        #page-settings .profile-icon {
            font-size: 48px;
            margin-right: 15px;
            color: var(--wechat-text-secondary);
        }
        #page-settings .profile-info h3 {
            margin: 0;
            font-size: 1.3em;
            color: var(--text-color);
        }
        #page-settings .profile-info p {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
        }

        #page-settings .settings-list {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .settings-list .setting-item {
            padding: 15px;
            border-bottom: 1px solid var(--wechat-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        #page-settings .settings-list .setting-item:last-child {
            border-bottom: none;
        }
        #page-settings .settings-list .setting-item label {
            font-size: 1em;
            color: var(--wechat-text-primary);
            cursor: pointer;
            flex-grow: 1;
        }
        #page-settings .settings-list .setting-item .arrow {
            font-size: 1.2em;
            color: var(--wechat-text-secondary);
            margin-left: 10px;
        }


        #page-settings .about-section {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .about-section .about-button {
            width: 100%;
            background-color: var(--wechat-list-item-bg);
            color: var(--wechat-text-primary);
            border: none;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        #page-settings .about-section .about-button:hover {
             background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-settings .about-section .about-button:hover {
            background-color: #444;
        }
        #page-settings .about-section .about-button .icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: var(--ai-accent-color);
        }

        #page-about {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-about .about-content-area {
            background-color: var(--wechat-list-item-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: center;
            margin-top: 15px;
        }
        #page-about h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #page-about p {
            margin: 8px 0;
            line-height: 1.6;
            font-size: 0.95em;
        }
        #page-about p strong {
            color: var(--text-color);
        }

        #page-study-goals {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-study-goals .goals-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
        #page-study-goals .goals-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--wechat-border-color);
            padding-bottom: 5px;
        }
        #page-study-goals .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1em;
        }
        #page-study-goals .goal-item input {
            width: 60px;
            text-align: center;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .streak-calendar {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-top: 15px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-header {
            font-weight: bold;
            color: var(--wechat-text-secondary);
            font-size: 0.85em;
        }
        .calendar-day {
            padding: 8px 5px;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: var(--wechat-text-primary);
            font-size: 0.9em;
            position: relative;
        }
        body[data-theme="dark"] .calendar-day { background-color: #444; }
        .calendar-day.empty {
            background-color: transparent;
            box-shadow: none;
        }
        .calendar-day.today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }
        .calendar-day.checked::after {
            content: 'âœ”';
            color: white;
            background-color: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8em;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }


        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s, border-color 0.2s;
            box-sizing: border-box;
        }
        .color-option.selected {
            border-color: var(--primary-color);
            border-width: 3px;
            transform: scale(1.1);
        }
        .color-red { background-color: #FF4136; }
        .color-orange { background-color: #FF851B; }
        .color-yellow { background-color: #FFDC00; }
        .color-green { background-color: #07c160; }
        .color-cyan { background-color: #00B8D4; }
        .color-blue { background-color: #0074D9; }
        .color-purple { background-color: #B10DC9; }

        /* å¼€å±åŠ¨ç”»æ ·å¼ */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f8f9fa; /* æµ…ç°è‰²èƒŒæ™¯ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }

        .splash-content {
            text-align: center;
        }

        .splash-title-zh {
            font-size: 2.5em; /* å¢å¤§å­—ä½“ */
            font-weight: bold;
            color: var(--primary-color); /* ä½¿ç”¨ä¸»é¢˜ç»¿è‰² */
            margin-bottom: 0.4em;
        }

        .splash-title-ko {
            font-size: 1.8em; /* å¢å¤§å­—ä½“ */
            color: var(--ai-accent-color); /* ä½¿ç”¨ AI ä¸»é¢˜è“è‰² */
            margin-bottom: 0.8em;
            font-family: 'Noto Sans KR', sans-serif; /* ç¡®ä¿éŸ©æ–‡å­—ä½“ç¾è§‚ */
        }

        .splash-design-by {
            font-size: 1.1em; /* å¢å¤§å­—ä½“ */
            color: var(--wechat-text-secondary); /* ç°è‰²æ–‡å­— */
            margin-top: 1.5em; /* å¢åŠ é—´è· */
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* çƒŸèŠ±åŠ¨ç”»æ ·å¼ */
        #fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
            z-index: 999;
            overflow: hidden; /* é˜²æ­¢çƒŸèŠ±æº¢å‡º */
        }

        .firework {
            position: absolute;
            width: 8px; /* çƒŸèŠ±ç²’å­å¤§å° */
            height: 8px;
            border-radius: 50%;
            opacity: 0; /* åˆå§‹é€æ˜ */
            animation: shootAndExplode 1.5s ease-out forwards; /* ç»„åˆåŠ¨ç”» */
        }

        @keyframes shootAndExplode {
            0% {
                transform: translateY(200px) scale(0); /* ä»åº•éƒ¨å‘ä¸Šå°„å‡º */
                opacity: 0;
            }
            30% {
                transform: translateY(0) scale(1); /* å°„åˆ°æŒ‡å®šé«˜åº¦ */
                opacity: 1;
            }
            100% {
                transform: translateY(-150px) scale(0.2); /* çˆ†ç‚¸å¹¶æ·¡å‡º */
                opacity: 0;
            }
        }

        #congratulations-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--wechat-list-item-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-color);
            text-align: center;
            z-index: 1001;
            max-width: 80%;
            box-sizing: border-box;
            opacity: 0; /* åˆå§‹éšè— */
            animation: fadeInModal 0.3s forwards; /* ä½¿ç”¨ç°æœ‰çš„ fadeInModal */
        }

        #congratulations-modal p {
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary-color);
            line-height: 1.5;
        }
         body[data-theme="dark"] #congratulations-modal p {
            color: var(--wechat-text-primary);
        }

        #congratulations-modal button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #congratulations-modal button:hover {
            background-color: darken(var(--primary-color), 10%);
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-title-zh">AI éŸ©è¯­å­¦ä¹ å°åŠ©æ‰‹</div>
            <div class="splash-title-ko">AI í•œêµ­ì–´ í•™ìŠµ ë„ìš°ë¯¸</div>
            <div class="splash-design-by">Design by MiniWorld</div>
        </div>
    </div>

    <div id="fireworks-container"></div>

    <div id="congratulations-modal">
        <p>ğŸ‰ æ­å–œä½ è¾¾æˆä»Šæ—¥å­¦ä¹ ç›®æ ‡ï¼Œæ‰“å¡æˆåŠŸï¼Œå†æ¥å†å‰ï¼ ğŸ‰</p>
        <button id="close-congrats-modal">å¥½çš„</button>
    </div>

    <div class="app-wrapper" id="app-wrapper">
        <header class="wechat-header">
            <div class="wechat-header-title" id="app-header-title">èƒŒå•è¯</div>
        </header>

        <main class="wechat-content">
            <div id="page-memorize" class="content-page active">
                <div class="status">ç¬¬ <span id="current-word-index">1</span> ä¸ªå•è¯ / å…± <span id="total-words">0</span> ä¸ªå•è¯</div>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div class="word-card-container">
                    <div class="word-card" id="word-card">
                        <div class="card-face card-face-front">
                            <div class="korean-word-container">
                                <div class="korean-word" id="korean-word">è½½å…¥ä¸­...</div>
                                <button class="pronounce-btn">ğŸ”Š</button>
                            </div>
                            <div class="pronunciation" id="pronunciation"></div>
                            <div class="hint-to-flip">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹é‡Šä¹‰æˆ–AIæ‰©å±•</div>
                        </div>
                        <div class="card-face card-face-back">
                            <div class="translation chinese-translation" id="chinese-translation"></div>
                            <div class="example-sentence" id="example-sentence">
                                <div class="korean-example" id="korean-example"></div>
                                <div class="chinese-example" id="chinese-example"></div>
                            </div>
                            <div class="ai-word-expansion-area">
                                <div class="ai-helper-container" id="ai-helper-box"><div class="ai-helper-title">ğŸ’¡ AI åŠ©è®°/å°æç¤º:</div><div class="ai-helper-content" id="ai-helper-content"></div></div>
                                <div class="ai-sentence-generator-container" id="ai-sentence-generator-box"><div class="ai-sentence-generator-title">âœï¸ AI æ™ºèƒ½ä¾‹å¥:</div><div class="ai-generated-sentences" id="ai-generated-sentences"></div></div>
                                <div class="ai-usage-notes-container" id="ai-usage-notes-box"><div class="ai-usage-notes-title">ğŸ§ AI ç”¨æ³•è¾¨æ:</div><div class="ai-usage-notes-content" id="ai-usage-notes-content"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button id="prev-word-btn">â® ä¸Šä¸€ä¸ª</button>
                    <button id="show-translation-btn" onclick="flipCard()">æŸ¥çœ‹/éšè—</button>
                    <button id="next-word-btn">ä¸‹ä¸€ä¸ª â¯</button>
                </div>
                <div class="controls secondary-controls">
                    <button id="mark-known-btn">âœ” æˆ‘è®¤è¯†</button>
                    <button class="ai-btn" id="ai-tip-btn">ğŸ¤– AIæç¤º</button>
                </div>
                <div class="controls tertiary-controls">
                    <button class="ai-btn" id="ai-sentence-btn">âœï¸ AIé€ å¥</button>
                    <button class="ai-btn" id="ai-usage-btn">ğŸ§ AIè¾¨æ</button>
                </div>
            </div>

            <div id="page-review-plan" class="content-page">
                <div class="review-summary"><p>æ€»å­¦ä¹ å•è¯æ•°: <span id="total-learned-count" class="count">0</span></p><p>ä»Šæ—¥åˆ°æœŸå¤ä¹ : <span id="due-today-count" class="count">0</span></p></div>
                <div class="filter-buttons"><button id="filter-all" class="active">å…¨éƒ¨å­¦ä¹ </button><button id="filter-due">åˆ°æœŸå¤ä¹ </button><button id="filter-overdue">é€¾æœŸå¤ä¹ </button></div>
                <div id="review-list-container"><p class="no-reviews">æš‚æ— å¤ä¹ è®¡åˆ’ï¼Œå¿«å»å­¦ä¹ æ–°å•è¯å§ï¼</p></div>
            </div>

            <div id="page-ai-functions" class="content-page menu-active">
                <div class="ai-function-menu" id="ai-main-menu">
                    <div class="ai-function-menu-item" data-sub-feature-id="page-translate" data-title="AI æ™ºèƒ½äº’è¯‘">
                        <span class="icon">ğŸŒ</span> AI æ™ºèƒ½äº’è¯‘
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-ai-dictionary" data-title="AI éŸ©è¯­è¯å…¸">
                        <span class="icon">ğŸ“–</span> AI éŸ©è¯­è¯å…¸
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-image-recognition" data-title="AI çœ‹å›¾è¯†åˆ«éŸ©æ–‡">
                        <span class="icon">ğŸ”</span> AI çœ‹å›¾è¯†åˆ«éŸ©æ–‡
                    </div>
                     <div class="ai-function-menu-item" data-sub-feature-id="page-local-video" data-title="æœ¬åœ°è§†é¢‘æµè§ˆ">
                        <span class="icon">ğŸ¬</span> æœ¬åœ°è§†é¢‘æµè§ˆ
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-cloze" data-title="AI å…‹æ¼å­—å¡«ç©º">
                        <span class="icon">ğŸ¯</span> AI å…‹æ¼å­—å¡«ç©º
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-story" data-title="AI å°æ•…äº‹åˆ›ä½œ">
                        <span class="icon">âœï¸</span> AI å°æ•…äº‹åˆ›ä½œ
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-scenario" data-title="AI æƒ…æ™¯å¯¹è¯æ¨¡æ‹Ÿ">
                        <span class="icon">ğŸ—£ï¸</span> AI æƒ…æ™¯å¯¹è¯æ¨¡æ‹Ÿ
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-essay-correction" data-title="AI æ‰¹æ”¹ä½œæ–‡">
                        <span class="icon">ğŸ“</span> AI æ‰¹æ”¹ä½œæ–‡
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-mc-questions" data-title="AI è‡ªåŠ¨ç”Ÿæˆé€‰æ‹©é¢˜">
                        <span class="icon">â“</span> AI è‡ªåŠ¨ç”Ÿæˆé€‰æ‹©é¢˜
                    </div>
                </div>

                <div id="page-translate" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸŒ AI æ™ºèƒ½äº’è¯‘</h3>
                        <div class="api-key-info">ğŸ”‘ AIç¿»è¯‘åŠŸèƒ½ä½¿ç”¨é¢„è®¾çš„APIå¯†é’¥ã€‚</div>
                        <textarea id="text-to-translate-auto" placeholder="è¾“å…¥éŸ©è¯­æˆ–ä¸­æ–‡è¿›è¡Œäº’è¯‘..."></textarea>
                        <button class="translate-button generic-button" id="do-translate-auto-btn">AI æ™ºèƒ½äº’è¯‘</button>
                        <div class="translation-result-area ai-output-box" id="translation-output-auto">ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨æ­¤</div>
                        <div id="ai-translation-analysis-area"></div>
                    </div>
                </div>

                <div id="page-ai-dictionary" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ“– AI éŸ©è¯­è¯å…¸</h3>
                        <div style="display: flex;">
                            <input type="text" id="korean-word-input" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„éŸ©è¯­å•è¯...">
                            <button class="generic-button" id="search-dictionary-btn">æŸ¥è¯¢</button>
                        </div>
                        <div id="dictionary-output" class="ai-output-box">è¯·åœ¨ä¸Šæ–¹è¾“å…¥éŸ©è¯­å•è¯å¹¶ç‚¹å‡»æŸ¥è¯¢ã€‚</div>
                    </div>
                </div>

                <div id="page-image-recognition" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ” AI çœ‹å›¾è¯†åˆ«éŸ©æ–‡</h3>
                        <label for="image-upload-rec" id="image-upload-label-rec">é€‰æ‹©å›¾ç‰‡</label>
                        <input type="file" id="image-upload-rec" accept="image/*">
                        <div id="image-preview-container-rec">
                            <img id="image-preview-rec" src="#" alt="å›¾ç‰‡é¢„è§ˆ">
                        </div>
                        <button class="ai-action-btn" id="recognize-image-korean-btn" disabled>AI è¯†åˆ«éŸ©æ–‡</button>
                        <div id="ai-image-recognition-output-ko" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>ğŸ‡°ğŸ‡· è¯†åˆ«åˆ°çš„éŸ©æ–‡:</h5><span id="image-recognized-ko-text"></span>
                        </div>
                        <div id="ai-image-recognition-output-zh" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘åŠè§£é‡Š:</h5><span id="image-recognized-zh-text"></span>
                        </div>
                    </div>
                </div>

                <div id="page-local-video" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ¬ æœ¬åœ°è§†é¢‘æµè§ˆ</h3>
                        <p class="api-key-info">æ­¤åŠŸèƒ½å…è®¸æ‚¨æµè§ˆæœ¬åœ°è§†é¢‘æ–‡ä»¶å¹¶åœ¨çº¿æ’­æ”¾ï¼ŒAI è¾…åŠ©åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚</p>
                        <label for="video-upload-input" id="video-upload-label">é€‰æ‹©è§†é¢‘æ–‡ä»¶</label>
                        <input type="file" id="video-upload-input" accept="video/*">
                        <div class="file-name-display" id="video-file-name">æœªé€‰æ‹©æ–‡ä»¶</div>

                        <div id="video-player-container">
                            <video id="video-player" controls style="display: none;"></video>
                        </div>
                    </div>
                </div>

                <div id="feature-cloze" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ¯ AI å®Œå½¢å¡«ç©º</h3>
                        <div id="cloze-test-area">
                            <p class="cloze-question" id="cloze-question-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆé¢˜ç›®ã€‚</p>
                            <p class="cloze-hint" id="cloze-hint-text"></p>
                            <input type="text" id="cloze-answer-input" placeholder="è¾“å…¥æŒ–ç©ºéƒ¨åˆ†çš„éŸ©è¯­å•è¯">
                            <button class="ai-action-btn" id="submit-cloze-btn">æäº¤ç­”æ¡ˆ</button>
                            <div id="cloze-feedback"></div>
                            <div id="cloze-correct-sentence"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-cloze-btn" style="margin-top:10px;">è·å–æ–°å¡«ç©ºé¢˜</button>
                    </div>
                </div>

                <div id="feature-story" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">âœï¸ AI å°æ•…äº‹åˆ›ä½œ</h3>
                        <div class="story-weaver-controls">
                            <label for="story-word-select">é€‰æ‹©2-5ä¸ªå·²å­¦å•è¯:</label>
                            <select id="story-word-select" multiple size="5"></select>
                            <p style="font-size:0.8em; color: var(--wechat-text-secondary)">æŒ‰ä½ Ctrl/Cmd ç‚¹å‡»å¤šé€‰ã€‚</p>
                        </div>
                        <button class="ai-action-btn" id="generate-story-btn">AI å¸®æˆ‘å†™æ•…äº‹</button>
                        <div id="ai-generated-story-ko" class="ai-output-box" style="display:none;"><h5>ğŸ‡°ğŸ‡· éŸ©è¯­æ•…äº‹:</h5><span id="story-ko-text"></span></div>
                        <div id="ai-generated-story-zh" class="ai-output-box" style="display:none;"><h5>ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç¿»è¯‘:</h5><span id="story-zh-text"></span></div>
                    </div>
                </div>

                <div id="feature-scenario" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ—£ï¸ AI æƒ…æ™¯å¯¹è¯æ¨¡æ‹Ÿ</h3>
                        <div id="ai-scenario-area">
                            <div class="scenario-difficulty-selector" style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;">
                                <label style="font-weight: bold; font-size: 0.95em;">é€‰æ‹©å¯¹è¯éš¾åº¦ï¼š</label>
                                <input type="radio" name="scenario-difficulty" value="beginner" id="diff-beginner" checked> <label for="diff-beginner" style="font-size: 0.9em;">åˆçº§</label>
                                <input type="radio" name="scenario-difficulty" value="intermediate" id="diff-intermediate"> <label for="diff-intermediate" style="font-size: 0.9em;">ä¸­çº§</label>
                                <input type="radio" name="scenario-difficulty" value="advanced" id="diff-advanced"> <label for="diff-advanced" style="font-size: 0.9em;">é«˜çº§</label>
                            </div>
                            <p id="ai-scenario-description">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆå¯¹è¯æƒ…å¢ƒã€‚</p>
                            <div id="ai-scenario-dialogue-history"></div>
                            <textarea id="user-scenario-response" placeholder="è¯·è¾“å…¥æ‚¨çš„éŸ©è¯­å›åº”..."></textarea>
                            <button class="ai-action-btn" id="submit-scenario-response-btn">å‘é€å›åº”</button>
                            <div id="ai-scenario-feedback" class="ai-output-box" style="margin-top:5px; display:none;"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-scenario-btn" style="margin-top:10px;">è·å–æ–°å¯¹è¯æƒ…å¢ƒ</button>
                    </div>
                </div>

                <div id="feature-essay-correction" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">ğŸ“ AI æ‰¹æ”¹ä½œæ–‡</h3>
                        <textarea id="essay-input" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„éŸ©è¯­ä½œæ–‡..."></textarea>
                        <button class="ai-action-btn" id="correct-essay-btn">AI æ‰¹æ”¹ä½œæ–‡</button>
                        <div id="essay-feedback-area" class="ai-output-box" style="display:none;"></div>
                    </div>
                </div>

                <div id="feature-mc-questions" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">â† è¿”å› AI åŠŸèƒ½</button>
                    <div class="section-container">
                        <h3 class="section-title">â“ AI è‡ªåŠ¨ç”Ÿæˆé€‰æ‹©é¢˜</h3>
                        <div class="mc-category-select">
                            <label>é€‰æ‹©é¢˜ç±»å‹:</label>
                            <input type="radio" name="mc-category" value="grammar" id="mc-grammar" checked> <label for="mc-grammar">è¯­æ³•</label>
                            <input type="radio" name="mc-category" value="proverb" id="mc-proverb"> <label for="mc-proverb">è°šè¯­ä¿—è¯­</label>
                        </div>
                        <div class="mc-question-controls">
                            <label for="mc-count">æ•°é‡:</label>
                            <input type="number" id="mc-count" value="3" min="1" max="5">
                            <button class="ai-action-btn" id="generate-mc-btn">ç”Ÿæˆé€‰æ‹©é¢˜</button>
                        </div>
                        <div id="mc-questions-area" style="margin-top: 15px;">
                            <p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆé¢˜ç›®ã€‚</p>
                        </div>
                        <button class="ai-action-btn" id="submit-mc-answers-btn" style="display: none; margin-top: 15px;">æäº¤ç­”æ¡ˆ</button>
                    </div>
                </div>

            </div>

            <div id="page-settings" class="content-page">
                <div class="profile-section">
                    <span class="profile-icon">ğŸ‘¤</span>
                    <div class="profile-info">
                        <h3><span id="current-username-display">ç”¨æˆ·å</span></h3>
                        <p>æ¬¢è¿å›æ¥ï¼</p>
                    </div>
                </div>

                <div class="settings-list" id="settings-main-menu">
                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">å­¦ä¹ è®¾ç½®</div>
                    <ul>
                        <li class="setting-item" id="learning-goals-menu-item">
                            <label><span class="icon">ğŸ¯</span> å­¦ä¹ ç›®æ ‡</label>
                            <span class="arrow">â–¶</span>
                        </li>
                        <li class="setting-item">
                            <label for="word-list-select">å­—åº“:</label>
                            <select id="word-list-select" style="width: 150px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 4px; display: inline-block; margin-bottom:0; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);">
                                <option value="general">é€šç”¨è¯æ±‡</option>
                                <option value="computer">è®¡ç®—æœºä¸“ä¸šè¯æ±‡</option>
                                <option value="business">ç»è¥ä¸“ä¸šè¯æ±‡</option>
                            </select>
                        </li>
                        <li class="setting-item">
                            <label for="auto-pronounce-next"><span class="icon">ğŸ”Š</span> è‡ªåŠ¨å‘éŸ³ä¸‹ä¸€ä¸ªå•è¯</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-pronounce-next" checked>
                                <span class="slider"></span>
                            </label>
                        </li>
                    </ul>

                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">UI è®¾ç½®</div>
                    <ul>
                        <li class="setting-item">
                            <label for="dark-mode-toggle"><span class="icon">ğŸŒ™</span> æš—é»‘æ¨¡å¼</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </li>
                        <li class="setting-item" style="padding-bottom: 15px;">
                            <label><span class="icon">ğŸ¨</span> ä¸»é¢˜é¢œè‰²</label>
                            <div>
                                <span class="color-option color-red" data-color="red" title="çº¢è‰²"></span>
                                <span class="color-option color-orange" data-color="orange" title="æ©™è‰²"></span>
                                <span class="color-option color-yellow" data-color="yellow" title="é»„è‰²"></span>
                                <span class="color-option color-green" data-color="green" title="ç»¿è‰²"></span>
                                <span class="color-option color-cyan" data-color="cyan" title="é’è‰²"></span>
                                <span class="color-option color-blue" data-color="blue" title="è“è‰²"></span>
                                <span class="color-option color-purple" data-color="purple" title="ç´«è‰²"></span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="about-section">
                    <button class="about-button" onclick="showAboutPage()">
                        <span class="icon">â„¹ï¸</span> å…³äº
                    </button>
                </div>
            </div>

            <div id="page-study-goals" class="content-page">
                <button class="back-button" onclick="showSettingsMainMenu()">â† è¿”å›</button>
                <div class="goals-container">
                    <h3>å­¦ä¹ ç›®æ ‡è®¾å®š</h3>
                    <div class="goal-item">
                        <label for="daily-study-amount">æ¯æ—¥æ–°è¯å­¦ä¹ é‡:</label>
                        <input type="number" id="daily-study-amount" value="10" min="1" max="50">
                    </div>
                </div>

                <div class="streak-calendar">
                    <h3>å­¦ä¹ æ‰“å¡æ—¥å†</h3>
                    <div class="calendar-header">
                        <span id="calendar-month-year"></span>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <div class="calendar-day-header">æ—¥</div>
                        <div class="calendar-day-header">ä¸€</div>
                        <div class="calendar-day-header">äºŒ</div>
                        <div class="calendar-day-header">ä¸‰</div>
                        <div class="calendar-day-header">å››</div>
                        <div class="calendar-day-header">äº”</div>
                        <div class="calendar-day-header">å…­</div>
                        </div>
                     <p style="font-size: 0.85em; color: var(--wechat-text-secondary); text-align: center; margin-top: 15px;">
                        æ¯æ—¥å­¦ä¹ æ–°è¯è¾¾åˆ°ç›®æ ‡æ•°é‡åè‡ªåŠ¨æ‰“å¡ã€‚
                    </p>
                </div>
            </div>


            <div id="page-about" class="content-page">
                <button class="back-button" onclick="setActivePage('page-settings', 'æˆ‘')">â† è¿”å›</button>
                <div class="about-content-area">
                    <h3>å…³äºæœ¬åº”ç”¨</h3>
                    <p>
                        <strong>ä¸­æ–‡:</strong> æœ¬è½¯ä»¶ç”±MiniWorldå›¢é˜Ÿå¼€å‘ã€‚<br>
                        <strong>æœ‰é—®é¢˜è¯·è”ç³»:</strong> haechojo@gmail.com<br>
                        <strong>ç‰ˆæœ¬å·:</strong> 0.9beta<br>
                        <strong>å‘å¸ƒæ—¥æœŸ:</strong> 2025å¹´5æœˆ27æ—¥
                    </p>
                    <p>
                        <strong>í•œêµ­ì–´:</strong> ì´ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” MiniWorld íŒ€ì— ì˜í•´ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                        <strong>ë¬¸ì˜:</strong> haechojo@gmail.com<                        <strong>ë²„ì „:</strong> 0.9beta<br>
                        <strong>ì¶œì‹œì¼:</strong> 2025ë…„ 5æœˆ27æ—¥
                    </p>
                </div>
            </div>
        </main>

        <nav class="wechat-tabbar">
            <div class="tab-item active" data-page="page-memorize" data-title="èƒŒå•è¯"><div class="tab-item-icon">ğŸ§ </div><div class="tab-item-label">èƒŒå•è¯</div></div>
            <div class="tab-item" data-page="page-review-plan" data-title="å¤ä¹ "><div class="tab-item-icon">ğŸ“…</div><div class="tab-item-label">å¤ä¹ </div></div>
            <div class="tab-item" data-page="page-ai-functions" data-title="AIåŠŸèƒ½"><div class="tab-item-icon">ğŸ¤–</div><div class="tab-item-label">AIåŠŸèƒ½</div></div>
            <div class="tab-item" data-page="page-settings" data-title="æˆ‘"><div class="tab-item-icon">ğŸ‘¤</div><div class="tab-item-label">æˆ‘</div></div>
        </nav>
    </div>


<script>
    const GEMINI_API_KEY = "AIzaSyDlBJ3rTN0VlfLDKHgyJiqQ1VoYIcw9bXs"; // ç¡®ä¿è¿™é‡Œæ˜¯æ‚¨çš„æœ‰æ•ˆAPIå¯†é’¥

    const appWrapperEl = document.getElementById('app-wrapper');
    const appHeaderTitleEl = document.getElementById('app-header-title');
    const contentPages = document.querySelectorAll('.content-page');
    const tabItems = document.querySelectorAll('.tab-item');

    const koreanWordEl = document.getElementById('korean-word');
    const pronunciationEl = document.getElementById('pronunciation');
    const chineseTranslationEl = document.getElementById('chinese-translation');
    const exampleSentenceEl = document.getElementById('example-sentence');
    const koreanExampleEl = document.getElementById('korean-example');
    const chineseExampleEl = document.getElementById('chinese-example');
    const wordCardEl = document.getElementById('word-card');
    const progressBarEl = document.getElementById('progress-bar');
    const currentWordIndexEl = document.getElementById('current-word-index');
    const totalWordsEl = document.getElementById('total-words');
    const aiHelperBoxEl = document.getElementById('ai-helper-box');
    const aiHelperContentEl = document.getElementById('ai-helper-content');
    const aiSentenceGeneratorBoxEl = document.getElementById('ai-sentence-generator-box');
    const aiGeneratedSentencesEl = document.getElementById('ai-generated-sentences');
    const aiUsageNotesBoxEl = document.getElementById('ai-usage-notes-box');
    const aiUsageNotesContentEl = document.getElementById('ai-usage-notes-content');
    const pronounceBtnEl = document.querySelector('#page-memorize .pronounce-btn');

    const reviewListContainerEl = document.getElementById('review-list-container');
    const totalLearnedCountEl = document.getElementById('total-learned-count');
    const dueTodayCountEl = document.getElementById('due-today-count');
    const filterButtonsReview = document.querySelectorAll('#page-review-plan .filter-buttons button');

    const pageAiFunctionsEl = document.getElementById('page-ai-functions');
    const aiFunctionMenuBtns = document.querySelectorAll('#page-ai-functions .ai-function-menu-item');
    const aiSubFeatureSections = document.querySelectorAll('#page-ai-functions .ai-sub-feature-section');

    const textToTranslateAutoEl = document.getElementById('text-to-translate-auto');
    const doTranslateAutoBtnEl = document.getElementById('do-translate-auto-btn');
    const translationOutputAutoEl = document.getElementById('translation-output-auto');
    const aiTranslationAnalysisAreaEl = document.getElementById('ai-translation-analysis-area');

    const koreanWordInputEl = document.getElementById('korean-word-input');
    const searchDictionaryBtnEl = document.getElementById('search-dictionary-btn');
    const dictionaryOutputEl = document.getElementById('dictionary-output');

    const imageUploadInputRecEl = document.getElementById('image-upload-rec');
    const imagePreviewRecEl = document.getElementById('image-preview-rec');
    const recognizeImageKoreanBtnEl = document.getElementById('recognize-image-korean-btn');
    const imageRecognizedKoTextEl = document.getElementById('image-recognized-ko-text');
    const imageRecognizedZhTextEl = document.getElementById('image-recognized-zh-text');
    let uploadedImageBase64Rec = null;
    let uploadedImageMimeTypeRec = null;

    const videoUploadInputEl = document.getElementById('video-upload-input');
    const videoPlayerEl = document.getElementById('video-player');
    const videoFileNameDisplayEl = document.getElementById('video-file-name');

    const clozeQuestionTextEl = document.getElementById('cloze-question-text');
    const clozeHintTextEl = document.getElementById('cloze-hint-text');
    const clozeAnswerInputEl = document.getElementById('cloze-answer-input');
    const clozeFeedbackEl = document.getElementById('cloze-feedback');
    const clozeCorrectSentenceEl = document.getElementById('cloze-correct-sentence');
    const generateClozeBtnEl = document.getElementById('generate-cloze-btn');
    const submitClozeBtnEl = document.getElementById('submit-cloze-btn');
    let currentClozeWordData = null;

    const storyWordSelectEl = document.getElementById('story-word-select');
    const generateStoryBtnEl = document.getElementById('generate-story-btn');
    const aiGeneratedStoryKoBox = document.getElementById('ai-generated-story-ko');
    const storyKoTextEl = document.getElementById('story-ko-text');
    const aiGeneratedStoryZhBox = document.getElementById('ai-generated-story-zh');
    const storyZhTextEl = document.getElementById('story-zh-text');

    const aiScenarioDescriptionEl = document.getElementById('ai-scenario-description');
    const aiScenarioDialogueHistoryEl = document.getElementById('ai-scenario-dialogue-history');
    const userScenarioResponseEl = document.getElementById('user-scenario-response');
    const submitScenarioResponseBtnEl = document.getElementById('submit-scenario-response-btn');
    const aiScenarioFeedbackEl = document.getElementById('ai-scenario-feedback');
    const generateScenarioBtnEl = document.getElementById('generate-scenario-btn');
    let currentAIScenarioContext = [];

    const essayInputEl = document.getElementById('essay-input');
    const correctEssayBtnEl = document.getElementById('correct-essay-btn');
    const essayFeedbackAreaEl = document.getElementById('essay-feedback-area');

    const mcCategoryRadioBtns = document.querySelectorAll('input[name="mc-category"]');
    const mcTopicInputEl = document.getElementById('mc-topic');
    const mcCountInputEl = document.getElementById('mc-count');
    const generateMcBtnEl = document.getElementById('generate-mc-btn');
    const mcQuestionsAreaEl = document.getElementById('mc-questions-area');
    const submitMcAnswersBtnEl = document.getElementById('submit-mc-answers-btn');
    let currentMCQuestions = [];

    const currentUsernameDisplayEl = document.getElementById('current-username-display');
    const dailyStudyAmountInput = document.getElementById('daily-study-amount');
    const autoPronounceNextCheckbox = document.getElementById('auto-pronounce-next');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const colorOptions = document.querySelectorAll('.color-option');
    const pageAboutEl = document.getElementById('page-about');
    const pageStudyGoalsEl = document.getElementById('page-study-goals');
    const learningGoalsMenuItem = document.getElementById('learning-goals-menu-item');
    const wordListSelectEl = document.getElementById('word-list-select');

    const calendarGridEl = document.getElementById('calendar-grid');
    const calendarMonthYearEl = document.getElementById('calendar-month-year');

    // æ–°å¢å¼€å±åŠ¨ç”»å’ŒçƒŸèŠ±ç›¸å…³å…ƒç´ 
    const splashScreen = document.getElementById('splash-screen');
    const fireworksContainer = document.getElementById('fireworks-container');
    const congratulationsModal = document.getElementById('congratulations-modal');
    const closeCongratsModalButton = document.getElementById('close-congrats-modal');


    let allWordLists = {
        general: [
            { korean: "ì•ˆë…•í•˜ì„¸ìš”", pronunciation: "[an-nyeong-ha-se-yo]", chinese: "ä½ å¥½", korean_example: "A: ì•ˆë…•í•˜ì„¸ìš”, ì²˜ìŒ ëµ™ê² ìŠµë‹ˆë‹¤.\nB: ë„¤, ì•ˆë…•í•˜ì„¸ìš”. ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤.", chinese_example: "A: ä½ å¥½ï¼Œåˆæ¬¡è§é¢ã€‚\nB: æ˜¯çš„ï¼Œä½ å¥½ã€‚è§åˆ°ä½ å¾ˆé«˜å…´ã€‚" },
            { korean: "ê°ì‚¬í•©ë‹ˆë‹¤", pronunciation: "[gam-sa-ham-ni-da]", chinese: "è°¢è°¢", korean_example: "ë„ì™€ì£¼ì…”ì„œ ì •ë§ ê°ì‚¬í•©ë‹ˆë‹¤.", chinese_example: "éå¸¸æ„Ÿè°¢æ‚¨çš„å¸®åŠ©ã€‚" },
            { korean: "ê³µë¶€í•˜ë‹¤", pronunciation: "[gong-bu-ha-da]", chinese: "å­¦ä¹ ", korean_example: "ì €ëŠ” í•œêµ­ì–´ë¥¼ ê³µë¶€í•´ìš”.", chinese_example: "æˆ‘å­¦ä¹ éŸ©è¯­ã€‚" },
            { korean: "ì˜í™”", pronunciation: "[yeong-hwa]", chinese: "ç”µå½±", korean_example: "ì–´ë–¤ ì˜í™”ë¥¼ ì¢‹ì•„í•´ìš”?", chinese_example: "ä½ å–œæ¬¢ä»€ä¹ˆç”µå½±ï¼Ÿ" },
            { korean: "ìŒì•…", pronunciation: "[eu-mak]", chinese: "éŸ³ä¹", korean_example: "ì €ëŠ” í´ë˜ì‹ ìŒì•…ì„ ì¦ê²¨ ë“¤ì–´ìš”.", chinese_example: "æˆ‘å–œæ¬¢å¬å¤å…¸éŸ³ä¹ã€‚" },
            { korean: "ì—¬í–‰", pronunciation: "[yeo-haeng]", chinese: "æ—…è¡Œ", korean_example: "ë‹¤ìŒ íœ´ê°€ ë•Œ ì—¬í–‰ ê°ˆ ê³„íšì´ì—ìš”.", chinese_example: "æˆ‘è®¡åˆ’ä¸‹æ¬¡ä¼‘å‡å»æ—…è¡Œã€‚" },
            { korean: "ê°€ì¡±", pronunciation: "[ga-jok]", chinese: "å®¶åº­", korean_example: "ìš°ë¦¬ ê°€ì¡±ì€ ëª¨ë‘ ë‹¤ì„¯ ëª…ì´ì—ìš”.", chinese_example: "æˆ‘ä»¬å®¶ä¸€å…±äº”å£äººã€‚" },
            { korean: "ì‚¬ë‘", pronunciation: "[sa-rang]", chinese: "çˆ±", korean_example: "ì‚¬ë‘ì€ ì•„ë¦„ë‹¤ìš´ ê°ì •ì´ì—ìš”.", chinese_example: "çˆ±æ˜¯ä¸€ç§ç¾ä¸½çš„æƒ…æ„Ÿã€‚" },
            { korean: "í–‰ë³µ", pronunciation: "[haeng-bok]", chinese: "å¹¸ç¦", korean_example: "ëª¨ë‘ê°€ í–‰ë³µí•˜ê¸¸ ë°”ë¼ìš”.", chinese_example: "å¸Œæœ›æ‰€æœ‰äººéƒ½å¹¸ç¦ã€‚" },
            { korean: "ì‹œê°„", pronunciation: "[si-gan]", chinese: "æ—¶é—´", korean_example: "ì‹œê°„å°±æ˜¯é‡‘é’±ã€‚", chinese_example: "æ—¶é—´å°±æ˜¯é‡‘é’±ã€‚" },
            { korean: "ì±…", pronunciation: "[chaek]", chinese: "ä¹¦", korean_example: "ì €ëŠ” ì±…ì„ ì½ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”.", chinese_example: "æˆ‘å–œæ¬¢è¯»ä¹¦ã€‚" },
            { korean: "ì¹œêµ¬", pronunciation: "[chin-gu]", chinese: "æœ‹å‹", korean_example: "ì €ëŠ” ì¢‹ì€ ì¹œêµ¬ê°€ ë§ì•„ìš”.", chinese_example: "æˆ‘æœ‰å¾ˆå¤šå¥½æœ‹å‹ã€‚" },
            { korean: "í•™êµ", pronunciation: "[hak-gyo]", chinese: "å­¦æ ¡", korean_example: "í•™êµì— ë§¤ì¼ ê°€ìš”.", chinese_example: "æˆ‘æ¯å¤©å»å­¦æ ¡ã€‚" },
            { korean: "ìŒì‹", pronunciation: "[eum-sik]", chinese: "é£Ÿç‰©", korean_example: "í•œêµ­ ìŒì‹ì„ ì¢‹ì•„í•´ìš”.", chinese_example: "æˆ‘å–œæ¬¢éŸ©å›½é£Ÿç‰©ã€‚" },
            { korean: "ë¬¼", pronunciation: "[mul]", chinese: "æ°´", korean_example: "ëª©ë§ˆë¥¼ ë•Œ ë¬¼ì„ ë§ˆì…”ìš”.", chinese_example: "å£æ¸´çš„æ—¶å€™å–æ°´ã€‚" },
            { korean: "ì§‘", pronunciation: "[jip]", chinese: "å®¶", korean_example: "ì§‘ì—ì„œ ì‰¬ê³  ì‹¶ì–´ìš”.", chinese_example: "æˆ‘æƒ³åœ¨å®¶ä¼‘æ¯ã€‚" },
            { korean: "ë§í•˜ë‹¤", pronunciation: "[mal-ha-da]", chinese: "è¯´", korean_example: "í•œêµ­ì–´ë¡œ ë§í•˜ê³  ì‹¶ì–´ìš”.", chinese_example: "æˆ‘æƒ³è¯´éŸ©è¯­ã€‚" },
            { korean: "ë“£ë‹¤", pronunciation: "[deut-da]", chinese: "å¬", korean_example: "ìŒì•…ì„ ë“£ëŠ” ì¤‘ì´ì—ìš”.", chinese_example: "æˆ‘æ­£åœ¨å¬éŸ³ä¹ã€‚" },
            { korean: "ë³´ë‹¤", pronunciation: "[bo-da]", chinese: "çœ‹", korean_example: "ì˜í™”ë¥¼ ë³¼ê¹Œìš”?", chinese_example: "æˆ‘ä»¬çœ‹ç”µå½±å—ï¼Ÿ" },
            { korean: "ë¨¹ë‹¤", pronunciation: "[meok-da]", chinese: "åƒ", korean_example: "ì ì‹¬ì„ ë¨¹ì–´ìš”.", chinese_example: "æˆ‘åƒåˆé¥­ã€‚" },
            { korean: "ê°€ë‹¤", pronunciation: "[ga-da]", chinese: "å»", korean_example: "í•™êµì— ê°€ìš”.", chinese_example: "æˆ‘å»å­¦æ ¡ã€‚" },
            { korean: "ì˜¤ë‹¤", pronunciation: "[o-da]", chinese: "æ¥", korean_example: "ì§‘ì— ì™”ì–´ìš”.", chinese_example: "æˆ‘åˆ°å®¶äº†ã€‚" },
            { korean: "í•˜ë‹¤", pronunciation: "[ha-da]", chinese: "åš", korean_example: "ìˆ™ì œë¥¼ í•´ìš”.", chinese_example: "æˆ‘åšä½œä¸šã€‚" },
            { korean: "í¬ë‹¤", pronunciation: "[keu-da]", chinese: "å¤§", korean_example: "ì§‘ì´ ì»¤ìš”.", chinese_example: "æˆ¿å­å¾ˆå¤§ã€‚" },
            { korean: "ì‘ë‹¤", pronunciation: "[jak-da]", chinese: "å°", korean_example: "ë°©ì´ ì‘ì•„ìš”.", chinese_example: "æˆ¿é—´å¾ˆå°ã€‚" },
            { korean: "ì˜ˆì˜ë‹¤", pronunciation: "[ye-ppeu-da]", chinese: "æ¼‚äº®", korean_example: "ê½ƒì´ ì˜ˆë»ìš”.", chinese_example: "èŠ±å¾ˆæ¼‚äº®ã€‚" },
            { korean: "ì¢‹ë‹¤", pronunciation: "[jot-da]", chinese: "å¥½", korean_example: "ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.", chinese_example: "å¤©æ°”å¾ˆå¥½ã€‚" },
            { korean: "ë‚˜ì˜ë‹¤", pronunciation: "[na-ppeu-da]", chinese: "ä¸å¥½", korean_example: "ê¸°ë¶„ì´ ë‚˜ë¹ ìš”.", chinese_example: "å¿ƒæƒ…ä¸å¥½ã€‚" },
            { korean: "ë§ë‹¤", pronunciation: "[man-ta]", chinese: "å¤š", korean_example: "ì¹œêµ¬ê°€ ë§ì•„ìš”.", chinese_example: "æœ‹å‹å¾ˆå¤šã€‚" },
            { korean: "ì—†ë‹¤", pronunciation: "[eop-da]", chinese: "æ²¡æœ‰", korean_example: "ëˆì´ ì—†ì–´ìš”.", chinese_example: "æˆ‘æ²¡æœ‰é’±ã€‚" }
        ],
        computer: [
            { korean: "ì»´í“¨í„°", pronunciation: "[keom-pyu-teo]", chinese: "ç”µè„‘", korean_example: "ìƒˆ ì»´í“¨í„°ë¥¼ ìƒ€ì–´ìš”.", chinese_example: "æˆ‘ä¹°äº†æ–°ç”µè„‘ã€‚" },
            { korean: "ì†Œí”„íŠ¸ì›¨ì–´", pronunciation: "[so-peu-teu-we-eo]", chinese: "è½¯ä»¶", korean_example: "ì´ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ì„¤ì¹˜í•´ì•¼ í•´ìš”.", chinese_example: "æˆ‘éœ€è¦å®‰è£…è¿™ä¸ªè½¯ä»¶ã€‚" },
            { korean: "í•˜ë“œì›¨ì–´", pronunciation: "[ha-deu-we-eo]", chinese: "ç¡¬ä»¶", korean_example: "ì»´í“¨í„° í•˜ë“œì›¨ì–´ëŠ” ì¤‘ìš”í•´ìš”.", chinese_example: "ç”µè„‘ç¡¬ä»¶å¾ˆé‡è¦ã€‚" },
            { korean: "í”„ë¡œê·¸ë˜ë°", pronunciation: "[peu-ro-geu-rae-ming]", chinese: "ç¼–ç¨‹", korean_example: "ì €ëŠ” íŒŒì´ì¬ìœ¼ë¡œ í”„ë¡œê·¸ë˜ë°ì„ ê³µë¶€í•˜ê³  ìˆì–´ìš”.", chinese_example: "æˆ‘æ­£åœ¨å­¦ä¹ ç”¨Pythonç¼–ç¨‹ã€‚" },
            { korean: "ë„¤íŠ¸ì›Œí¬", pronunciation: "[ne-teu-weo-keu]", chinese: "ç½‘ç»œ", korean_example: "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•´ìš”.", chinese_example: "ç½‘ç»œè¿æ¥ä¸ç¨³å®šã€‚" },
            { korean: "ë°ì´í„°", pronunciation: "[de-i-teo]", chinese: "æ•°æ®", korean_example: "ë¹…ë°ì´í„° ë¶„ì„ì€ ì¤‘ìš”í•´ìš”.", chinese_example: "å¤§æ•°æ®åˆ†æå¾ˆé‡è¦ã€‚" },
            { korean: "ì•Œê³ ë¦¬ì¦˜", pronunciation: "[al-go-ri-jeum]", chinese: "ç®—æ³•", korean_example: "ì´ ì•Œê³ ë¦¬ì¦˜ì€ ë§¤ìš° íš¨ìœ¨ì ì´ì—ìš”.", chinese_example: "è¿™ä¸ªç®—æ³•éå¸¸é«˜æ•ˆã€‚" },
            { korean: "ì¸ê³µì§€ëŠ¥", pronunciation: "[in-gong-ji-neung]", chinese: "äººå·¥æ™ºèƒ½", korean_example: "ì¸ê³µì§€ëŠ¥ì€ ë¯¸ë˜ ê¸°ìˆ ì´ì—ìš”.", chinese_example: "äººå·¥æ™ºèƒ½æ˜¯æœªæ¥çš„æŠ€æœ¯ã€‚" },
            { korean: "í´ë¼ìš°ë“œ", pronunciation: "[keul-la-u-deu]", chinese: "äº‘ï¼ˆè®¡ç®—ï¼‰", korean_example: "í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê³  ìˆì–´ìš”.", chinese_example: "æˆ‘æ­£åœ¨ä½¿ç”¨äº‘è®¡ç®—æœåŠ¡ã€‚" },
            { korean: "ë³´ì•ˆ", pronunciation: "[bo-an]", chinese: "å®‰å…¨ï¼ˆä¿¡æ¯å®‰å…¨ï¼‰", korean_example: "ì •ë³´ ë³´ì•ˆì´ ë§¤ìš° ì¤‘ìš”í•´ìš”.", chinese_example: "ä¿¡æ¯å®‰å…¨éå¸¸é‡è¦ã€‚" }
        ],
        business: [
            { korean: "ê²½ì œ", pronunciation: "[gyeong-je]", chinese: "ç»æµ", korean_example: "ì„¸ê³„ ê²½ì œê°€ ì–´ë µìŠµë‹ˆë‹¤.", chinese_example: "ä¸–ç•Œç»æµå¾ˆå›°éš¾ã€‚" },
            { korean: "ê²½ì˜", pronunciation: "[gyeong-yeong]", chinese: "ç»è¥/ç®¡ç†", korean_example: "ê²½ì˜í•™ì„ ì „ê³µí–ˆì–´ìš”.", chinese_example: "æˆ‘ä¸»ä¿®ç»è¥å­¦ã€‚" },
            { korean: "ë§ˆì¼€íŒ…", pronunciation: "[ma-ke-ting]", chinese: "å¸‚åœºè¥é”€", korean_example: "ìƒˆë¡œìš´ ë§ˆì¼€íŒ… ì „ëµì´ í•„ìš”í•´ìš”.", chinese_example: "æˆ‘ä»¬éœ€è¦æ–°çš„å¸‚åœºè¥é”€ç­–ç•¥ã€‚" },
            { korean: "íšŒê³„", pronunciation: "[hoe-gye]", chinese: "ä¼šè®¡", korean_example: "íšŒê³„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì•¼ í•´ìš”.", chinese_example: "æˆ‘éœ€è¦å‡†å¤‡ä¼šè®¡æŠ¥å‘Šã€‚" },
            { korean: "íˆ¬ì", pronunciation: "[tu-ja]", chinese: "æŠ•èµ„", korean_example: "ë¶€ë™ì‚°ì— íˆ¬ìí–ˆì–´ìš”.", chinese_example: "æˆ‘æŠ•èµ„äº†æˆ¿åœ°äº§ã€‚" },
            { korean: "ìˆ˜ìµ", pronunciation: "[su-ik]", chinese: "æ”¶ç›Š/åˆ©æ¶¦", korean_example: "íšŒì‚¬ì˜ ìˆ˜ìµì´ ì¦ê°€í–ˆì–´ìš”.", chinese_example: "å…¬å¸çš„æ”¶ç›Šå¢åŠ äº†ã€‚" },
            { korean: "ë¹„ìš©", pronunciation: "[bi-yong]", chinese: "è´¹ç”¨/æˆæœ¬", korean_example: "ë¶ˆí•„ìš”í•œ ë¹„ìš©ì„ ì¤„ì—¬ì•¼ í•´ìš”.", chinese_example: "æˆ‘ä»¬éœ€è¦å‰Šå‡ä¸å¿…è¦çš„æˆæœ¬ã€‚" },
            { korean: "ì‹œì¥", pronunciation: "[si-jang]", chinese: "å¸‚åœº", korean_example: "í•œêµ­ ì‹œì¥ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”.", chinese_example: "æˆ‘æ­£åœ¨åˆ†æéŸ©å›½å¸‚åœºã€‚" },
            { korean: "ì „ëµ", pronunciation: "[jeon-llyak]", chinese: "æˆ˜ç•¥", korean_example: "é•¿æœŸì ì¸æˆ˜ç•¥ã‚’ ì„¸ì›Œì•¼ í•´ìš”.", chinese_example: "æˆ‘ä»¬éœ€è¦åˆ¶å®šé•¿æœŸæˆ˜ç•¥ã€‚" },
            { korean: "ê³ ê°", pronunciation: "[go-gaek]", chinese: "é¡¾å®¢/å®¢æˆ·", korean_example: "ê³ ê° ë§Œì¡±ì´ ìµœìš°ì„ ì´ì—ìš”.", chinese_example: "é¡¾å®¢æ»¡æ„æ˜¯æˆ‘ä»¬çš„é¦–è¦ä»»åŠ¡ã€‚" }
        ]
    };

    let currentWordListName = 'general';
    let wordList = allWordLists[currentWordListName];

    let currentWordIndex = 0;
    let isCardFlipped = false;
    let synth = window.speechSynthesis;
    let learnedWordsData = {};
    const srsIntervals = [1, 3, 7, 15, 30, 60, 120];

    let dailyNewWordsLimit = 10;
    let dailyNewWordsLearnedToday = 0;
    let studyStreak = {};

    function getTodayDateString() {
        const today = new Date();
        return today.toISOString().slice(0, 10);
    }

    function loadLearnedWords() {
        const savedCurrentList = localStorage.getItem('hanyangKoreanCurrentWordList_AI_Advanced_v10');
        if (savedCurrentList && allWordLists[savedCurrentList]) {
            currentWordListName = savedCurrentList;
        } else {
            currentWordListName = 'general';
        }
        wordList = allWordLists[currentWordListName];

        if (wordListSelectEl) {
            wordListSelectEl.value = currentWordListName;
        }

        const data = localStorage.getItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`);
        if (data) {
            learnedWordsData = JSON.parse(data);
        } else {
            learnedWordsData = {};
        }

        const savedLimit = localStorage.getItem('dailyNewWordsLimit');
        if (savedLimit) dailyNewWordsLimit = parseInt(savedLimit, 10);
        if (dailyStudyAmountInput) dailyStudyAmountInput.value = dailyNewWordsLimit;

        const savedLearnedToday = localStorage.getItem('dailyNewWordsLearnedToday');
        const savedDate = localStorage.getItem('lastDailyNewWordsDate');
        const todayStr = getTodayDateString();

        if (savedDate === todayStr) {
            dailyNewWordsLearnedToday = parseInt(savedLearnedToday, 10);
        } else {
            dailyNewWordsLearnedToday = 0;
            localStorage.setItem('dailyNewWordsLearnedToday', 0);
            localStorage.setItem('lastDailyNewWordsDate', todayStr);
        }

        const savedStreak = localStorage.getItem('hanyangKoreanStudyStreak');
        if (savedStreak) {
            try {
                studyStreak = JSON.parse(savedStreak);
            } catch (e) {
                console.error("Error parsing study streak from localStorage", e);
                studyStreak = {};
            }
        } else {
            studyStreak = {};
        }
    }

    function saveLearnedWords() {
        localStorage.setItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`, JSON.stringify(learnedWordsData));
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);
        localStorage.setItem('dailyNewWordsLearnedToday', dailyNewWordsLearnedToday);
        localStorage.setItem('lastDailyNewWordsDate', getTodayDateString());
        localStorage.setItem('hanyangKoreanStudyStreak', JSON.stringify(studyStreak));
    }

    function renderCalendar() {
        if (!calendarGridEl) return;

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        calendarMonthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calendarGridEl.innerHTML = `
            <div class="calendar-day-header">æ—¥</div>
            <div class="calendar-day-header">ä¸€</div>
            <div class="calendar-day-header">äºŒ</div>
            <div class="calendar-day-header">ä¸‰</div>
            <div class="calendar-day-header">å››</div>
            <div class="calendar-day-header">äº”</div>
            <div class="calendar-day-header">å…­</div>
        `;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const numDaysInMonth = lastDayOfMonth.getDate();
        const firstDayOfWeek = firstDayOfMonth.getDay();

        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarGridEl.appendChild(emptyDay);
        }

        for (let day = 1; day <= numDaysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = day;

            const currentDay = new Date(year, month, day);
            const dayString = currentDay.toISOString().slice(0, 10);

            if (dayString === getTodayDateString()) {
                dayEl.classList.add('today');
            }
            if (studyStreak[dayString]) {
                dayEl.classList.add('checked');
            }
            calendarGridEl.appendChild(dayEl);
        }
    }

    // ä¿®æ”¹ checkDailyStudyGoal å‡½æ•°ä»¥æ˜¾ç¤ºçƒŸèŠ±å’Œå¼¹çª—
    function checkDailyStudyGoal() {
        const todayStr = getTodayDateString();
        // é‡æ–°è®¡ç®—ä»Šæ—¥å­¦ä¹ æ–°è¯æ•°é‡
        const wordsLearnedToday = Object.values(learnedWordsData).filter(word => {
            const firstLearnedDate = new Date(word.firstLearned).toISOString().slice(0, 10);
            return firstLearnedDate === todayStr && word.reviewCount === 1; // ç¬¬ä¸€æ¬¡å­¦ä¹ æ‰ç®—æ–°è¯
        }).length;

        if (wordsLearnedToday >= dailyNewWordsLimit && !studyStreak[todayStr]) {
            studyStreak[todayStr] = true;
            saveLearnedWords(); // ä¿å­˜æ‰“å¡è®°å½•
            renderCalendar(); // æ›´æ–°æ—¥å†
            showFireworks(); // æ˜¾ç¤ºçƒŸèŠ±
            showCongratulationsModal(); // æ˜¾ç¤ºæ­å–œå¼¹çª—
            console.log("ä»Šæ—¥å­¦ä¹ ç›®æ ‡å·²å®Œæˆï¼Œæ‰“å¡æˆåŠŸï¼");
        }
    }

    function showFireworks() {
        fireworksContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„çƒŸèŠ±
        const numberOfFireworks = 20; // çƒŸèŠ±æ•°é‡
        for (let i = 0; i < numberOfFireworks; i++) {
            const firework = document.createElement('div');
            firework.classList.add('firework');
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6; // çƒŸèŠ±å‡ºç°dçš„ä¸ŠåŠéƒ¨åˆ†
            firework.style.left = `${x}px`;
            firework.style.top = `${y}px`;
            const color = `hsl(${Math.random() * 360}, 100%, 50%)`; // éšæœºé¢œè‰²
            firework.style.backgroundColor = color;
            const animationDelay = Math.random() * 0.5; // éšæœºå»¶è¿Ÿ
            firework.style.animationDelay = `${animationDelay}s`;
            fireworksContainer.appendChild(firework);
        }
        // çƒŸèŠ±åŠ¨ç”»ç»“æŸåæ¸…ç©ºå®¹å™¨
        setTimeout(() => {
            fireworksContainer.innerHTML = '';
        }, 2000); // çƒŸèŠ±æ˜¾ç¤º 2 ç§’åæ¶ˆå¤±
    }

    function showCongratulationsModal() {
        congratulationsModal.style.display = 'block';
        congratulationsModal.style.opacity = '1'; // ç¡®ä¿æ˜¾ç¤ºæ—¶é€æ˜åº¦ä¸º 1
    }

    function hideCongratulationsModal() {
        congratulationsModal.style.display = 'none';
    }


    function applySavedSettings() {
        const savedTheme = localStorage.getItem('hanyangKoreanTheme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            if (darkModeToggle) darkModeToggle.checked = true;
        } else {
            document.body.removeAttribute('data-theme');
            if (darkModeToggle) darkModeToggle.checked = false;
        }

        const savedColorTheme = localStorage.getItem('hanyangKoreanColorTheme');
        if (savedColorTheme) {
            document.body.setAttribute('data-color-theme', savedColorTheme);
            selectThemeColor(savedColorTheme, false);
        } else {
            document.body.setAttribute('data-color-theme', 'green');
            selectThemeColor('green', false);
        }
    }

    function toggleDarkMode() {
        if (darkModeToggle.checked) {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('hanyangKoreanTheme', 'dark');
        } else {
            document.body.removeAttribute('data-theme');
            localStorage.removeItem('hanyangKoreanTheme');
        }
    }

    function selectThemeColor(color, save = true) {
        document.body.setAttribute('data-color-theme', color);
        colorOptions.forEach(option => {
            option.style.cursor = 'pointer';
            option.classList.toggle('selected', option.dataset.color === color);
        });
        if (save) {
            localStorage.setItem('hanyangKoreanColorTheme', color);
        }
    }

    async function callGeminiAPI(contents, purpose = "general", targetElementForLoading = null) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            const msg = "é”™è¯¯ï¼šGemini APIå¯†é’¥æ— æ•ˆæˆ–æœªåœ¨JSä¸­æ­£ç¡®è®¾ç½®ã€‚"; console.error(msg);
            if (targetElementForLoading) { targetElementForLoading.textContent = msg; targetElementForLoading.classList.add('error'); targetElementForLoading.classList.remove('loading'); }
            return null;
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // Ensure contents is always an array of objects with role and parts
        let formattedContents;
        if (Array.isArray(contents)) {
            // If it's already an array, ensure each item has role/parts structure
            formattedContents = contents.map(item => {
                if (item.role && item.parts) {
                    return item;
                } else if (item.text || item.inline_data) { // Assume it's a part and wrap it
                    return { role: "user", parts: [item] };
                }
                return { role: "user", parts: [{ text: JSON.stringify(item) }] }; // Fallback for unexpected formats
            });
        } else if (contents.text || contents.inline_data) { // If it's a single part
            formattedContents = [{ role: "user", parts: [contents] }];
        } else { // Fallback for unexpected single object formats
            formattedContents = [{ role: "user", parts: [{ text: JSON.stringify(contents) }] }];
        }

        const requestBody = { contents: formattedContents, generationConfig: { "candidateCount": 1, "temperature": 0.6 } };

        if (targetElementForLoading) { targetElementForLoading.innerHTML = ""; targetElementForLoading.classList.add('loading'); targetElementForLoading.classList.remove('error');}

        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (targetElementForLoading) targetElementForLoading.classList.remove('loading');
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: "æ— æ³•è§£æAPIé”™è¯¯å›åº”" } }));
                throw new Error(`API é”™è¯¯ (${response.status}): ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                return data.candidates[0].content.parts[0].text.trim();
            } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                 throw new Error(`è¯·æ±‚è¢«é˜»æ­¢: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`);
            } else { throw new Error("AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå†…å®¹æˆ–è¿”å›äº†é¢„æœŸå¤–çš„æ•°æ®ç»“æ„ã€‚"); }
        } catch (error) {
            console.error(`Gemini API è°ƒç”¨å¤±è´¥ï¼Œç›®çš„ "${purpose}":`, error);
            if (targetElementForLoading) { targetElementForLoading.textContent = `AIè°ƒç”¨å¤±è´¥: ${error.message}`; targetElementForLoading.classList.add('error');}
            return null;
        }
    }

    async function getAITipForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiHelperContentEl.textContent = ""; aiHelperBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `æˆ‘æ­£åœ¨å­¦ä¹ éŸ©è¯­å•è¯ "${korean}"ï¼Œå®ƒçš„ä¸­æ–‡æ„æ€æ˜¯ "${chinese}"ã€‚è¯·ç”¨ç®€ä½“ä¸­æ–‡ç»™æˆ‘ä¸€ä¸ªéå¸¸ç®€çŸ­ã€æœ‰è¶£ä¸”æ˜“äºè®°å¿†çš„åŠ©è®°æ–¹æ³•ï¼Œæˆ–è€…ä¸€ä¸ªä¸è¿™ä¸ªå•è¯ç´§å¯†ç›¸å…³çš„éŸ©å›½æ–‡åŒ–å°çŸ¥è¯†ï¼Œå¸®åŠ©æˆ‘è®°ä½å®ƒã€‚è¯·ä¸“æ³¨äºä¸€ä¸ªç‚¹ï¼Œä¿æŒåœ¨ä¸€ä¸¤å¥è¯ä¹‹å†…ã€‚`;
        const aiTip = await callGeminiAPI([{text: prompt}], "ai_tip", aiHelperContentEl);
        if (aiTip && !aiHelperContentEl.classList.contains('error')) aiHelperContentEl.textContent = aiTip;
    }
    async function getAISentencesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiGeneratedSentencesEl.innerHTML = ""; aiSentenceGeneratorBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `ä¸ºéŸ©è¯­å•è¯ "${korean}" (æ„æ€æ˜¯ "${chinese}") ç”Ÿæˆ2-3ä¸ªç®€çŸ­å®ç”¨çš„éŸ©è¯­ä¾‹å¥ï¼Œå¹¶ä¸ºæ¯ä¸ªä¾‹å¥æä¾›å¯¹åº”çš„ç®€ä½“ä¸­æ–‡ç¿»è¯‘ã€‚è¯·ç¡®ä¿ä¾‹å¥ç®€å•æ˜“æ‡‚ï¼Œé€‚åˆåˆå­¦è€…ã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n1. éŸ©è¯­ä¾‹å¥1\n   ä¸­æ–‡ç¿»è¯‘1\n2. éŸ©è¯­ä¾‹å¥2\n   ä¸­æ–‡ç¿»è¯‘2`;
        const sentencesText = await callGeminiAPI([{text: prompt}], "ai_sentence", aiGeneratedSentencesEl);
        if (sentencesText && !aiGeneratedSentencesEl.classList.contains('error')) {
            const lines = sentencesText.split('\n').filter(line => line.trim() !== ''); let htmlContent = "<ul>";
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].match(/^\d+\.\s*/)) { htmlContent += `<li><strong>${lines[i].replace(/^\d+\.\s*/, '')}</strong><br>`;
                    if (lines[i+1] && !lines[i+1].match(/^\d+\.\s*/)) { htmlContent += `<span style="font-size:0.9em; color:var(--wechat-text-secondary);">${lines[i+1]}</span></li>`; i++; }
                    else { htmlContent += `</li>`; }
                }
            } htmlContent += "</ul>"; aiGeneratedSentencesEl.innerHTML = htmlContent;
        }
    }
    async function getAIUsageNotesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiUsageNotesContentEl.textContent = ""; aiUsageNotesBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `å…³äºéŸ©è¯­å•è¯ "${korean}" (æ„æ€æ˜¯ "${chinese}")ï¼š\n1. å®ƒæœ€å¸¸è§çš„ç”¨æ³•æˆ–æ­é…æ˜¯ä»€ä¹ˆï¼Ÿ\n2. æœ‰æ²¡æœ‰åˆå­¦è€…å®¹æ˜“æ··æ·†çš„ç”¨æ³•æˆ–è€…å’Œä¸­æ–‡æ„æ€çš„ç»†å¾®å·®åˆ«ï¼Ÿ\n3. å¦‚æœæœ‰ç›¸å…³çš„è¿‘ä¹‰è¯æˆ–åä¹‰è¯ï¼Œè¯·ä¸¾ä¸€ä¾‹ã€‚\nè¯·ç”¨ç®€ä½“ä¸­æ–‡ç®€æ˜æ‰¼è¦åœ°å›ç­”ï¼Œæ¯ä¸ªç‚¹ä¸€ä¸¤å¥è¯å³å¯ã€‚`;
        const usageNotes = await callGeminiAPI([{text: prompt}], "ai_usage", aiUsageNotesContentEl);
        if (usageNotes && !aiUsageNotesContentEl.classList.contains('error')) aiUsageNotesContentEl.textContent = usageNotes;
    }

    async function translateAutoDetect() {
        const text = textToTranslateAutoEl.value.trim();
        if (!text) { translationOutputAutoEl.textContent = "è¯·è¾“å…¥è¦ç¿»è¯‘çš„å†…å®¹ã€‚"; aiTranslationAnalysisAreaEl.innerHTML = ""; return; }
        const prompt = `è¯·è‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹æ–‡æœ¬æ˜¯ä¸­æ–‡è¿˜æ˜¯éŸ©è¯­ã€‚\n- å¦‚æœæ˜¯ä¸­æ–‡ï¼Œè¯·å°†å…¶ç¿»è¯‘æˆéŸ©è¯­ã€‚\n- å¦‚æœæ˜¯éŸ©è¯­ï¼Œè¯·å°†å…¶ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ã€‚\nè¯·åªæä¾›ç¿»è¯‘åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šã€ä»‹ç»æˆ–å›´ç»•ç¿»è¯‘æœ¬èº«çš„å¼•å·ã€‚\næ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š\n"${text}"`;
        aiTranslationAnalysisAreaEl.innerHTML = "";
        const translatedText = await callGeminiAPI([{text: prompt}], "auto_translate", translationOutputAutoEl);
        if (translatedText && !translationOutputAutoEl.classList.contains('error')) {
            translationOutputAutoEl.textContent = translatedText;
        }
    }

    async function searchAIDictionary() {
        const koreanWord = koreanWordInputEl.value.trim();
        if (!koreanWord) { dictionaryOutputEl.textContent = "è¯·è¾“å…¥è¦æŸ¥è¯¢çš„éŸ©è¯­å•è¯ã€‚"; dictionaryOutputEl.classList.remove('loading', 'error'); return; }
        const prompt = `è¯·ä¸ºéŸ©è¯­å•è¯ "${koreanWord}" æä¾›ä¸€ä¸ªè¯¦ç»†çš„ä¸­æ–‡è¯å…¸æ¡ç›®ï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š\n1. **å‘éŸ³**ï¼š[ç½—é©¬éŸ³æ ‡è®°]\n2. **è¯æ€§**ï¼šä¾‹å¦‚ åè¯, åŠ¨è¯, å½¢å®¹è¯ç­‰ã€‚\n3. **ä¸­æ–‡é‡Šä¹‰**ï¼šåˆ—å‡º1-3ä¸ªä¸»è¦æ„æ€ï¼Œæ¯ä¸ªæ„æ€åé™„å¸¦ä¸€ä¸ªéŸ©è¯­ä¾‹å¥åŠå…¶ç®€ä½“ä¸­æ–‡ç¿»è¯‘ã€‚\n   - æ„æ€1: [ä¸­æ–‡æ„æ€1]\n     ä¾‹å¥ (éŸ©): [éŸ©è¯­ä¾‹å¥1]\n     ä¾‹å¥ (ä¸­): [ä¸­æ–‡ç¿»è¯‘1]\n   - æ„æ€2: [ä¸­æ–‡æ„æ€2]\n     ä¾‹å¥ (éŸ©): [éŸ©è¯­ä¾‹å¥2]\n     ä¾‹å¥ (ä¸­): [ä¸­æ–‡ç¿»è¯‘2]\n4. **å¸¸ç”¨æ­é…** (å¯é€‰ï¼Œ1-2ä¸ª)ï¼šä¾‹å¦‚ "${koreanWord} + (åè¯/åŠ¨è¯)"\n5. **è¿‘ä¹‰è¯** (å¯é€‰ï¼Œ1ä¸ª)ï¼š[éŸ©è¯­è¿‘ä¹‰è¯] - [ä¸­æ–‡æ„æ€]\n6. **åä¹‰è¯** (å¯é€‰ï¼Œ1ä¸ª)ï¼š[éŸ©è¯­åä¹‰è¯] - [ä¸­æ–‡æ„æ€]\n7. **è¯æº/åŠ©è®°** (å¯é€‰ï¼Œä¸€å¥è¯ç®€è¿°ï¼Œè‹¥æœ‰æ„ä¹‰)ï¼š\nè¯·ç¡®ä¿æ ¼å¼æ¸…æ™°ï¼Œä¾‹å¥å®ç”¨ã€‚å¦‚æœæŸäº›éƒ¨åˆ†ä¸é€‚ç”¨æˆ–éš¾ä»¥æ‰¾åˆ°ï¼Œå¯ä»¥çœç•¥è¯¥éƒ¨åˆ†ï¼Œä½†è¯·å°½é‡æä¾›æ ¸å¿ƒä¿¡æ¯ã€‚`;
        const dictionaryEntryText = await callGeminiAPI([{text: prompt}], "ai_dictionary", dictionaryOutputEl);
        if (dictionaryEntryText && !dictionaryOutputEl.classList.contains('error')) {
            dictionaryOutputEl.innerHTML = dictionaryEntryText.replace(/\n/g, '<br>');
        }
    }

    async function generateImageRecognition() {
        if (!uploadedImageBase64Rec || !uploadedImageMimeTypeRec) { alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚"); return; }
        imageRecognizedKoTextEl.textContent = ""; imageRecognizedZhTextEl.textContent = "";
        const recognitionOutputKoBox = document.getElementById('ai-image-recognition-output-ko');
        const recognitionOutputZhBox = document.getElementById('ai-image-recognition-output-zh');

        recognitionOutputKoBox.classList.add('loading');
        recognitionOutputKoBox.style.display = 'block';
        recognitionOutputZhBox.style.display = 'none';

        const promptParts = [
            { inline_data: { mime_type: uploadedImageMimeTypeRec, data: uploadedImageBase64Rec } },
            { text: "è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„éŸ©è¯­æ–‡å­—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚ç„¶åï¼Œè¯·åœ¨ä¸‹ä¸€è¡Œç”¨ '---ä¸­æ–‡ç¿»è¯‘åŠè§£é‡Š---' åˆ†éš”ï¼Œæä¾›è¯†åˆ«åˆ°çš„éŸ©è¯­æ–‡å­—çš„ç®€ä½“ä¸­æ–‡ç¿»è¯‘å’Œç®€è¦è§£é‡Šï¼ˆä¾‹å¦‚ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ–è€…åœ¨ä»€ä¹ˆæƒ…å¢ƒä¸‹ä½¿ç”¨ï¼‰ã€‚å¦‚æœå›¾ç‰‡ä¸­æ²¡æœ‰éŸ©è¯­æ–‡å­—ï¼Œè¯·è¯´æ˜å›¾ç‰‡å†…å®¹ï¼Œå¹¶è¯´æ˜æœªæ‰¾åˆ°éŸ©è¯­æ–‡å­—ã€‚"}
        ];
        const resultText = await callGeminiAPI([{role: "user", parts: promptParts}], "image_recognition", recognitionOutputKoBox);

        if (resultText && !recognitionOutputKoBox.classList.contains('error')) {
            const parts = resultText.split("---ä¸­æ–‡ç¿»è¯‘åŠè§£é‡Š---");
            imageRecognizedKoTextEl.textContent = parts[0] ? parts[0].trim() : "AIæœªèƒ½è¯†åˆ«åˆ°éŸ©è¯­æ–‡å­—ã€‚";
            if (parts[1]) {
                imageRecognizedZhTextEl.textContent = parts[1].trim();
                recognitionOutputZhBox.style.display = 'block';
            } else {
                imageRecognizedZhTextEl.textContent = "AIæœªèƒ½æä¾›ä¸­æ–‡ç¿»è¯‘å’Œè§£é‡Šã€‚";
                recognitionOutputZhBox.style.display = 'block';
            }
        } else if (!resultText && !recognitionOutputKoBox.classList.contains('error')) {
            imageRecognizedKoTextEl.textContent = "AIçœ‹å›¾è¯†åˆ«éŸ©æ–‡å¤±è´¥æˆ–æœªè¿”å›å†…å®¹ã€‚";
        }
    }

    function handleVideoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const fileURL = URL.createObjectURL(file);
            videoPlayerEl.src = fileURL;
            videoPlayerEl.style.display = 'block';
            videoPlayerEl.load();
            videoFileNameDisplayEl.textContent = `ç›®å‰æ–‡ä»¶: ${file.name}`;
        } else {
            videoPlayerEl.src = '';
            videoPlayerEl.style.display = 'none';
            videoFileNameDisplayEl.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
        }
    }

    async function generateAIClozeTest() {
        clozeQuestionTextEl.textContent = ""; clozeHintTextEl.textContent = ""; clozeAnswerInputEl.value = "";
        clozeFeedbackEl.textContent = ""; clozeCorrectSentenceEl.textContent = ""; currentClozeWordData = null;
        const learnedKeys = Object.keys(learnedWordsData);
        if (learnedKeys.length === 0) { clozeQuestionTextEl.textContent = "è¯·å…ˆå­¦ä¹ ä¸€äº›å•è¯æ‰èƒ½è¿›è¡Œå¡«ç©ºç»ƒä¹ ã€‚"; return; }
        const randomWordKey = learnedKeys[Math.floor(Math.random() * learnedKeys.length)];
        const wordData = wordList.find(w => w.korean === randomWordKey) || {};
        if (!wordData.korean_example || !wordData.chinese_example) {
            clozeQuestionTextEl.textContent = "æœªèƒ½æ‰¾åˆ°å«æœ‰ä¾‹å¥çš„å·²å­¦å•è¯ï¼Œè¯·å¤šå­¦ä¹ ä¸€äº›å•è¯æˆ–é‡è¯•ã€‚";
            return;
        }
        currentClozeWordData = wordData;

        const exampleSentence = wordData.korean_example.split('\n')[0];
        const chineseExample = wordData.chinese_example.split('\n')[0];
        const clozeSentence = exampleSentence.replace(wordData.korean, "_____");

        clozeQuestionTextEl.textContent = clozeSentence;
        clozeHintTextEl.textContent = `æç¤º (ä¸­æ–‡): ${chineseExample}`;
        clozeCorrectSentenceEl.style.display = 'none';
    }
    function submitClozeAnswer() {
        const userAnswer = clozeAnswerInputEl.value.trim();
        if (!currentClozeWordData || !userAnswer) { clozeFeedbackEl.textContent = "è¯·è¾“å…¥ç­”æ¡ˆã€‚"; clozeFeedbackEl.style.color = "var(--warning-color)"; return; }
        if (userAnswer === currentClozeWordData.korean) { clozeFeedbackEl.textContent = "å›ç­”æ­£ç¡®ï¼ğŸ‰"; clozeFeedbackEl.style.color = "var(--primary-color)"; }
        else { clozeFeedbackEl.textContent = `å›ç­”é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯: ${currentClozeWordData.korean}`; clozeFeedbackEl.style.color = "var(--danger-color)"; }
        if(currentClozeWordData.korean_example) clozeCorrectSentenceEl.textContent = `æ­£ç¡®å¥å­: ${currentClozeWordData.korean_example.split('\n')[0]}`;
        clozeCorrectSentenceEl.style.display = 'block';
    }

    function populateStoryWordSelect() {
        storyWordSelectEl.innerHTML = ""; const learnedKeys = Object.keys(learnedWordsData);
        if (learnedKeys.length < 2) { const opt = document.createElement('option'); opt.textContent = "è¯·è‡³å°‘å­¦ä¹ 2ä¸ªå•è¯"; opt.disabled = true; storyWordSelectEl.appendChild(opt); return; }
        learnedKeys.forEach(key => { const opt = document.createElement('option'); opt.value = key; opt.textContent = `${key} (${learnedWordsData[key].chinese})`; storyWordSelectEl.appendChild(opt); });
    }
    async function generateAIStory() {
        const selectedOptions = Array.from(storyWordSelectEl.selectedOptions).map(opt => opt.value);
        if (selectedOptions.length < 2 || selectedOptions.length > 5) { alert("è¯·é€‰æ‹© 2 åˆ° 5 ä¸ªå•è¯æ¥åˆ›ä½œæ•…äº‹ã€‚"); return; }
        storyKoTextEl.textContent = ""; storyZhTextEl.textContent = "";
        aiGeneratedStoryKoBox.classList.add('loading'); aiGeneratedStoryKoBox.style.display = 'block'; aiGeneratedStoryZhBox.style.display = 'none';
        const prompt = `è¯·ç”¨ä»¥ä¸‹éŸ©è¯­å•è¯åˆ›ä½œä¸€ä¸ªéå¸¸ç®€çŸ­ (2-4å¥è¯)ã€ç®€å•ä¸”è¿è´¯çš„å°æ•…äº‹ï¼Œé€‚åˆéŸ©è¯­åˆå­¦è€…é˜…è¯»ã€‚å•è¯åˆ—è¡¨: ${selectedOptions.join("ã€")}ã€‚\nè¯·åœ¨æ•…äº‹åå¦èµ·ä¸€è¡Œï¼Œç”¨ "---ä¸­æ–‡ç¿»è¯‘---" åˆ†éš”åï¼Œæä¾›è¯¥éŸ©è¯­æ•…äº‹çš„ç®€ä½“ä¸­æ–‡ç¿»è¯‘ã€‚`;
        const storyResult = await callGeminiAPI([{text: prompt}], "story_generation", aiGeneratedStoryKoBox);
        if (storyResult && !aiGeneratedStoryKoBox.classList.contains('error')) {
            const parts = storyResult.split("---ä¸­æ–‡ç¿»è¯‘---");
            storyKoTextEl.textContent = parts[0] ? parts[0].trim() : "AIæœªèƒ½ç”ŸæˆéŸ©è¯­æ•…äº‹ã€‚";
            if (parts[1]) { storyZhTextEl.textContent = parts[1].trim(); aiGeneratedStoryZhBox.style.display = 'block'; }
            else { storyZhTextEl.textContent = "AIæœªèƒ½ç”Ÿæˆä¸­æ–‡ç¿»è¯‘ã€‚"; aiGeneratedStoryZhBox.style.display = 'block'; }
        } else if (!storyResult && !aiGeneratedStoryKoBox.classList.contains('error')) { storyKoTextEl.textContent = "AIæ•…äº‹åˆ›ä½œå¤±è´¥ã€‚"; }
    }

    async function generateAIScenario() {
        currentAIScenarioContext = []; aiScenarioDescriptionEl.textContent = "AI æ„æ€æƒ…å¢ƒä¸­...";
        aiScenarioDialogueHistoryEl.innerHTML = ""; aiScenarioDialogueHistoryEl.style.display = 'none';
        userScenarioResponseEl.value = ""; aiScenarioFeedbackEl.textContent = ""; aiScenarioFeedbackEl.style.display = 'none';
        const selectedDifficulty = document.querySelector('input[name="scenario-difficulty"]:checked').value;
        const learnedWordKeys = Object.keys(learnedWordsData);
        const setupPrompt = `ä½ æ˜¯ä¸€ä¸ªéŸ©è¯­å­¦ä¹ åŠ©æ‰‹ï¼Œç°åœ¨è¦ä¸ºæˆ‘åˆ›å»ºä¸€ä¸ªéŸ©è¯­å£è¯­æƒ…æ™¯å¯¹è¯ã€‚
        å¯¹è¯éš¾åº¦çº§åˆ«ä¸º"${selectedDifficulty}"ã€‚
        è¯·ç»™æˆ‘ä¸€ä¸ªç®€çŸ­çš„ä¸­æ–‡åœºæ™¯æè¿°ï¼Œä»¥åŠä½ ï¼ˆä½œä¸ºAIè§’è‰²ï¼‰çš„ç¬¬ä¸€å¥éŸ©è¯­å°è¯ï¼Œå¹¶æ˜ç¡®æŒ‡å‡ºä½ æ‰®æ¼”çš„è§’è‰²ã€‚
        æœ€åï¼Œç»™ç”¨æˆ·ä¸€ä¸ªç”¨ä¸­æ–‡æè¿°çš„ä»»åŠ¡æç¤ºï¼Œå‘Šè¯‰ä»–ä»¬éœ€è¦å¦‚ä½•å¼€å§‹å›åº”ã€‚
        è¯·ç¡®ä¿ä½ çš„éŸ©è¯­å°è¯çš„è¯æ±‡å’Œè¯­æ³•å¤æ‚åº¦ç¬¦åˆ"${selectedDifficulty}"æ°´å¹³ã€‚
        å¦‚æœå¯èƒ½ï¼Œå¯ä»¥åœ¨åœºæ™¯æè¿°æˆ–ä»»åŠ¡æç¤ºä¸­æš—ç¤ºä½¿ç”¨ä¸€äº›å·²å­¦è¯æ±‡ï¼ˆä¾‹å¦‚ï¼š${learnedWordKeys.slice(0, 3).join(", ") || "ä¸€äº›åŸºç¡€è¯æ±‡"}ï¼‰ã€‚

        ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œå¹¶ç”¨ "---" åˆ†éš”ï¼š
        åœºæ™¯æè¿° (ä¸­æ–‡)
        ---
        AIè§’è‰²: éŸ©è¯­å°è¯
        ---
        ç”¨æˆ·ä»»åŠ¡æç¤º (ä¸­æ–‡)`;

        const scenarioData = await callGeminiAPI([{ role: "user", parts: [{ text: setupPrompt }] }], "scenario_setup", aiScenarioDescriptionEl);

        if (scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) {
            const parts = scenarioData.split("---").map(p => p.trim());
            if (parts.length >= 3) {
                aiScenarioDescriptionEl.textContent = `æƒ…æ™¯ (${selectedDifficulty}): ${parts[0]}`;
                const aiFullLine = parts[1];
                const aiTextMatch = aiFullLine.match(/^(.*?):\s*(.*)$/);
                let aiRole = "AI";
                let aiDialogue = aiFullLine;

                if (aiTextMatch && aiTextMatch.length >= 3) {
                    aiRole = aiTextMatch[1].trim();
                    aiDialogue = aiTextMatch[2].trim();
                } else {
                    aiDialogue = aiFullLine;
                }

                currentAIScenarioContext.push({ role: "model", parts: [{ text: aiDialogue }] });
                updateScenarioDialogueHistory();
                aiScenarioDialogueHistoryEl.style.display = 'block';
                userScenarioResponseEl.placeholder = `ä½ çš„ä»»åŠ¡: ${parts[2]}`;

            } else { aiScenarioDescriptionEl.textContent = "AIåœºæ™¯ç”Ÿæˆæ ¼å¼é”™è¯¯ã€‚è¯·é‡è¯•ã€‚"; }
        } else if (!scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) { aiScenarioDescriptionEl.textContent = "AIåœºæ™¯ç”Ÿæˆå¤±è´¥ã€‚"; }
    }

    async function submitScenarioResponse() {
        const userResponse = userScenarioResponseEl.value.trim();
        if (!userResponse) {
            aiScenarioFeedbackEl.textContent = "è¯·è¾“å…¥æ‚¨çš„å›åº”ã€‚";
            aiScenarioFeedbackEl.style.color = "var(--warning-color)";
            aiScenarioFeedbackEl.style.display = 'block';
            return;
        }

        currentAIScenarioContext.push({ role: "user", parts: [{ text: userResponse }] });
        updateScenarioDialogueHistory();
        userScenarioResponseEl.value = "";

        aiScenarioFeedbackEl.textContent = "AI æ€è€ƒå›åº”ä¸­...";
        aiScenarioFeedbackEl.style.display = 'block';
        aiScenarioFeedbackEl.classList.remove('error', 'success');

        // Create the full prompt for the model to continue the conversation
        const fullPromptContents = [
            { role: "user", parts: [{ text: "ä½ æ˜¯ä¸€ä¸ªéŸ©è¯­å­¦ä¹ åŠ©æ‰‹ã€‚æˆ‘ä»¬æ­£åœ¨è¿›è¡Œæƒ…æ™¯å¯¹è¯ç»ƒä¹ ã€‚ä½ çš„ä»»åŠ¡æ˜¯è¯„ä¼°ç”¨æˆ·çš„éŸ©è¯­å›åº”ï¼Œç„¶åä»¥ä½ çš„è§’è‰²ç»§ç»­å¯¹è¯ã€‚è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œå…ˆæ˜¯ä¸­æ–‡åé¦ˆï¼Œç„¶åç”¨ '---åé¦ˆ---' åˆ†éš”ï¼Œæœ€åæ˜¯AIçš„éŸ©è¯­å›åº”ã€‚å¦‚æœå¯¹è¯å¯ä»¥è‡ªç„¶ç»“æŸï¼Œå¯ä»¥è¯´ä¸€å¥éŸ©è¯­ç»“æŸè¯­ï¼ˆä¾‹å¦‚ï¼šê³ ë§™ìŠµë‹ˆë‹¤. ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”.ï¼‰ã€‚å¦‚æœç”¨æˆ·è¡¨è¾¾ä¸æ¸…æˆ–ä»»åŠ¡æœªå®Œæˆï¼Œå¯ä»¥å°è¯•å¼•å¯¼æˆ–æé—®ã€‚" }] },
            ...currentAIScenarioContext
        ];

        const aiFullResponse = await callGeminiAPI(fullPromptContents, "scenario_continue");

        if (aiFullResponse) {
            const parts = aiFullResponse.split("---åé¦ˆ---");
            const feedbackText = parts[0] ? parts[0].trim() : "AI æœªæä¾›æ˜ç¡®åé¦ˆã€‚";
            const aiNextKoreanUtterance = parts[1] ? parts[1].trim() : "ìŒ... ë‹¤ì‹œ í•œë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”? (å—¯...èƒ½å†è¯´ä¸€éï¼Ÿ)";

            aiScenarioFeedbackEl.textContent = `AIåé¦ˆ: ${feedbackText}`;
            aiScenarioFeedbackEl.style.color = "var(--wechat-text-secondary)";

            currentAIScenarioContext.push({ role: "model", parts: [{ text: aiNextKoreanUtterance }] });
            updateScenarioDialogueHistory();

            if (aiNextKoreanUtterance.includes("ê°ì‚¬í•©ë‹ˆë‹¤") || aiNextKoreanUtterance.includes("ì•ˆë…•íˆ ê°€ì„¸ìš”") || currentAIScenarioContext.length > 8) {
                aiScenarioFeedbackEl.textContent += "\nå¯¹è¯ç»“æŸã€‚";
            }
        } else {
            aiScenarioFeedbackEl.textContent = "AIå›åº”ç”Ÿæˆå¤±è´¥ã€‚";
            aiScenarioFeedbackEl.classList.add('error');
            // Revert the last user utterance if AI failed to respond
            currentAIScenarioContext.pop();
            updateScenarioDialogueHistory(); // Re-render to reflect the pop
        }
    }
    function updateScenarioDialogueHistory() {
        aiScenarioDialogueHistoryEl.innerHTML = currentAIScenarioContext.map(turn => {
            const speaker = turn.role === 'user' ? 'æ‚¨' : 'AI';
            const cssClass = turn.role === 'user' ? 'user-utterance' : 'ai-utterance';
            return `<p class="${cssClass}"><strong>${speaker}:</strong> ${turn.parts[0].text.replace(/\n/g, "<br>")}</p>`;
        }).join('');
        aiScenarioDialogueHistoryEl.scrollTop = aiScenarioDialogueHistoryEl.scrollHeight;
    }

    async function correctEssay() {
        const essayText = essayInputEl.value.trim();
        if (!essayText) {
            essayFeedbackAreaEl.textContent = "è¯·è¾“å…¥æ‚¨è¦æ‰¹æ”¹çš„éŸ©è¯­ä½œæ–‡ã€‚";
            essayFeedbackAreaEl.classList.remove('loading', 'error');
            essayFeedbackAreaEl.style.display = 'block';
            return;
        }
        const prompt = `è¯·ä½œä¸ºä¸€åèµ„æ·±çš„éŸ©è¯­è€å¸ˆï¼Œä¸ºä»¥ä¸‹éŸ©è¯­ä½œæ–‡è¿›è¡Œæ‰¹æ”¹å’Œè¯„ä»·ã€‚è¯·æä¾›ï¼š
        1. **æ•´ä½“è¯„ä»·** (Overall Assessment): ç®€è¦è¯„ä»·ä½œæ–‡çš„ä¼˜ç‚¹å’Œä¸è¶³ã€‚
        2. **è¯­æ³•ä¿®æ­£ä¸è§£é‡Š** (Grammar Correction & Explanation): åˆ—å‡ºå…·ä½“çš„è¯­æ³•é”™è¯¯å¹¶æä¾›æ­£ç¡®ç‰ˆæœ¬ï¼Œè§£é‡Šä¸ºä»€ä¹ˆæ˜¯é”™è¯¯çš„ã€‚
        3. **è¯æ±‡ç”¨æ³•å»ºè®®** (Vocabulary Usage Suggestions): é’ˆå¯¹ä¸æ°å½“çš„è¯æ±‡æä¾›æ›¿æ¢å»ºè®®ï¼Œæˆ–æŒ‡å‡ºè¯æ±‡ä½¿ç”¨çš„äº®ç‚¹ã€‚
        4. **è¡¨è¾¾æµç•…åº¦ä¸è‡ªç„¶åº¦** (Fluency & Naturalness): é’ˆå¯¹ä¸è‡ªç„¶çš„è¡¨è¾¾è¿›è¡Œæ¶¦è‰²ã€‚
        5. **TOPIKç›¸å…³å»ºè®®** (TOPIK-specific Advice): å¦‚æœæœ‰ï¼Œæä¾›é’ˆå¯¹TOPIKè€ƒè¯•çš„å†™ä½œå»ºè®®ã€‚
        6. **ä¿®è®¢åçš„ä½œæ–‡** (Revised Essay): æä¾›ä¸€ä¸ªå®Œæ•´çš„ã€ä¿®æ­£åçš„éŸ©è¯­ä½œæ–‡ç‰ˆæœ¬ã€‚
        è¯·ç¡®ä¿åé¦ˆè¯¦ç»†ã€æœ‰å»ºè®¾æ€§ï¼Œå¹¶ä¸”æ˜“äºç†è§£ã€‚
        ä½œæ–‡å†…å®¹:
        "${essayText}"`;

        const feedback = await callGeminiAPI([{text: prompt}], "essay_correction", essayFeedbackAreaEl);
        if (feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.innerHTML = feedback.replace(/\n/g, '<br>');
            essayFeedbackAreaEl.style.display = 'block';
        } else if (!feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.textContent = "AIæ‰¹æ”¹ä½œæ–‡å¤±è´¥æˆ–æœªè¿”å›å†…å®¹ã€‚";
            essayFeedbackAreaEl.style.display = 'block';
        }
    }

    async function generateMultipleChoiceQuestions() {
        const category = document.querySelector('input[name="mc-category"]:checked').value;
        const count = parseInt(mcCountInputEl.value, 10);

        if (count < 1 || count > 5) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">è¯·è¾“å…¥é—®é¢˜æ•°é‡ï¼ˆ1-5ï¼‰ã€‚</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
            return;
        }

        mcQuestionsAreaEl.innerHTML = `<p style="text-align:center; color:var(--ai-accent-color); font-style:italic;">AI æ­£åœ¨ç”Ÿæˆé¢˜ç›®...</p>`;
        submitMcAnswersBtnEl.style.display = 'none';
        currentMCQuestions = [];

        let prompt = "";
        if (category === "grammar") {
            prompt = `è¯·ç”Ÿæˆ ${count} é“éŸ©è¯­è¯­æ³•é€‰æ‹©é¢˜ï¼Œé€‚åˆTOPIKåˆçº§æˆ–ä¸­çº§æ°´å¹³çš„å­¦ä¹ è€…ã€‚
            æ¯é“é¢˜åŒ…æ‹¬ï¼š
            1. é¢˜ç›® (éŸ©è¯­å¥å­ï¼Œå…¶ä¸­æŸä¸ªè¯­æ³•ç‚¹è¢«æŒ–ç©ºæˆ–éœ€è¦é€‰æ‹©æ­£ç¡®å½¢å¼)
            2. å››ä¸ªé€‰é¡¹ (A, B, C, Dï¼ŒéŸ©è¯­è¯­æ³•ç‚¹æˆ–è¯æ±‡)
            3. æ­£ç¡®ç­”æ¡ˆ (å­—æ¯)
            4. è¯¦ç»†çš„ä¸­æ–‡è§£é‡Š (ä¸ºä»€ä¹ˆæ­£ç¡®ï¼Œä¸ºä»€ä¹ˆå…¶ä»–é€‰é¡¹é”™è¯¯ï¼Œå¯ä»¥æ‰©å±•ç›¸å…³è¯­æ³•çŸ¥è¯†ç‚¹)

            è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œæ¯é“é¢˜ä¹‹é—´ç”¨ "---" åˆ†éš”ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨ "&&&" åˆ†éš”ï¼š
            é¢˜ç›®&&&A. é€‰é¡¹A&&&B. é€‰é¡¹B&&&C. é€‰é¡¹C&&&D. é€‰é¡¹D&&&æ­£ç¡®ç­”æ¡ˆ: X&&&è§£é‡Š: ä¸­æ–‡è§£é‡Š
            ä¾‹å¦‚ï¼š
            ì €ëŠ” ì£¼ë§ì— ì˜í™”____ ë³¼ ê±°ì˜ˆìš”.&&&A. -ë¥¼&&&B. -ì€&&&C. -ì™€&&&D. -ì´&&&æ­£ç¡®ç­”æ¡ˆ: A&&&è§£é‡Š: 'ì˜í™”'ëŠ” ëª©ì ì–´ë¡œ, 'ë³´ë‹¤' ë™ì‚¬ì™€ í•¨ê»˜ ì“°ì¼ ë•Œ ëª©ì ê²© ì¡°ì‚¬ '-ë¥¼'ì´ ë¶™ìŠµë‹ˆë‹¤ã€‚
            ---
            [ä¸‹ä¸€é“é¢˜ç›®]`;
        } else if (category === "proverb") {
            prompt = `è¯·ç”Ÿæˆ ${count} é“éŸ©è¯­è°šè¯­/ä¿—è¯­é€‰æ‹©é¢˜ï¼Œé€‚åˆTOPIKä¸­çº§æˆ–é«˜çº§æ°´å¹³çš„å­¦ä¹ è€…ã€‚
            æ¯é“é¢˜åŒ…æ‹¬ï¼š
            1. é¢˜ç›® (ä¸€ä¸ªéŸ©è¯­è°šè¯­æˆ–ä¿—è¯­çš„æŒ–ç©ºå½¢å¼ï¼Œæˆ–ç»™å‡ºæƒ…å¢ƒé€‰æ‹©è°šè¯­)
            2. å››ä¸ªé€‰é¡¹ (A, B, C, Dï¼ŒéŸ©è¯­è°šè¯­/ä¿—è¯­æˆ–å…¶éƒ¨åˆ†)
            3. æ­£ç¡®ç­”æ¡ˆ (å­—æ¯)
            4. è¯¦ç»†çš„ä¸­æ–‡è§£é‡Š (è°šè¯­/ä¿—è¯­çš„å­—é¢æ„æ€å’Œå¼•ç”³ä¹‰ï¼Œä»¥åŠä½¿ç”¨æƒ…å¢ƒ)

            è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œæ¯é“é¢˜ä¹‹é—´ç”¨ "---" åˆ†éš”ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨ "&&&" åˆ†éš”ï¼š
            é¢˜ç›®&&&[æŒ–ç©ºæˆ–æƒ…å¢ƒ]____&&&A. é€‰é¡¹A&&&B. é€‰é¡¹B&&&C. é€‰é¡¹C&&&D. é€‰é¡¹D&&&æ­£ç¡®ç­”æ¡ˆ: X&&&è§£é‡Š: ä¸­æ–‡è§£é‡Š
            ä¾‹å¦‚ï¼š
            ëŠ¦ê²Œ ë°°ìš´ ë„ë‘‘ì§ˆì´ ____ ë‚  ìƒˆëŠ” ì¤„ ëª¨ë¥¸ë‹¤.&&&A. ë°¤&&&B. ë‚®&&&C. ì•„ì¹¨&&&D. ì €ë…&&&æ­£ç¡®ç­”æ¡ˆ: A&&&è§£é‡Š: 'ëŠ¦ê²Œ ë°°ìš´ ë„ë‘‘ì§ˆì´ ë°¤ ìƒˆëŠ” ì¤„ ëª¨ë¥¸ë‹¤'ëŠ” ëŠ¦ê²Œ ì‹œì‘í•œ ì¼ì´ ì¬ë¯¸ìˆì–´ì„œ ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥¸ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤ã€‚
            ---
            [ä¸‹ä¸€é“é¢˜ç›®]`;
        }


        const rawQuestions = await callGeminiAPI([{text: prompt}], "mc_generation", mcQuestionsAreaEl);

        if (rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            const questionBlocks = rawQuestions.split('---').filter(block => block.trim() !== '');
            let htmlContent = '';
            questionBlocks.forEach((block, index) => {
                const parts = block.split('&&&').map(p => p.trim());
                if (parts.length >= 6) {
                    const questionText = parts[0];
                    const options = parts.slice(1, 5);
                    const correctAnswerMatch = parts[5].match(/æ­£ç¡®ç­”æ¡ˆ:\s*([A-D])/i);
                    const explanationText = parts[6] || '';

                    const correctAnswer = correctAnswerMatch ? correctAnswerMatch[1].toUpperCase() : '';

                    currentMCQuestions.push({
                        id: `q${index}`,
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        explanation: explanationText,
                        userAnswer: null
                    });

                    htmlContent += `<div class="mc-question" data-question-id="q${index}">
                        <p>${index + 1}. ${questionText}</p>
                        <div class="mc-options">`;
                    options.forEach((opt, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex);
                        htmlContent += `<label>
                            <input type="radio" name="question-${index}" value="${optionLetter}">
                            ${opt}
                        </label>`;
                    });
                    htmlContent += `</div>
                        <div class="mc-feedback" id="feedback-q${index}"></div>
                        <div class="mc-explanation" id="explanation-q${index}" style="display: none;">${explanationText}</div>
                    </div>`;
                }
            });

            if (currentMCQuestions.length > 0) {
                mcQuestionsAreaEl.innerHTML = htmlContent;
                submitMcAnswersBtnEl.style.display = 'block';
            } else {
                mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆé¢˜ç›®ã€‚è¯·å°è¯•æ›´æ”¹è¯é¢˜æˆ–æ•°é‡ã€‚</p>`;
            }

        } else if (!rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AIé¢˜ç›®ç”Ÿæˆå¤±è´¥ã€‚</p>`;
        }
    }

    function submitMultipleChoiceAnswers() {
        let allCorrect = true;
        currentMCQuestions.forEach(q => {
            const selectedOption = document.querySelector(`input[name="question-${q.id.replace('q', '')}"]:checked`);
            const feedbackEl = document.getElementById(`feedback-${q.id}`);
            const explanationEl = document.getElementById(`explanation-${q.id}`);

            if (!selectedOption) {
                feedbackEl.textContent = "è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆã€‚";
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'none';
                return;
            }

            q.userAnswer = selectedOption.value;
            if (q.userAnswer === q.correctAnswer) {
                feedbackEl.textContent = "å›ç­”æ­£ç¡®ï¼ğŸ‰";
                feedbackEl.className = 'mc-feedback correct';
                explanationEl.style.display = 'block';
            } else {
                feedbackEl.textContent = `å›ç­”é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ ${q.correctAnswer}ã€‚`;
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'block';
            }
        });

        if (currentMCQuestions.length > 0 && allCorrect) {
            alert("æ­å–œï¼æ‰€æœ‰é¢˜ç›®éƒ½ç­”å¯¹äº†ï¼");
        }
    }

    function setActivePage(pageId, title) {
        contentPages.forEach(page => page.classList.toggle('active', page.id === pageId));
        tabItems.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
        appHeaderTitleEl.textContent = title;
        document.querySelector('.wechat-content').scrollTop = 0;

        if (pageId === 'page-ai-functions') {
            showAIFunctionsMenu();
        } else {
            pageAiFunctionsEl.classList.remove('menu-active', 'sub-feature-active');
            aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        }

        if (pageId === 'page-settings') {
             showSettingsMainMenu();
        } else {
            pageStudyGoalsEl.classList.remove('active');
        }


        if (pageId === 'page-review-plan') {
            renderReviewList('all');
            updateActiveFilterButton('all');
        } else if (pageId === 'page-memorize') {
            loadWordForMemorizePage(true); // Always force reload current word when navigating to memorize page
        } else if (pageId === 'page-study-goals') {
            renderCalendar();
        }
        if (pageId !== 'page-about') {
            pageAboutEl.classList.remove('active');
        }
    }

    function showAIFunctionSubFeature(featureId, title) {
        pageAiFunctionsEl.classList.remove('menu-active');
        pageAiFunctionsEl.classList.add('sub-feature-active');

        aiSubFeatureSections.forEach(section => {
            section.classList.toggle('active', section.id === featureId);
        });
        appHeaderTitleEl.textContent = title;

        if (featureId === 'feature-cloze') {
            generateAIClozeTest();
        } else if (featureId === 'feature-story') {
            populateStoryWordSelect();
        } else if (featureId === 'feature-scenario') {
            aiScenarioDescriptionEl.textContent = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆå¯¹è¯æƒ…å¢ƒã€‚";
            aiScenarioDialogueHistoryEl.innerHTML = "";
            aiScenarioDialogueHistoryEl.style.display = 'none';
            userScenarioResponseEl.value = "";
            aiScenarioFeedbackEl.textContent = "";
            aiScenarioFeedbackEl.style.display = 'none';
            currentAIScenarioContext = [];
        } else if (featureId === 'feature-essay-correction') {
             essayInputEl.value = "";
             essayFeedbackAreaEl.style.display = 'none';
        } else if (featureId === 'feature-mc-questions') {
            mcQuestionsAreaEl.innerHTML = `<p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆé¢˜ç›®ã€‚</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
        } else if (featureId === 'page-image-recognition') {
            imagePreviewRecEl.src = '';
            imagePreviewRecEl.style.display = 'none';
            recognizeImageKoreanBtnEl.disabled = true;
            imageRecognizedKoTextEl.parentElement.style.display = 'none';
            imageRecognizedZhTextEl.parentElement.style.display = 'none';
            imageUploadInputRecEl.value = '';
        } else if (featureId === 'page-local-video') {
            videoPlayerEl.src = '';
            videoPlayerEl.style.display = 'none';
            videoFileNameDisplayEl.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            videoUploadInputEl.value = '';
        }
    }

    function showAIFunctionsMenu() {
        pageAiFunctionsEl.classList.add('menu-active');
        pageAiFunctionsEl.classList.remove('sub-feature-active');
        aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        appHeaderTitleEl.textContent = "AI åŠŸèƒ½";
    }

    function showSettingsMainMenu() {
        document.getElementById('page-settings').classList.add('active');
        document.getElementById('page-settings').classList.remove('sub-page-active');
        pageStudyGoalsEl.classList.remove('active');
        appHeaderTitleEl.textContent = "æˆ‘";
    }

    function showStudyGoalsPage() {
        document.getElementById('page-settings').classList.remove('active');
        pageStudyGoalsEl.classList.add('active');
        appHeaderTitleEl.textContent = "å­¦ä¹ ç›®æ ‡";
        renderCalendar();
    }

    function switchWordList(listName) {
        if (currentWordListName === listName) return;

        currentWordListName = listName;
        wordList = allWordLists[currentWordListName];
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);

        loadLearnedWords();

        currentWordIndex = 0;
        loadWordForMemorizePage(true); // Force reload to start from beginning of new list
        if (isCardFlipped) flipCard(false);

        if (document.getElementById('page-review-plan').classList.contains('active')) {
            renderReviewList(currentReviewFilter);
        }
        alert(`å·²åˆ‡æ¢åˆ°â€œ${wordListSelectEl.options[wordListSelectEl.selectedIndex].text}â€å­—åº“ï¼`);
    }

    // Modified loadWord function
    function loadWord(indexToLoad = currentWordIndex, shouldSpeak = false) {
        console.log("loadWord called with indexToLoad:", indexToLoad);

        if (!wordList || wordList.length === 0) {
            koreanWordEl.textContent = "æš‚æ— å•è¯å¯å­¦/å¤ä¹ ã€‚";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = '0'; // Ensure total is 0 if list is empty
            return;
        }

        // Ensure index is within bounds
        if (indexToLoad < 0 || indexToLoad >= wordList.length) {
            console.warn("Attempted to load word at invalid index:", indexToLoad);
            // Fallback to 0 if out of bounds, or handle gracefully (e.g., stay on current)
            indexToLoad = 0;
        }

        const wordToLoad = wordList[indexToLoad];
        if (!wordToLoad) {
            console.error("No word found at index:", indexToLoad);
            koreanWordEl.textContent = "æ— æ³•è½½å…¥å•è¯ã€‚";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = (indexToLoad + 1).toString();
            totalWordsEl.textContent = wordList.length;
            return;
        }

        currentWordIndex = indexToLoad; // Update global currentWordIndex
        console.log("Loading word:", wordToLoad.korean, "at index:", currentWordIndex);

        koreanWordEl.textContent = wordToLoad.korean;
        pronunciationEl.textContent = wordToLoad.pronunciation || "";
        chineseTranslationEl.textContent = wordToLoad.chinese;
        if (wordToLoad.korean_example && wordToLoad.chinese_example) {
            koreanExampleEl.innerHTML = `ğŸ‡°ğŸ‡· ${wordToLoad.korean_example.replace(/\n/g, '<br>')}`;
            chineseExampleEl.innerHTML = `ğŸ‡¨ğŸ‡³ ${wordToLoad.chinese_example.replace(/\n/g, '<br>')}`;
            exampleSentenceEl.style.display = 'block';
        } else {
            exampleSentenceEl.style.display = 'none';
        }

        // Always flip to front when loading new word by default
        if (isCardFlipped) {
            flipCard(false);
        }

        // Hide AI expansion areas
        aiHelperBoxEl.style.display = 'none'; aiHelperContentEl.textContent = "ç‚¹å‡»ä¸‹æ–¹ \"AIæç¤º\" è·å–ã€‚";
        aiSentenceGeneratorBoxEl.style.display = 'none'; aiGeneratedSentencesEl.innerHTML = "";
        aiUsageNotesBoxEl.style.display = 'none'; aiUsageNotesContentEl.textContent = "";

        updateProgress();
        if (shouldSpeak && autoPronounceNextCheckbox && autoPronounceNextCheckbox.checked) {
            setTimeout(() => speakKoreanWord(), 100);
        }
    }

    function flipCard(forceState = null) {
        if (!wordCardEl) return;
        isCardFlipped = (forceState !== null) ? forceState : !isCardFlipped;
        wordCardEl.classList.toggle('is-flipped', isCardFlipped);
    }

    function speakKoreanWord(event) {
        if (event) event.stopPropagation();
        if (!synth || !wordList[currentWordIndex]) {
             console.log("Speech synthesis unavailable or no current word.");
             return;
        }
        if (synth.speaking) synth.cancel();
        const utterThis = new SpeechSynthesisUtterance(wordList[currentWordIndex].korean);
        let koreanVoice = synth.getVoices().find(v => v.lang === 'ko-KR' || v.lang.startsWith('ko'));
        if (koreanVoice) {
            utterThis.voice = koreanVoice;
        } else {
            utterThis.lang = 'ko-KR'; // Fallback to language code if no specific voice found
        }
        utterThis.rate = 0.9;
        utterThis.pitch = 1;
        synth.speak(utterThis);
        console.log("Speaking word:", wordList[currentWordIndex].korean);
    }

    // Modified nextWord function
    function nextWord() {
        console.log("Next word clicked. Current index:", currentWordIndex);
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex + 1) % wordList.length;
        loadWord(currentWordIndex, true); // Pass true to shouldSpeak
    }

    // Modified prevWord function
    function prevWord() {
        console.log("Prev word clicked. Current index BEFORE update:", currentWordIndex);
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex - 1 + wordList.length) % wordList.length;
        console.log("Prev word clicked. New index:", currentWordIndex);
        loadWord(currentWordIndex, true); // Pass true to shouldSpeak
    }


    function calculateNextReviewTimestamp(reviewCount, lastSeenTimestamp) {
        const now = Date.now();
        lastSeenTimestamp = lastSeenTimestamp || now;

        let intervalDays;
        if (reviewCount === 0) {
            intervalDays = 0;
        } else if (reviewCount === 1) {
            intervalDays = srsIntervals[0];
        } else if (reviewCount <= srsIntervals.length) {
            intervalDays = srsIntervals[reviewCount - 1];
        } else {
            intervalDays = srsIntervals[srsIntervals.length - 1] * Math.pow(1.8, (reviewCount - srsIntervals.length));
        }
        return lastSeenTimestamp + (intervalDays * 24 * 60 * 60 * 1000);
    }

    function markAsKnown() {
        if (!wordList[currentWordIndex]) {
            console.warn("No word to mark as known at current index.");
            return;
        }
        const wordKey = wordList[currentWordIndex].korean;
        const currentTimestamp = Date.now();

        let wordEntry = learnedWordsData[wordKey];
        const isNewWord = !wordEntry;

        if (isNewWord) {
            wordEntry = {
                korean: wordList[currentWordIndex].korean,
                chinese: wordList[currentWordIndex].chinese,
                pronunciation: wordList[currentWordIndex].pronunciation,
                firstLearned: currentTimestamp,
                lastSeen: currentTimestamp,
                reviewCount: 1,
            };
            // dailyNewWordsLearnedToday++; // This increment is handled by checkDailyStudyGoal to be more precise.
        } else {
            wordEntry.reviewCount = (wordEntry.reviewCount || 0) + 1;
            wordEntry.lastSeen = currentTimestamp;
        }
        wordEntry.nextReviewDue = calculateNextReviewTimestamp(wordEntry.reviewCount, wordEntry.lastSeen);
        learnedWordsData[wordKey] = wordEntry;
        saveLearnedWords();

        console.log(`å·²æ ‡è®°: ${wordKey}, æ¬¡æ•°: ${wordEntry.reviewCount}, ä¸‹æ¬¡: ${new Date(wordEntry.nextReviewDue).toLocaleDateString()}, ä»Šæ—¥æ–°è¯: ${dailyNewWordsLearnedToday}/${dailyNewWordsLimit}`);

        checkDailyStudyGoal(); // åœ¨æ ‡è®°ä¸ºå·²è®¤è¯†åæ£€æŸ¥å­¦ä¹ ç›®æ ‡
        loadWordForMemorizePage(true); // Force reload and also trigger speak logic
    }

    function updateProgress() {
        if (!wordList || wordList.length === 0 || !progressBarEl || !currentWordIndexEl || !totalWordsEl) return;
        const percentage = ((currentWordIndex + 1) / wordList.length) * 100;
        progressBarEl.style.width = percentage + '%';
        currentWordIndexEl.textContent = currentWordIndex + 1;
        totalWordsEl.textContent = wordList.length;
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function jumpToWordForReview(wordKey) {
        const wordIndexInList = wordList.findIndex(w => w.korean === wordKey);
        if (wordIndexInList !== -1) {
            setActivePage('page-memorize', 'èƒŒå•è¯');
            currentWordIndex = wordIndexInList; // Update currentWordIndex for the memorize page
            loadWord(currentWordIndex, true); // Use the general loadWord with the specific index and speak
        } else {
            alert(`å•è¯ "${wordKey}" åœ¨ç›®å‰å­—åº“ä¸­æœªæ‰¾åˆ°ã€‚`);
        }
    }

    let currentReviewFilter = 'all';
    function renderReviewList(filter = 'all') {
        currentReviewFilter = filter;
        if (!reviewListContainerEl || !learnedWordsData) return;
        reviewListContainerEl.innerHTML = '';

        const now = Date.now();
        let wordsToReview = Object.values(learnedWordsData);

        let dueCount = 0;
        wordsToReview.forEach(word => {
            if (word.nextReviewDue <= now) dueCount++;
        });
        if (totalLearnedCountEl) totalLearnedCountEl.textContent = Object.keys(learnedWordsData).length;
        if (dueTodayCountEl) dueTodayCountEl.textContent = dueCount;


        if (filter === 'due') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue <= now);
        } else if (filter === 'overdue') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue < (now - 24 * 60 * 60 * 1000));
        }

        wordsToReview.sort((a, b) => (a.nextReviewDue || 0) - (b.nextReviewDue || 0));

        if (wordsToReview.length === 0) {
            reviewListContainerEl.innerHTML = `<p class="no-reviews">${filter === 'all' ? 'æš‚æ— å­¦ä¹ è®°å½•ã€‚' : 'ç›®å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚'}</p>`;
            return;
        }

        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.paddingLeft = '0';

        wordsToReview.forEach(word => {
            const li = document.createElement('li');
            li.className = 'review-list-item';
            li.dataset.wordKey = word.korean;

            const wordInfoDiv = document.createElement('div');
            wordInfoDiv.className = 'review-word-info';
            wordInfoDiv.innerHTML = `<div class="word">${word.korean}</div><div class="meaning">${word.chinese || 'N/A'}</div>`;

            const reviewStatusDiv = document.createElement('div');
            reviewStatusDiv.className = 'review-status';
            let nextReviewText = formatDate(word.nextReviewDue);
            let statusClass = '';
            if (word.nextReviewDue <= now) {
                statusClass = 'overdue';
                nextReviewText = "ç«‹å³å¤ä¹ ";
            } else if (word.nextReviewDue <= now + 2 * 24 * 60 * 60 * 1000) {
                statusClass = 'due-soon';
            }

            reviewStatusDiv.innerHTML = `<div class="next-review">ä¸‹æ¬¡å¤ä¹ : <span class="date ${statusClass}">${nextReviewText}</span></div><div style="font-size:0.75em; color: #aaa;">ä¸Šæ¬¡: ${formatDate(word.lastSeen)} (æ¬¡æ•°: ${word.reviewCount || 0})</div>`;

            li.appendChild(wordInfoDiv);
            li.appendChild(reviewStatusDiv);
            ul.appendChild(li);
        });
        reviewListContainerEl.appendChild(ul);
    }

    function updateActiveFilterButton(activeFilter) { filterButtonsReview.forEach(button => button.classList.toggle('active', button.id === `filter-${activeFilter}`)); }

    function showAboutPage() {
        setActivePage('page-about', 'å…³äºæœ¬åº”ç”¨');
    }

    function initializeApp() {
        currentUsernameDisplayEl.textContent = localStorage.getItem('lastLoggedInUser') || "å­¦ä¹ è€…";

        loadLearnedWords();
        applySavedSettings();

        if (dailyStudyAmountInput) {
            dailyStudyAmountInput.addEventListener('change', (e) => {
                let value = parseInt(e.target.value, 10);
                if (isNaN(value) || value < 1) value = 1;
                if (value > 50) value = 50;
                dailyNewWordsLimit = value;
                localStorage.setItem('dailyNewWordsLimit', dailyNewWordsLimit);
                e.target.value = dailyNewWordsLimit;
                checkDailyStudyGoal(); // æ›´æ–°ç›®æ ‡åæ£€æŸ¥æ˜¯å¦å·²è¾¾æˆ
            });
        }

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            console.warn("è­¦å‘Š: Gemini API å¯†é’¥æ— æ•ˆæˆ–æœªåœ¨ JavaScript ä¸­æ­£ç¡®è®¾ç½®ã€‚AI åŠŸèƒ½å°†å—é™ã€‚");
            const aiButtons = document.querySelectorAll('.ai-btn, .generic-button, .ai-action-btn');
            aiButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = 0.5; btn.title = "API Key æœªè®¾ç½®æˆ–æ— æ•ˆ"; btn.style.cursor = "not-allowed"; });

            const aiSections = [
                document.getElementById('page-translate'),
                document.getElementById('page-ai-dictionary'),
                document.getElementById('page-image-recognition'),
                document.getElementById('feature-cloze'),
                document.getElementById('feature-story'),
                document.getElementById('feature-scenario'),
                document.getElementById('feature-essay-correction'),
                document.getElementById('feature-mc-questions')
            ];

            aiSections.forEach(section => {
                if (section && !section.querySelector('.api-error-message')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'var(--danger-color)';
                    errorDiv.style.fontWeight = 'bold';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.marginBottom = '10px';
                    errorDiv.className = 'api-error-message';
                    errorDiv.textContent = 'ğŸš« AI åŠŸèƒ½å—é™ï¼šGemini API å¯†é’¥æ— æ•ˆæˆ–æœªè®¾ç½®ã€‚';
                    section.querySelector('.section-container')?.prepend(errorDiv) || section.prepend(errorDiv);
                }
            });
        }

        loadWordForMemorizePage(true); // Initial load with speak enabled

        if(wordCardEl) {
            wordCardEl.addEventListener('click', (event) => {
                if (event.target.closest('.pronounce-btn') || event.target.closest('.ai-btn') || event.target.tagName === 'A') return;
                flipCard();
            });
        }

        if(pronounceBtnEl) {
            pronounceBtnEl.addEventListener('click', speakKoreanWord);
        }

        document.getElementById('prev-word-btn').addEventListener('click', prevWord);
        document.getElementById('next-word-btn').addEventListener('click', nextWord);
        document.getElementById('mark-known-btn').addEventListener('click', markAsKnown);

        document.getElementById('ai-tip-btn').addEventListener('click', getAITipForWord);
        document.getElementById('ai-sentence-btn').addEventListener('click', getAISentencesForWord);
        document.getElementById('ai-usage-btn').addEventListener('click', getAIUsageNotesForWord);

        if(reviewListContainerEl) {
            reviewListContainerEl.addEventListener('click', (event) => {
                const listItem = event.target.closest('.review-list-item');
                if (listItem && listItem.dataset.wordKey) {
                    jumpToWordForReview(listItem.dataset.wordKey);
                }
            });
        }

        if(doTranslateAutoBtnEl){ doTranslateAutoBtnEl.addEventListener('click', translateAutoDetect); }
        if(searchDictionaryBtnEl){
            searchDictionaryBtnEl.addEventListener('click', searchAIDictionary);
            koreanWordInputEl.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchAIDictionary(); });
        }
        if(imageUploadInputRecEl){
            imageUploadInputRecEl.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 4 * 1024 * 1024) { alert("å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 4MB çš„å›¾ç‰‡ã€‚"); imageUploadInputRecEl.value = ""; return; }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreviewRecEl.src = e.target.result; imagePreviewRecEl.style.display = 'block';
                        uploadedImageBase64Rec = e.target.result.split(',')[1]; uploadedImageMimeTypeRec = file.type;
                        recognizeImageKoreanBtnEl.disabled = false;
                        imageRecognizedKoTextEl.parentElement.style.display = 'none';
                        imageRecognizedZhTextEl.parentElement.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        if(recognizeImageKoreanBtnEl) { recognizeImageKoreanBtnEl.addEventListener('click', generateImageRecognition); }
        if (videoUploadInputEl) { videoUploadInputEl.addEventListener('change', handleVideoUpload); }
        if(generateClozeBtnEl){ generateClozeBtnEl.addEventListener('click', generateAIClozeTest); }
        if(submitClozeBtnEl){ submitClozeBtnEl.addEventListener('click', submitClozeAnswer); }
        if(generateStoryBtnEl){ generateStoryBtnEl.addEventListener('click', generateAIStory); }
        if(generateScenarioBtnEl){ generateScenarioBtnEl.addEventListener('click', generateAIScenario); }
        if(submitScenarioResponseBtnEl){ submitScenarioResponseBtnEl.addEventListener('click', submitScenarioResponse); }
        if(correctEssayBtnEl) { correctEssayBtnEl.addEventListener('click', correctEssay); }
        if(generateMcBtnEl) { generateMcBtnEl.addEventListener('click', generateMultipleChoiceQuestions); }
        if(submitMcAnswersBtnEl) { submitMcAnswersBtnEl.addEventListener('click', submitMultipleChoiceAnswers); }


        filterButtonsReview.forEach(button => {
            button.addEventListener('click', () => { const filterType = button.id.replace('filter-', ''); renderReviewList(filterType); updateActiveFilterButton(filterType); });
        });
        tabItems.forEach(tab => {
            tab.addEventListener('click', () => {
                setActivePage(tab.dataset.page, tab.dataset.title);
            });
        });
        aiFunctionMenuBtns.forEach(button => {
            button.addEventListener('click', () => showAIFunctionSubFeature(button.dataset.subFeatureId, button.dataset.title));
        });

        if(darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleDarkMode);
        }
        colorOptions.forEach(option => {
            option.addEventListener('click', () => selectThemeColor(option.dataset.color));
        });

        const aboutButton = document.querySelector('#page-settings .about-section .about-button');
        if (aboutButton) {
            aboutButton.addEventListener('click', showAboutPage);
        }

        if(learningGoalsMenuItem) {
            learningGoalsMenuItem.addEventListener('click', showStudyGoalsPage);
        }

        if (wordListSelectEl) {
            wordListSelectEl.addEventListener('change', (event) => {
                switchWordList(event.target.value);
            });
        }

        setActivePage('page-memorize', 'èƒŒå•è¯');
        console.log("éŸ©è¯­å­¦ä¹ åŠ©æ‰‹ (AIé«˜çº§å®šåˆ¶ç‰ˆ) å·²åˆå§‹åŒ–ã€‚");

        // å¼€å±åŠ¨ç”»é€»è¾‘
        setTimeout(() => {
            splashScreen.classList.add('hidden');
        }, 3000); // 3 ç§’åéšè—å¼€å±åŠ¨ç”»

        // å…³é—­æ­å–œå¼¹çª—æŒ‰é’®
        closeCongratsModalButton.addEventListener('click', hideCongratulationsModal);
    }

    // This function is for "smart" loading based on SRS and daily limits
    function loadWordForMemorizePage(initialLoadOrMarkKnown = false) {
        console.log("loadWordForMemorizePage called. Initial/MarkKnown:", initialLoadOrMarkKnown);
        const now = Date.now();
        const dueWords = Object.values(learnedWordsData).filter(word => word.nextReviewDue <= now);
        const newWordsNotLearned = wordList.filter(word => !learnedWordsData[word.korean]);

        let wordToLoad = null;
        let targetIndex = currentWordIndex; // Default to current index

        if (dueWords.length > 0) {
            dueWords.sort((a, b) => a.nextReviewDue - b.nextReviewDue);
            wordToLoad = wordList.find(w => w.korean === dueWords[0].korean);
            targetIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            console.log("Found due word:", wordToLoad.korean);
        } else if (dailyNewWordsLearnedToday < dailyNewWordsLimit && newWordsNotLearned.length > 0) {
            wordToLoad = newWordsNotLearned[0];
            targetIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            console.log("Found new word:", wordToLoad.korean);
        } else {
            // If no due words and no new words to learn, cycle through all words.
            // When arriving from `markAsKnown` or initial load, we might just want to advance to the next in sequence
            console.log("No due words or new words. Cycling through all words.");
            if (wordList.length > 0) {
                 if (initialLoadOrMarkKnown) {
                     // If it's an initial load or after marking known, load the *next* word from the current position
                     // This ensures progression even if no "smart" word is available
                     targetIndex = (currentWordIndex + 1) % wordList.length;
                     if (targetIndex === currentWordIndex && wordList.length > 1) { // Prevent infinite loop if only one word
                         // If only one word, or after incrementing we land on the same, no true "next" unique word
                         // In this specific scenario, just keep current word (or the only one)
                         wordToLoad = wordList[currentWordIndex];
                     } else {
                        wordToLoad = wordList[targetIndex];
                     }
                 } else {
                    // For other cases, if no specific word identified, stay on current or handle as needed
                    wordToLoad = wordList[currentWordIndex];
                 }
            }
        }

        if (wordToLoad) {
            loadWord(targetIndex, true); // Use the general loadWord with the specific index and speak
        } else {
            koreanWordEl.textContent = "æš‚æ— å•è¯å¯å­¦/å¤ä¹ ã€‚";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = wordList.length; // Still show total list count
            console.log("No word to load based on learning logic. Displaying placeholder.");
        }
    }

    if (synth && synth.getVoices().length === 0) {
        synth.onvoiceschanged = () => { console.log("è¯­éŸ³åˆæˆå£°éŸ³å·²è½½å…¥ã€‚"); };
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>