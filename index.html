<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>韩语学习助手 </title>
    <style>
        :root {
            --wechat-bg-gray: #f0f2f5;
            --wechat-header-bg: #f7f7f7;
            --wechat-header-text: #1f1f1f;
            --wechat-tabbar-bg: #fdfdfd;
            --wechat-tab-text: #7a7a7a;
            --wechat-tab-text-active: #07c160;
            --wechat-border-color: #e1e1e1;
            --wechat-list-item-bg: #ffffff;
            --wechat-button-primary: #07c160;
            --wechat-text-primary: #333333;
            --wechat-text-secondary: #666666;
            --wechat-input-bg: #ffffff;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --ai-accent-color: #1677ff;
            --card-background: #ffffff;
            --primary-color: #07c160;
            --text-color: #2c3e50;
            --shadow-color: rgba(0, 0, 0, 0.06);
            --font-system: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", sans-serif;
        }

        body[data-theme="dark"] {
            --wechat-bg-gray: #1a1a1a;
            --wechat-header-bg: #2a2a2a;
            --wechat-header-text: #e0e0e0;
            --wechat-tabbar-bg: #2a2a2a;
            --wechat-tab-text: #b0b0b0;
            --wechat-border-color: #444444;
            --wechat-list-item-bg: #333333;
            --wechat-button-primary: var(--primary-color);
            --wechat-text-primary: #e0e0e0;
            --wechat-text-secondary: #aaaaaa;
            --wechat-input-bg: #444444;
            --card-background: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body[data-color-theme="red"] {
            --primary-color: #FF4136;
            --wechat-tab-text-active: #FF4136;
            --ai-accent-color: #FF4136;
        }
        body[data-color-theme="orange"] {
            --primary-color: #FF851B;
            --wechat-tab-text-active: #FF851B;
            --ai-accent-color: #FF851B;
        }
        body[data-color-theme="yellow"] {
            --primary-color: #FFDC00;
            --wechat-tab-text-active: #FFDC00;
            --ai-accent-color: #FFDC00;
        }
        body[data-color-theme="green"] {
            --primary-color: #07c160;
            --wechat-tab-text-active: #07c160;
            --ai-accent-color: #07c160;
        }
        body[data-color-theme="cyan"] {
            --primary-color: #00B8D4;
            --wechat-tab-text-active: #00B8D4;
            --ai-accent-color: #00B8D4;
        }
        body[data-color-theme="blue"] {
            --primary-color: #0074D9;
            --wechat-tab-text-active: #0074D9;
            --ai-accent-color: #0074D9;
        }
        body[data-color-theme="purple"] {
            --primary-color: #B10DC9;
            --wechat-tab-text-active: #B10DC9;
            --ai-accent-color: #B10DC9;
        }


        body {
            font-family: var(--font-system); margin: 0; padding: 0; background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary); display: flex; flex-direction: column; height: 100vh;
            overflow: hidden; position: relative; font-size: 14px;
        }

        .app-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .wechat-header { background-color: var(--wechat-header-bg); border-bottom: 1px solid var(--wechat-border-color); padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; box-sizing: border-box; }
        .wechat-header-title { font-size: 17px; font-weight: 600; color: var(--wechat-header-text); }
        .wechat-content { flex-grow: 1; overflow-y: auto; padding: 15px; padding-top: 65px; padding-bottom: 70px; background-color: var(--wechat-bg-gray); }
        .content-page { display: none; animation: fadeInPage 0.3s ease-in-out; }
        .content-page.active { display: block; }
        @keyframes fadeInPage { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        .wechat-tabbar { background-color: var(--wechat-tabbar-bg); border-top: 1px solid var(--wechat-border-color); height: 55px; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--wechat-tab-text); font-size: 10px; cursor: pointer; flex-grow: 1; text-align: center; padding: 5px 0; }
        .tab-item-icon { font-size: 22px; margin-bottom: 3px; }
        .tab-item.active .tab-item-icon, .tab-item.active .tab-item-label { color: var(--wechat-tab-text-active); }

        button.ai-action-btn, .generic-button { background-color: var(--ai-accent-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 5px; margin-right: 5px; transition: background-color 0.2s; }
        button.ai-action-btn:hover, .generic-button:hover { background-color: var(--primary-color); }
        button.ai-action-btn:disabled, .generic-button:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7;}
        input[type="text"], textarea, select {
            width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color);
            border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: var(--font-system);
            box-sizing: border-box; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="radio"], input[type="checkbox"] {
            accent-color: var(--primary-color);
        }
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #5a6268;
        }


        #page-memorize .status {font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px; text-align: center;}
        #page-memorize .progress-bar-container {width: 100%; background-color: #e0e0e0; border-radius: 25px; margin-bottom: 20px; height: 8px; overflow: hidden;}
        body[data-theme="dark"] #page-memorize .progress-bar-container { background-color: #555;}
        #page-memorize .progress-bar {width: 0%; height: 100%; background: var(--primary-color); border-radius: 25px; transition: width 0.4s ease-in-out;}
        #page-memorize .word-card-container {width: 100%; perspective: 1000px; margin-bottom: 20px;}
        #page-memorize .word-card {min-height: 250px; width: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); background-color: var(--card-background); border-radius: 12px; box-shadow: 0 3px 10px var(--shadow-color);}
        #page-memorize .word-card.is-flipped {transform: rotateY(180deg);}
        #page-memorize .card-face {position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; border-radius: 12px;}
        #page-memorize .card-face-back {transform: rotateY(180deg); justify-content: flex-start; padding-top: 15px; overflow-y: auto;}
        #page-memorize .korean-word-container {display: flex; align-items: center; margin-bottom: 8px;}
        #page-memorize .korean-word {font-family: 'Noto Sans KR', var(--font-system); font-size: 2.2em; font-weight: 500; color: var(--text-color); margin-right: 8px; line-height: 1.3;}
        #page-memorize .pronounce-btn {background: none; border: none; font-size: 1.6em; cursor: pointer; color: var(--primary-color); padding: 0 5px;}
        #page-memorize .pronunciation {font-size: 1em; color: var(--wechat-text-secondary); margin-bottom: 15px; font-style: italic;}
        #page-memorize .hint-to-flip {font-size: 0.8em; color: var(--wechat-text-secondary); position: absolute; bottom: 10px;}
        #page-memorize .translation {font-size: 1.4em; font-weight: 500; margin-bottom: 10px;}
        #page-memorize .chinese-translation {color: var(--primary-color);}
        #page-memorize .example-sentence {font-size: 0.95em; text-align: left; width: 100%; margin-top: 5px;}
        #page-memorize .korean-example, #page-memorize .chinese-example {font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 4px; line-height: 1.5;}
        #page-memorize .korean-example {font-family: 'Noto Sans KR', var(--font-system); color: #555;}
        body[data-theme="dark"] #page-memorize .korean-example { color: #ccc;}
        #page-memorize .ai-word-expansion-area {width: 100%; margin-top: 10px;}
        #page-memorize .ai-helper-container, #page-memorize .ai-sentence-generator-container, #page-memorize .ai-usage-notes-container {margin-top: 8px; padding: 8px; background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; font-size: 0.85em; display: none;}
        body[data-theme="dark"] #page-memorize .ai-helper-container, body[data-theme="dark"] #page-memorize .ai-sentence-generator-container, body[data-theme="dark"] #page-memorize .ai-usage-notes-container { background-color: #213d54; border-color: #3b6d91;}
        #page-memorize .ai-helper-title, #page-memorize .ai-sentence-generator-title, #page-memorize .ai-usage-notes-title {font-weight: 500; color: var(--ai-accent-color); margin-bottom: 5px;}
        #page-memorize .ai-helper-content, #page-memorize .ai-generated-sentences, #page-memorize .ai-usage-notes-content {white-space: pre-wrap; color: var(--wechat-text-primary); line-height: 1.4;}
        #page-memorize .ai-generated-sentences ul {padding-left: 15px; margin: 5px 0;}
        #page-memorize .ai-generated-sentences li {margin-bottom: 5px;}
        #page-memorize .controls {display: grid; grid-template-columns: 1fr 1.6fr 1fr; gap: 8px; width: 100%; margin-bottom: 8px;}
        #page-memorize .controls.secondary-controls {grid-template-columns: 1fr 1fr;}
        #page-memorize .controls.tertiary-controls { grid-template-columns: 1fr 1fr; margin-top: 5px; }
        #page-memorize .controls button {background-color: var(--card-background); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 8px; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease;}
        body[data-theme="dark"] #page-memorize .controls button { background-color: #2b2b2b;}
        #page-memorize .controls button:hover {background-color: #f0f0f0; transform: translateY(-1px);}
        body[data-theme="dark"] #page-memorize .controls button:hover {background-color: #444;}
        #page-memorize .controls button:active {transform: translateY(0px);}
        #page-memorize .controls button#show-translation-btn {background-color: var(--primary-color); color: white;}
        #page-memorize .controls button.ai-btn {background-color: var(--ai-accent-color); color: white; border-color: var(--ai-accent-color); font-size: 0.9em; padding: 10px 5px;}


        #page-review-plan .review-summary {background-color: var(--wechat-list-item-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px var(--shadow-color); text-align: center;}
        #page-review-plan .review-summary p {margin: 5px 0; font-size: 0.95em;}
        #page-review-plan .review-summary .count {font-weight: bold; color: var(--primary-color);}
        #page-review-plan .review-list-item {background-color: var(--wechat-list-item-bg); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px var(--shadow-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s;}
        #page-review-plan .review-list-item:hover {background-color: #f9f9f9;}
        body[data-theme="dark"] #page-review-plan .review-list-item:hover {background-color: #444;}
        #page-review-plan .review-word-info .word {font-size: 1.1em; font-weight: 500; color: var(--text-color);}
        #page-review-plan .review-word-info .meaning {font-size: 0.9em; color: var(--wechat-text-secondary);}
        #page-review-plan .review-status .next-review {font-size: 0.8em; text-align: right;}
        #page-review-plan .review-status .next-review .date {font-weight: bold;}
        #page-review-plan .review-status .next-review .overdue {color: var(--danger-color);}
        #page-review-plan .review-status .next-review .due-soon {color: var(--warning-color);}
        #page-review-plan .no-reviews {text-align: center; color: var(--wechat-text-secondary); margin-top: 30px;}
        #page-review-plan .filter-buttons {margin-bottom: 15px; text-align: center;}
        #page-review-plan .filter-buttons button {padding: 6px 12px; margin: 0 5px; border-radius: 15px; border: 1px solid var(--wechat-border-color); background-color: var(--wechat-list-item-bg); color: var(--wechat-text-secondary); cursor: pointer; font-size:0.85em;}
        body[data-theme="dark"] #page-review-plan .filter-buttons button { background-color: #2b2b2b; }
        #page-review-plan .filter-buttons button.active {background-color: var(--primary-color); color: white; border-color: var(--primary-color);}


        #page-ai-functions .ai-function-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #page-ai-functions.menu-active .ai-function-menu { display: flex; }
        #page-ai-functions.sub-feature-active .ai-function-menu { display: none; }

        #page-ai-functions .ai-function-menu-item {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.1em;
            color: var(--wechat-text-primary);
        }
        #page-ai-functions .ai-function-menu-item:hover {
            background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-ai-functions .ai-function-menu-item:hover {
            background-color: #444;
        }
        #page-ai-functions .ai-sub-feature-section {
            display: none;
        }
        #page-ai-functions.sub-feature-active .ai-sub-feature-section.active {
            display: block;
            background-color: var(--wechat-bg-gray);
            padding: 0;
            box-shadow: none;
        }
        .ai-sub-feature-section .section-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
         .ai-sub-feature-section .section-container:last-child {
            margin-bottom: 0;
        }


        #page-image-recognition #image-preview-container-rec { margin-bottom: 10px; text-align: center; }
        #page-image-recognition #image-preview-rec { max-width: 100%; max-height: 180px; border: 1px solid var(--wechat-border-color); border-radius: 6px; display: none; margin: 0 auto; }
        #page-image-recognition #image-upload-label-rec { display: inline-block; padding: 8px 12px; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-size: 0.9em; }
        #page-image-recognition #image-upload-rec { display: none; }
        #page-image-recognition .recognition-output-section { margin-top: 10px; }
        #page-image-recognition .recognition-output-section h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-cloze .cloze-question { margin-bottom: 10px; font-size: 1.1em; }
        #feature-cloze .cloze-hint { font-size: 0.9em; color: var(--wechat-text-secondary); margin-bottom: 10px;}
        #feature-cloze #cloze-answer-input { width: calc(100% - 22px); padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }
        #feature-cloze #cloze-feedback { font-weight: bold; min-height: 20px; margin-top: 5px; }
        #feature-cloze #cloze-correct-sentence { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px; }

        #feature-story .story-weaver-controls { margin-bottom: 10px; }
        #feature-story .story-weaver-controls label { font-size: 0.9em; margin-right: 5px;}
        #feature-story #story-word-select { width: 100%; min-height: 60px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 0.9em; margin-bottom: 10px; }
        #feature-story #story-word-select option { padding: 3px; }
        #feature-story #ai-generated-story-ko, #feature-story #ai-generated-story-zh { margin-top: 5px; }
        #feature-story #ai-generated-story-ko h5, #feature-story #ai-generated-story-zh h5 { font-size: 0.95em; color: var(--ai-accent-color); margin-bottom: 3px; }

        #feature-scenario .scenario-difficulty-selector {
            margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;
        }
        body[data-theme="dark"] #feature-scenario .scenario-difficulty-selector { background-color: #2b2b2b;}
        #feature-scenario .scenario-difficulty-selector label { font-size: 0.9em; margin-right: 5px; }
        #feature-scenario .scenario-difficulty-selector input[type="radio"] { margin-right: 2px; vertical-align: middle; }
        #feature-scenario .scenario-difficulty-selector label[for^="diff-"] { margin-right: 10px; }
        #feature-scenario #ai-scenario-description { font-style: italic; margin-bottom: 10px; }
        #feature-scenario #ai-scenario-dialogue-history { background-color: #f8f8f8; border: 1px solid #eee; border-radius: 4px; padding: 10px; min-height: 80px; margin-bottom:10px; display:none; max-height: 200px; overflow-y: auto;}
        body[data-theme="dark"] #feature-scenario #ai-scenario-dialogue-history { background-color: #222; border-color: #444;}
        #feature-scenario #ai-scenario-dialogue-history p { margin: 3px 0; padding: 4px; border-radius: 3px;}
        #feature-scenario #ai-scenario-dialogue-history .user-utterance { text-align: right; }
        #feature-scenario #ai-scenario-dialogue-history .user-utterance strong { color: var(--primary-color); }
        #feature-scenario #ai-scenario-dialogue-history .ai-utterance strong { color: var(--ai-accent-color); }
        #feature-scenario #user-scenario-response { width: calc(100% - 22px); min-height: 50px; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; font-size: 1em; margin-bottom: 10px; font-family: 'Noto Sans KR', var(--font-system); }

        #feature-essay-correction #essay-input { min-height: 150px; }
        #feature-essay-correction #essay-feedback-area { margin-top: 15px; padding: 12px; background-color: #f9f9f9; border: 1px solid var(--wechat-border-color); border-radius: 6px; min-height: 80px; color: var(--wechat-text-primary); white-space: pre-wrap; font-size: 15px; line-height: 1.6; }
        body[data-theme="dark"] #feature-essay-correction #essay-feedback-area { background-color: #2b2b2b; border-color: #555;}
        #feature-essay-correction #essay-feedback-area.loading::before { content: "AI 批改中..."; color: var(--ai-accent-color); }
        #feature-essay-correction #essay-feedback-area.error { color: var(--danger-color); }

        #feature-mc-questions .mc-category-select {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        body[data-theme="dark"] #feature-mc-questions .mc-category-select { background-color: #2b2b2b;}
        #feature-mc-questions .mc-category-select label {
            font-size: 0.9em;
            margin-right: 5px;
        }
        #feature-mc-questions .mc-category-select input[type="radio"] {
            margin-right: 2px;
            vertical-align: middle;
        }


        #feature-mc-questions .mc-question-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;}
        #feature-mc-questions .mc-question-controls input[type="text"] { flex-grow: 1; margin-bottom: 0;}
        #feature-mc-questions .mc-question-controls input[type="number"] { width: 60px; margin-bottom: 0; text-align: center;}
        #feature-mc-questions .mc-question { margin-bottom: 15px; }
        #feature-mc-questions .mc-question p { font-size: 1.1em; font-weight: 500; margin-bottom: 10px; }
        #feature-mc-questions .mc-options label { display: block; margin-bottom: 8px; cursor: pointer; padding: 8px 10px; border: 1px solid var(--wechat-border-color); border-radius: 5px; transition: background-color 0.2s;}
        body[data-theme="dark"] #feature-mc-questions .mc-options label { border-color: #555;}
        #feature-mc-questions .mc-options label:hover { background-color: #f0f0f0; }
        body[data-theme="dark"] #feature-mc-questions .mc-options label:hover { background-color: #444;}
        #feature-mc-questions .mc-options input[type="radio"] { margin-right: 8px; }
        #feature-mc-questions .mc-feedback { margin-top: 10px; font-weight: bold; min-height: 20px; }
        #feature-mc-questions .mc-feedback.correct { color: var(--primary-color); }
        #feature-mc-questions .mc-feedback.incorrect { color: var(--danger-color); }
        #feature-mc-questions .mc-explanation { font-size: 0.9em; color: var(--wechat-text-secondary); margin-top: 5px;}

        #page-local-video #video-player-container {
            text-align: center;
            margin-top: 15px;
        }
        #page-local-video #video-player {
            width: 100%;
            max-width: 600px;
            max-height: 300px;
            background-color: black;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }
        #page-local-video #video-upload-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 1em;
        }
        #page-local-video #video-upload-input {
            display: none;
        }
        #page-local-video .file-name-display {
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
            margin-top: 5px;
            word-break: break-all;
        }


        #page-settings {
            padding: 0;
        }
        #page-settings .profile-section {
            background-color: var(--wechat-list-item-bg);
            padding: 20px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
		#page-settings .profile-avatar { /* 修改类名为 .profile-avatar */
             width: 48px; /* 设置头像宽度 */
             height: 48px; /* 设置头像高度，保持与宽度相同以实现圆形 */
             border-radius: 50%; /* 将头像变为圆形 */
             object-fit: cover; /* 确保图片在保持比例的同时填充整个头像区域 */
             margin-right: 15px;
         }
        #page-settings .profile-info h3 {
            margin: 0;
            font-size: 1.3em;
            color: var(--text-color);
        }
        #page-settings .profile-info p {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--wechat-text-secondary);
        }

        #page-settings .settings-list {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .settings-list .setting-item {
            padding: 15px;
            border-bottom: 1px solid var(--wechat-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        #page-settings .settings-list .setting-item:last-child {
            border-bottom: none;
        }
        #page-settings .settings-list .setting-item label {
            font-size: 1em;
            color: var(--wechat-text-primary);
            cursor: pointer;
            flex-grow: 1;
        }
        #page-settings .settings-list .setting-item .arrow {
            font-size: 1.2em;
            color: var(--wechat-text-secondary);
            margin-left: 10px;
        }


        #page-settings .about-section {
            background-color: var(--wechat-list-item-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
            padding: 0;
        }
        #page-settings .about-section .about-button {
            width: 100%;
            background-color: var(--wechat-list-item-bg);
            color: var(--wechat-text-primary);
            border: none;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        #page-settings .about-section .about-button:hover {
             background-color: #f0f0f0;
        }
        body[data-theme="dark"] #page-settings .about-section .about-button:hover {
            background-color: #444;
        }
        #page-settings .about-section .about-button .icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: var(--ai-accent-color);
        }

        #page-about {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-about .about-content-area {
            background-color: var(--wechat-list-item-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: center;
            margin-top: 15px;
        }
        #page-about h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        #page-about p {
            margin: 8px 0;
            line-height: 1.6;
            font-size: 0.95em;
        }
        #page-about p strong {
            color: var(--text-color);
        }

        #page-study-goals {
            padding: 15px;
            background-color: var(--wechat-bg-gray);
            color: var(--wechat-text-primary);
        }
        #page-study-goals .goals-container {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 15px;
        }
        #page-study-goals .goals-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--wechat-border-color);
            padding-bottom: 5px;
        }
        #page-study-goals .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1em;
        }
        #page-study-goals .goal-item input {
            width: 60px;
            text-align: center;
            margin-left: 10px;
            margin-bottom: 0;
        }

        .streak-calendar {
            background-color: var(--wechat-list-item-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-top: 15px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-header {
            font-weight: bold;
            color: var(--wechat-text-secondary);
            font-size: 0.85em;
        }
        .calendar-day {
            padding: 8px 5px;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: var(--wechat-text-primary);
            font-size: 0.9em;
            position: relative;
        }
        body[data-theme="dark"] .calendar-day { background-color: #444; }
        .calendar-day.empty {
            background-color: transparent;
            box-shadow: none;
        }
        .calendar-day.today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }
        .calendar-day.checked::after {
            content: '✔';
            color: white;
            background-color: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8em;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }


        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s, border-color 0.2s;
            box-sizing: border-box;
        }
        .color-option.selected {
            border-color: var(--primary-color);
            border-width: 3px;
            transform: scale(1.1);
        }
        .color-red { background-color: #FF4136; }
        .color-orange { background-color: #FF851B; }
        .color-yellow { background-color: #FFDC00; }
        .color-green { background-color: #07c160; }
        .color-cyan { background-color: #00B8D4; }
        .color-blue { background-color: #0074D9; }
        .color-purple { background-color: #B10DC9; }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }

        .splash-content {
            text-align: center;
        }

        .splash-title-zh {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.4em;
        }

        .splash-title-ko {
            font-size: 1.8em;
            color: var(--ai-accent-color);
            margin-bottom: 0.8em;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .splash-design-by {
            font-size: 1.1em;
            color: var(--wechat-text-secondary);
            margin-top: 1.5em;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        #fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            overflow: hidden;
        }

        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0;
            animation: shootAndExplode 1.5s ease-out forwards;
        }

        @keyframes shootAndExplode {
            0% {
                transform: translateY(200px) scale(0);
                opacity: 0;
            }
            30% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-150px) scale(0.2);
                opacity: 0;
            }
        }

        #congratulations-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--wechat-list-item-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-color);
            text-align: center;
            z-index: 1001;
            max-width: 80%;
            box-sizing: border-box;
            opacity: 0;
            animation: fadeInModal 0.3s forwards;
        }

        #congratulations-modal p {
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary-color);
            line-height: 1.5;
        }
         body[data-theme="dark"] #congratulations-modal p {
            color: var(--wechat-text-primary);
        }

        #congratulations-modal button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #congratulations-modal button:hover {
            background-color: darken(var(--primary-color), 10%);
        }

        .exchange-rate-input-group, .trash-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .exchange-rate-input-group input, .trash-input-group input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0;
            margin-right: 10px;
        }
        .exchange-rate-input-group select {
            margin-bottom: 0;
            width: auto;
        }
        .exchange-rate-result, .news-output, .trash-recognition-output, .trash-text-output {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--wechat-bg-gray);
            border-radius: 6px;
            border: 1px solid var(--wechat-border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95em;
            color: var(--wechat-text-primary);
            min-height: 50px;
        }
        body[data-theme="dark"] .exchange-rate-result,
        body[data-theme="dark"] .news-output,
        body[data-theme="dark"] .trash-recognition-output,
        body[data-theme="dark"] .trash-text-output {
            background-color: #2b2b2b;
            border-color: #555;
        }
        .news-output h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .news-output p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .news-output .korean-news {
            font-family: 'Noto Sans KR', var(--font-system);
            color: var(--text-color);
        }
        .news-output .chinese-news {
            font-size: 0.85em;
            color: var(--wechat-text-secondary);
        }
        .trash-recognition-output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .image-upload-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .image-upload-input {
            display: none;
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-title-zh">AI 韩语学习小助手</div>
            <div class="splash-title-ko">AI 한국어 학습 도우미</div>
            <div class="splash-design-by">Design by MiniWorld</div>
        </div>
    </div>

    <div id="fireworks-container"></div>

    <div id="congratulations-modal">
        <p>🎉 恭喜你达成今日学习目标，打卡成功，再接再厉！ 🎉</p>
        <button id="close-congrats-modal">好的</button>
    </div>

    <div class="app-wrapper" id="app-wrapper">
        <header class="wechat-header">
            <div class="wechat-header-title" id="app-header-title">背单词</div>
        </header>

        <main class="wechat-content">
            <div id="page-memorize" class="content-page active">
                <div class="status">第 <span id="current-word-index">1</span> 个单词 / 共 <span id="total-words">0</span> 个单词</div>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div class="word-card-container">
                    <div class="word-card" id="word-card">
                        <div class="card-face card-face-front">
                            <div class="korean-word-container">
                                <div class="korean-word" id="korean-word">载入中...</div>
                                <button class="pronounce-btn">🔊</button>
                            </div>
                            <div class="pronunciation" id="pronunciation"></div>
                            <div class="hint-to-flip">点击卡片查看释义或AI扩展</div>
                        </div>
                        <div class="card-face card-face-back">
                            <div class="translation chinese-translation" id="chinese-translation"></div>
                            <div class="example-sentence" id="example-sentence">
                                <div class="korean-example" id="korean-example"></div>
                                <div class="chinese-example" id="chinese-example"></div>
                            </div>
                            <div class="ai-word-expansion-area">
                                <div class="ai-helper-container" id="ai-helper-box"><div class="ai-helper-title">💡 AI 助记/小提示:</div><div class="ai-helper-content" id="ai-helper-content"></div></div>
                                <div class="ai-sentence-generator-container" id="ai-sentence-generator-box"><div class="ai-sentence-generator-title">✍️ AI 智能例句:</div><div class="ai-generated-sentences" id="ai-generated-sentences"></div></div>
                                <div class="ai-usage-notes-container" id="ai-usage-notes-box"><div class="ai-usage-notes-title">🧐 AI 用法辨析:</div><div class="ai-usage-notes-content" id="ai-usage-notes-content"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button id="prev-word-btn">❮ 上一个</button>
                    <button id="show-translation-btn" onclick="flipCard()">查看/隐藏</button>
                    <button id="next-word-btn">下一个 ❯</button>
                </div>
                <div class="controls secondary-controls">
                    <button id="mark-known-btn">✔ 我认识</button>
                    <button class="ai-btn" id="ai-tip-btn">🤖 AI提示</button>
                </div>
                <div class="controls tertiary-controls">
                    <button class="ai-btn" id="ai-sentence-btn">✍️ AI造句</button>
                    <button class="ai-btn" id="ai-usage-btn">🧐 AI辨析</button>
                </div>
            </div>

            <div id="page-review-plan" class="content-page">
                <div class="review-summary"><p>总学习单词数: <span id="total-learned-count" class="count">0</span></p><p>今日到期复习: <span id="due-today-count" class="count">0</span></p></div>
                <div class="filter-buttons"><button id="filter-all" class="active">全部学习</button><button id="filter-due">到期复习</button><button id="filter-overdue">逾期复习</button></div>
                <div id="review-list-container"><p class="no-reviews">暂无复习计划，快去学习新单词吧！</p></div>
            </div>

            <div id="page-ai-functions" class="content-page menu-active">
                <div class="ai-function-menu" id="ai-main-menu">
                    <div class="ai-function-menu-item" data-sub-feature-id="page-translate" data-title="AI 智能互译">
                        <span class="icon">🌐</span> AI 智能互译
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-ai-dictionary" data-title="AI 韩语词典">
                        <span class="icon">📖</span> AI 韩语词典
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="page-image-recognition" data-title="AI 看图识别韩文">
                        <span class="icon">🔍</span> AI 看图识别韩文
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-cloze" data-title="AI 完形填空">
                        <span class="icon">🎯</span> AI 完形填空
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-scenario" data-title="AI 情景对话模拟">
                        <span class="icon">🗣️</span> AI 情景对话模拟
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-essay-correction" data-title="AI 批改作文">
                        <span class="icon">📝</span> AI 批改作文
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="feature-mc-questions" data-title="AI 自动生成选择题">
                        <span class="icon">❓</span> AI 自动生成选择题
                    </div>
                    <div class="ai-function-menu-item" data-sub-feature-id="korean-life-helper-menu" data-title="韩国生活小助手">
                        <span class="icon">🇰🇷</span> 韩国生活小助手
                    </div>
                </div>

                <div id="korean-life-helper-menu" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="ai-function-menu" style="display: flex;">
                        <div class="ai-function-menu-item" data-sub-feature-id="page-exchange-rate" data-title="汇率换算">
                            <span class="icon">💱</span> 汇率换算
                        </div>
                        <div class="ai-function-menu-item" data-sub-feature-id="page-korean-story" data-title="韩中双语小故事">
                            <span class="icon">📚</span> 韩中双语小故事
                        </div>
                        <div class="ai-function-menu-item" data-sub-feature-id="page-trash-classification" data-title="垃圾分类">
                            <span class="icon">🗑️</span> 垃圾分类
                        </div>
                    </div>
                </div>


                <div id="page-translate" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🌐 AI 智能互译</h3>
                        <div class="api-key-info">智能翻译。</div>
                        <textarea id="text-to-translate-auto" placeholder="输入韩语或中文进行互译..."></textarea>
                        <button class="translate-button generic-button" id="do-translate-auto-btn">AI 智能互译</button>
                        <div class="translation-result-area ai-output-box" id="translation-output-auto">翻译结果将显示在此</div>
                        <div id="ai-translation-analysis-area"></div>
                    </div>
                </div>

                <div id="page-ai-dictionary" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">📖 AI 韩语词典</h3>
                        <div style="display: flex;">
                            <input type="text" id="korean-word-input" placeholder="输入要查询的韩语单词...">
                            <button class="generic-button" id="search-dictionary-btn">查询</button>
                        </div>
                        <div id="dictionary-output" class="ai-output-box">请在上方输入韩语单词并点击查询。</div>
                    </div>
                </div>

                <div id="page-image-recognition" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🔍 AI 看图识别韩文</h3>
                        <label for="image-upload-rec" id="image-upload-label-rec">选择图片</label>
                        <input type="file" id="image-upload-rec" accept="image/*">
                        <div id="image-preview-container-rec">
                            <img id="image-preview-rec" src="#" alt="图片预览">
                        </div>
                        <button class="ai-action-btn" id="recognize-image-korean-btn" disabled>AI 识别韩文</button>
                        <div id="ai-image-recognition-output-ko" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>🇰🇷 识别到的韩文:</h5><span id="image-recognized-ko-text"></span>
                        </div>
                        <div id="ai-image-recognition-output-zh" class="ai-output-box recognition-output-section" style="display:none;">
                            <h5>🇨🇳 中文翻译及解释:</h5><span id="image-recognized-zh-text"></span>
                        </div>
                    </div>
                </div>

                <div id="feature-cloze" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🎯 AI 完形填空</h3>
                        <div id="cloze-test-area">
                            <p class="cloze-question" id="cloze-question-text">点击下方按钮生成题目。</p>
                            <p class="cloze-hint" id="cloze-hint-text"></p>
                            <input type="text" id="cloze-answer-input" placeholder="输入挖空部分的韩语单词">
                            <button class="ai-action-btn" id="submit-cloze-btn">提交答案</button>
                            <div id="cloze-feedback"></div>
                            <div id="cloze-correct-sentence"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-cloze-btn" style="margin-top:10px;">获取新填空题</button>
                    </div>
                </div>

                <div id="feature-scenario" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">🗣️ AI 情景对话模拟</h3>
                        <div id="ai-scenario-area">
                            <div class="scenario-difficulty-selector" style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 6px;">
                                <label style="font-weight: bold; font-size: 0.95em;">选择对话难度：</label>
                                <input type="radio" name="scenario-difficulty" value="beginner" id="diff-beginner" checked> <label for="diff-beginner" style="font-size: 0.9em;">初级</label>
                                <input type="radio" name="scenario-difficulty" value="intermediate" id="diff-intermediate"> <label for="diff-intermediate" style="font-size: 0.9em;">中级</label>
                                <input type="radio" name="scenario-difficulty" value="advanced" id="diff-advanced"> <label for="diff-advanced" style="font-size: 0.9em;">高级</label>
                            </div>
                            <p id="ai-scenario-description">点击下方按钮生成对话情境。</p>
                            <div id="ai-scenario-dialogue-history"></div>
                            <textarea id="user-scenario-response" placeholder="请输入您的韩语回应..."></textarea>
                            <button class="ai-action-btn" id="submit-scenario-response-btn">发送回应</button>
                            <div id="ai-scenario-feedback" class="ai-output-box" style="margin-top:5px; display:none;"></div>
                        </div>
                        <button class="ai-action-btn" id="generate-scenario-btn" style="margin-top:10px;">获取新对话情境</button>
                    </div>
                </div>

                <div id="feature-essay-correction" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">📝 AI 批改作文</h3>
                        <textarea id="essay-input" placeholder="在此输入您的韩语作文..."></textarea>
                        <button class="ai-action-btn" id="correct-essay-btn">AI 批改作文</button>
                        <div id="essay-feedback-area" class="ai-output-box" style="display:none;"></div>
                    </div>
                </div>

                <div id="feature-mc-questions" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showAIFunctionsMenu()">← 返回 AI 功能</button>
                    <div class="section-container">
                        <h3 class="section-title">❓ AI 自动生成选择题</h3>
                        <div class="mc-category-select">
                            <label>选择题类型:</label>
                            <input type="radio" name="mc-category" value="grammar" id="mc-grammar" checked> <label for="mc-grammar">语法</label>
                            <input type="radio" name="mc-category" value="proverb" id="mc-proverb"> <label for="mc-proverb">谚语俗语</label>
                        </div>
                        <div class="mc-question-controls">
                            <label for="mc-count">数量:</label>
                            <input type="number" id="mc-count" value="3" min="1" max="5">
                            <button class="ai-action-btn" id="generate-mc-btn">生成选择题</button>
                        </div>
                        <div id="mc-questions-area" style="margin-top: 15px;">
                            <p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">点击上方按钮生成题目。</p>
                        </div>
                        <button class="ai-action-btn" id="submit-mc-answers-btn" style="display: none; margin-top: 15px;">提交答案</button>
                    </div>
                </div>

                <div id="page-exchange-rate" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showKoreanLifeHelperMenu()">← 返回 韩国生活小助手</button>
                    <div class="section-container">
                        <h3 class="section-title">💱 人民币/韩币 汇率换算</h3>
                        <div class="exchange-rate-input-group">
                            <input type="number" id="exchange-input-amount" placeholder="输入金额" value="100">
                            <select id="exchange-from-currency">
                                <option value="CNY">人民币 (CNY)</option>
                                <option value="KRW">韩币 (KRW)</option>
                            </select>
                            <span> 兑 </span>
                            <select id="exchange-to-currency">
                                <option value="KRW">韩币 (KRW)</option>
                                <option value="CNY">人民币 (CNY)</option>
                            </select>
                        </div>
                        <button class="ai-action-btn" id="do-exchange-rate-btn">立即换算</button>
                        <div class="exchange-rate-result ai-output-box" id="exchange-rate-output">换算结果将显示在此。</div>
                    </div>
                </div>

                <div id="page-korean-story" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showKoreanLifeHelperMenu()">← 返回 韩国生活小助手</button>
                    <div class="section-container">
                        <h3 class="section-title">📚 韩中双语小故事</h3>
                        <button class="ai-action-btn" id="fetch-korean-story-btn">生成小故事</button>
                        <div class="news-output ai-output-box" id="korean-story-output">
                            点击上方按钮生成一个关于韩国文化或历史的双语小故事。
                        </div>
                    </div>
                </div>

                <div id="page-trash-classification" class="ai-sub-feature-section">
                    <button class="back-button" onclick="showKoreanLifeHelperMenu()">← 返回 韩国生活小助手</button>
                    <div class="section-container">
                        <h3 class="section-title">🗑️ 垃圾分类 (看图识别)</h3>
                        <label for="trash-image-upload" class="image-upload-label">选择垃圾图片</label>
                        <input type="file" id="trash-image-upload" accept="image/*">
                        <div id="trash-image-preview-container" style="text-align: center; margin-bottom: 10px;">
                            <img id="trash-image-preview" src="#" alt="图片预览" style="max-width: 100%; max-height: 180px; border-radius: 6px; display: none;">
                        </div>
                        <button class="ai-action-btn" id="recognize-trash-image-btn" disabled>AI 识别并分类</button>
                        <div class="trash-recognition-output ai-output-box" id="trash-image-recognition-output" style="display:none;">
                            识别结果将显示在此。
                        </div>
                    </div>
                    <div class="section-container" style="margin-top: 15px;">
                        <h3 class="section-title">🗑️ 垃圾分类 (文字识别)</h3>
                        <div class="trash-input-group">
                            <input type="text" id="trash-text-input" placeholder="输入垃圾名称（韩语或中文）">
                            <button class="ai-action-btn" id="classify-trash-text-btn">文字识别并分类</button>
                        </div>
                        <div class="trash-text-output ai-output-box" id="trash-text-classification-output">
                            分类结果将显示在此。
                        </div>
                    </div>
                </div>

            </div>

            <div id="page-settings" class="content-page">
                <div class="profile-section">
                     <img src="https://k.sinaimg.cn/n/sinakd10107/452/w1079h973/20200331/5d90-irpunah6808860.jpg/w700d1q75cms.jpg" alt="用户头像" class="profile-avatar">
                    <div class="profile-info">
                        <h3><span id="current-username-display">用户名</span></h3>
                        <p>尊贵的永久VIP会员</p>
                    </div>
                </div>

                <div class="settings-list" id="settings-main-menu">
                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">学习设置</div>
                    <ul>
                        <li class="setting-item" id="learning-goals-menu-item">
                            <label><span class="icon">🎯</span> 学习目标</label>
                            <span class="arrow">▶</span>
                        </li>
                        <li class="setting-item">
                            <label for="word-list-select">字库:</label>
                            <select id="word-list-select" style="width: 150px; padding: 5px; border: 1px solid var(--wechat-border-color); border-radius: 4px; display: inline-block; margin-bottom:0; background-color: var(--wechat-input-bg); color: var(--wechat-text-primary);">
                                <option value="general">通用词汇</option>
                                <option value="computer">计算机专业词汇</option>
                                <option value="business">经营专业词汇</option>
                            </select>
                        </li>
                        <li class="setting-item">
                            <label for="auto-pronounce-next"><span class="icon">🔊</span> 自动发音下一个单词</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-pronounce-next" checked>
                                <span class="slider"></span>
                            </label>
                        </li>
                    </ul>

                    <div class="modal-section-title" style="padding: 15px 15px 5px 15px;">UI 设置</div>
                    <ul>
                        <li class="setting-item">
                            <label for="dark-mode-toggle"><span class="icon">🌙</span> 暗黑模式</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </li>
                        <li class="setting-item" style="padding-bottom: 15px;">
                            <label><span class="icon">🎨</span> 主题颜色</label>
                            <div>
                                <span class="color-option color-red" data-color="red" title="红色"></span>
                                <span class="color-option color-orange" data-color="orange" title="橙色"></span>
                                <span class="color-option color-yellow" data-color="yellow" title="黄色"></span>
                                <span class="color-option color-green" data-color="green" title="绿色"></span>
                                <span class="color-option color-cyan" data-color="cyan" title="青色"></span>
                                <span class="color-option color-blue" data-color="blue" title="蓝色"></span>
                                <span class="color-option color-purple" data-color="purple" title="紫色"></span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="about-section">
                    <button class="about-button" onclick="showAboutPage()">
                        <span class="icon">ℹ️</span> 关于
                    </button>
                </div>
            </div>

            <div id="page-study-goals" class="content-page">
                <button class="back-button" onclick="showSettingsMainMenu()">← 返回</button>
                <div class="goals-container">
                    <h3>学习目标设定</h3>
                    <div class="goal-item">
                        <label for="daily-study-amount">每日新词学习量:</label>
                        <input type="number" id="daily-study-amount" value="10" min="1" max="50">
                    </div>
                </div>

                <div class="streak-calendar">
                    <h3>学习打卡日历</h3>
                    <div class="calendar-header">
                        <span id="calendar-month-year"></span>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <div class="calendar-day-header">日</div>
                        <div class="calendar-day-header">一</div>
                        <div class="calendar-day-header">二</div>
                        <div class="calendar-day-header">三</div>
                        <div class="calendar-day-header">四</div>
                        <div class="calendar-day-header">五</div>
                        <div class="calendar-day-header">六</div>
                        </div>
                     <p style="font-size: 0.85em; color: var(--wechat-text-secondary); text-align: center; margin-top: 15px;">
                        每日学习新词达到目标数量后自动打卡。
                    </p>
                </div>
            </div>


            <div id="page-about" class="content-page">
                <button class="back-button" onclick="setActivePage('page-settings', '我')">← 返回</button>
                <div class="about-content-area">
                    <h3>关于本应用</h3>
                    <p>
                        <strong>中文:</strong> 本软件由MiniWorld团队开发。<br>
                        <strong>有问题请联系:</strong> haechojo@gmail.com<br>
                        <strong>版本号:</strong> 0.9beta<br>
                        <strong>发布日期:</strong> 2025年5月27日
                    </p>
                    <p>
                        <strong>한국어:</strong> 이 소프트웨어는 MiniWorld 팀에 의해 개발되었습니다.<br>
                        <strong>문의:</strong> haechojo@gmail.com<                        <strong>버전:</strong> 0.9beta<br>
                        <strong>출시일:</strong> 2025년 5月27日
                    </p>
                </div>
            </div>
        </main>

        <nav class="wechat-tabbar">
            <div class="tab-item active" data-page="page-memorize" data-title="背单词"><div class="tab-item-icon">🧠</div><div class="tab-item-label">背单词</div></div>
            <div class="tab-item" data-page="page-review-plan" data-title="复习"><div class="tab-item-icon">📅</div><div class="tab-item-label">复习</div></div>
            <div class="tab-item" data-page="page-ai-functions" data-title="AI功能"><div class="tab-item-icon">🤖</div><div class="tab-item-label">AI功能</div></div>
            <div class="tab-item" data-page="page-settings" data-title="我"><div class="tab-item-icon">👤</div><div class="tab-item-label">我</div></div>
        </nav>
    </div>


<script>
    const GEMINI_API_KEY = "AIzaSyDlBJ3rTN0VlfLDKHgyJiqQ1VoYIcw9bXs";

    const appWrapperEl = document.getElementById('app-wrapper');
    const appHeaderTitleEl = document.getElementById('app-header-title');
    const contentPages = document.querySelectorAll('.content-page');
    const tabItems = document.querySelectorAll('.tab-item');

    const koreanWordEl = document.getElementById('korean-word');
    const pronunciationEl = document.getElementById('pronunciation');
    const chineseTranslationEl = document.getElementById('chinese-translation');
    const exampleSentenceEl = document.getElementById('example-sentence');
    const koreanExampleEl = document.getElementById('korean-example');
    const chineseExampleEl = document.getElementById('chinese-example');
    const wordCardEl = document.getElementById('word-card');
    const progressBarEl = document.getElementById('progress-bar');
    const currentWordIndexEl = document.getElementById('current-word-index');
    const totalWordsEl = document.getElementById('total-words');
    const aiHelperBoxEl = document.getElementById('ai-helper-box');
    const aiHelperContentEl = document.getElementById('ai-helper-content');
    const aiSentenceGeneratorBoxEl = document.getElementById('ai-sentence-generator-box');
    const aiGeneratedSentencesEl = document.getElementById('ai-generated-sentences');
    const aiUsageNotesBoxEl = document.getElementById('ai-usage-notes-box');
    const aiUsageNotesContentEl = document.getElementById('ai-usage-notes-content');
    const pronounceBtnEl = document.querySelector('#page-memorize .pronounce-btn');

    const reviewListContainerEl = document.getElementById('review-list-container');
    const totalLearnedCountEl = document.getElementById('total-learned-count');
    const dueTodayCountEl = document.getElementById('due-today-count');
    const filterButtonsReview = document.querySelectorAll('#page-review-plan .filter-buttons button');

    const pageAiFunctionsEl = document.getElementById('page-ai-functions');
    const aiFunctionMenuBtns = document.querySelectorAll('#page-ai-functions .ai-function-menu-item');
    const aiSubFeatureSections = document.querySelectorAll('#page-ai-functions .ai-sub-feature-section');

    const textToTranslateAutoEl = document.getElementById('text-to-translate-auto');
    const doTranslateAutoBtnEl = document.getElementById('do-translate-auto-btn');
    const translationOutputAutoEl = document.getElementById('translation-output-auto');
    const aiTranslationAnalysisAreaEl = document.getElementById('ai-translation-analysis-area');

    const koreanWordInputEl = document.getElementById('korean-word-input');
    const searchDictionaryBtnEl = document.getElementById('search-dictionary-btn');
    const dictionaryOutputEl = document.getElementById('dictionary-output');

    const imageUploadInputRecEl = document.getElementById('image-upload-rec');
    const imagePreviewRecEl = document.getElementById('image-preview-rec');
    const recognizeImageKoreanBtnEl = document.getElementById('recognize-image-korean-btn');
    const imageRecognizedKoTextEl = document.getElementById('image-recognized-ko-text');
    const imageRecognizedZhTextEl = document.getElementById('image-recognized-zh-text');
    let uploadedImageBase64Rec = null;
    let uploadedImageMimeTypeRec = null;

    const clozeQuestionTextEl = document.getElementById('cloze-question-text');
    const clozeHintTextEl = document.getElementById('cloze-hint-text');
    const clozeAnswerInputEl = document.getElementById('cloze-answer-input');
    const clozeFeedbackEl = document.getElementById('cloze-feedback');
    const clozeCorrectSentenceEl = document.getElementById('cloze-correct-sentence');
    const generateClozeBtnEl = document.getElementById('generate-cloze-btn');
    const submitClozeBtnEl = document.getElementById('submit-cloze-btn');
    let currentClozeWordData = null;

    const aiScenarioDescriptionEl = document.getElementById('ai-scenario-description');
    const aiScenarioDialogueHistoryEl = document.getElementById('ai-scenario-dialogue-history');
    const userScenarioResponseEl = document.getElementById('user-scenario-response');
    const submitScenarioResponseBtnEl = document.getElementById('submit-scenario-response-btn');
    const aiScenarioFeedbackEl = document.getElementById('ai-scenario-feedback');
    const generateScenarioBtnEl = document.getElementById('generate-scenario-btn');
    let currentAIScenarioContext = [];

    const essayInputEl = document.getElementById('essay-input');
    const correctEssayBtnEl = document.getElementById('correct-essay-btn');
    const essayFeedbackAreaEl = document.getElementById('essay-feedback-area');

    const mcCategoryRadioBtns = document.querySelectorAll('input[name="mc-category"]');
    const mcCountInputEl = document.getElementById('mc-count');
    const generateMcBtnEl = document.getElementById('generate-mc-btn');
    const mcQuestionsAreaEl = document.getElementById('mc-questions-area');
    const submitMcAnswersBtnEl = document.getElementById('submit-mc-answers-btn');
    let currentMCQuestions = [];

    const currentUsernameDisplayEl = document.getElementById('current-username-display');
    const dailyStudyAmountInput = document.getElementById('daily-study-amount');
    const autoPronounceNextCheckbox = document.getElementById('auto-pronounce-next');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const colorOptions = document.querySelectorAll('.color-option');
    const pageAboutEl = document.getElementById('page-about');
    const pageStudyGoalsEl = document.getElementById('page-study-goals');
    const learningGoalsMenuItem = document.getElementById('learning-goals-menu-item');
    const wordListSelectEl = document.getElementById('word-list-select');

    const calendarGridEl = document.getElementById('calendar-grid');
    const calendarMonthYearEl = document.getElementById('calendar-month-year');

    const splashScreen = document.getElementById('splash-screen');
    const fireworksContainer = document.getElementById('fireworks-container');
    const congratulationsModal = document.getElementById('congratulations-modal');
    const closeCongratsModalButton = document.getElementById('close-congrats-modal');

    const exchangeInputAmountEl = document.getElementById('exchange-input-amount');
    const exchangeFromCurrencyEl = document.getElementById('exchange-from-currency');
    const exchangeToCurrencyEl = document.getElementById('exchange-to-currency');
    const doExchangeRateBtnEl = document.getElementById('do-exchange-rate-btn');
    const exchangeRateOutputEl = document.getElementById('exchange-rate-output');

    const fetchKoreanStoryBtnEl = document.getElementById('fetch-korean-story-btn');
    const koreanStoryOutputEl = document.getElementById('korean-story-output');

    const trashImageUploadEl = document.getElementById('trash-image-upload');
    const trashImagePreviewEl = document.getElementById('trash-image-preview');
    const recognizeTrashImageBtnEl = document.getElementById('recognize-trash-image-btn');
    const trashImageRecognitionOutputEl = document.getElementById('trash-image-recognition-output');
    let uploadedTrashImageBase64 = null;
    let uploadedTrashImageMimeType = null;

    const trashTextInputEl = document.getElementById('trash-text-input');
    const classifyTrashTextBtnEl = document.getElementById('classify-trash-text-btn');
    const trashTextClassificationOutputEl = document.getElementById('trash-text-classification-output');


    let allWordLists = {
        general: [
            { korean: "안녕하세요", pronunciation: "[an-nyeong-ha-se-yo]", chinese: "你好", korean_example: "A: 안녕하세요, 처음 뵙겠습니다.\nB: 네, 안녕하세요. 만나서 반갑습니다.", chinese_example: "A: 你好，初次见面。\nB: 是的，你好。见到你很高兴。" },
            { korean: "감사합니다", pronunciation: "[gam-sa-ham-ni-da]", chinese: "谢谢", korean_example: "도와주셔서 정말 감사합니다.", chinese_example: "非常感谢您的帮助。" },
            { korean: "공부하다", pronunciation: "[gong-bu-ha-da]", chinese: "学习", korean_example: "저는 한국어를 공부해요.", chinese_example: "我学习韩语。" },
            { korean: "영화", pronunciation: "[yeong-hwa]", chinese: "电影", korean_example: "어떤 영화를 좋아해요?", chinese_example: "你喜欢什么电影？" },
            { korean: "음악", pronunciation: "[eu-mak]", chinese: "音乐", korean_example: "저는 클래식 음악을 즐겨 들어요.", chinese_example: "我喜欢听古典音乐。" },
            { korean: "여행", pronunciation: "[yeo-haeng]", chinese: "旅行", korean_example: "다음 휴가 때 여행 갈 계획이에요.", chinese_example: "我计划下次休假去旅行。" },
            { korean: "가족", pronunciation: "[ga-jok]", chinese: "家庭", korean_example: "우리 가족은 모두 다섯 명이에요.", chinese_example: "我们家一共五口人。" },
            { korean: "사랑", pronunciation: "[sa-rang]", chinese: "爱", korean_example: "사랑은 아름다운 감정이에요.", chinese_example: "爱是一种美丽的情感。" },
            { korean: "행복", pronunciation: "[haeng-bok]", chinese: "幸福", korean_example: "모두가 행복하길 바라요.", chinese_example: "希望所有人都幸福。" },
            { korean: "시간", pronunciation: "[si-gan]", chinese: "时间", korean_example: "시간就是金钱。", chinese_example: "时间就是金钱。" },
            { korean: "책", pronunciation: "[chaek]", chinese: "书", korean_example: " 저는 책을 읽는 것을 좋아해요.", chinese_example: "我喜欢读书。" },
            { korean: "친구", pronunciation: "[chin-gu]", chinese: "朋友", korean_example: "저는 좋은 친구가 많아요.", chinese_example: "我有很多好朋友。" },
            { korean: "학교", pronunciation: "[hak-gyo]", chinese: "学校", korean_example: "학교에 매일 가요.", chinese_example: "我每天去学校。" },
            { korean: "음식", pronunciation: "[eum-sik]", chinese: "食物", korean_example: "한국 음식을 좋아해요.", chinese_example: "我喜欢韩国食物。" },
            { korean: "물", pronunciation: "[mul]", chinese: "水", korean_example: "목마를 때 물을 마셔요.", chinese_example: "口渴的时候喝水。" },
            { korean: "집", pronunciation: "[jip]", chinese: "家", korean_example: "집에서 쉬고 싶어요.", chinese_example: "我想在家休息。" },
            { korean: "말하다", pronunciation: "[mal-ha-da]", chinese: "说", korean_example: "한국어로 말하고 싶어요.", chinese_example: "我想说韩语。" },
            { korean: "듣다", pronunciation: "[deut-da]", chinese: "听", korean_example: "음악을 듣는 중이에요.", chinese_example: "我正在听音乐。" },
            { korean: "보다", pronunciation: "[bo-da]", chinese: "看", korean_example: "영화를 볼까요?", chinese_example: "我们看电影吗？" },
            { korean: "먹다", pronunciation: "[meok-da]", chinese: "吃", korean_example: "점심을 먹어요.", chinese_example: "我吃午饭。" },
            { korean: "가다", pronunciation: "[ga-da]", chinese: "去", korean_example: "학교에 가요.", chinese_example: "我去学校。" },
            { korean: "오다", pronunciation: "[o-da]", chinese: "来", korean_example: "집에 왔어요.", chinese_example: "我到家了。" },
            { korean: "하다", pronunciation: "[ha-da]", chinese: "做", korean_example: "숙제를 해요.", chinese_example: "我做作业。" },
            { korean: "크다", pronunciation: "[keu-da]", chinese: "大", korean_example: "집이 커요.", chinese_example: "房子很大。" },
            { korean: "작다", pronunciation: "[jak-da]", chinese: "小", korean_example: "방이 작아요.", chinese_example: "房间很小。" },
            { korean: "예쁘다", pronunciation: "[ye-ppeu-da]", chinese: "漂亮", korean_example: "꽃이 예뻐요.", chinese_example: "花很漂亮。" },
            { korean: "좋다", pronunciation: "[jot-da]", chinese: "好", korean_example: "날씨가 좋아요.", chinese_example: "天气很好。" },
            { korean: "나쁘다", pronunciation: "[na-ppeu-da]", chinese: "不好", korean_example: "기분이 나빠요.", chinese_example: "心情不好。" },
            { korean: "많다", pronunciation: "[man-ta]", chinese: "多", korean_example: "친구가 많아요.", chinese_example: "朋友很多。" },
            { korean: "없다", pronunciation: "[eop-da]", chinese: "没有", korean_example: "돈이 없어요.", chinese_example: "我没有钱。" }
        ],
		computer: [
            { korean: "컴퓨터", pronunciation: "[keom-pyu-teo]", chinese: "电脑", korean_example: "새 컴퓨터를 샀어요.", chinese_example: "我买了新电脑。" },
            { korean: "소프트웨어", pronunciation: "[so-peu-teu-we-eo]", chinese: "软件", korean_example: "이 소프트웨어를 설치해야 해요.", chinese_example: "我需要安装这个软件。" },
            { korean: "하드웨어", pronunciation: "[ha-deu-we-eo]", chinese: "硬件", korean_example: "컴퓨터 하드웨어는 중요해요.", chinese_example: "电脑硬件很重要。" },
            { korean: "프로그래밍", pronunciation: "[peu-ro-geu-rae-ming]", chinese: "编程", korean_example: "저는 파이썬으로 프로그래밍을 공부하고 있어요.", chinese_example: "我正在学习用Python编程。" },
            { korean: "네트워크", pronunciation: "[ne-teu-weo-keu]", chinese: "网络", korean_example: "네트워크 연결이 불안정해요.", chinese_example: "网络连接不稳定。" },
            { korean: "데이터", pronunciation: "[de-i-teo]", chinese: "数据", korean_example: "빅데이터 분석은 중요해요.", chinese_example: "大数据分析很重要。" },
            { korean: "알고리즘", pronunciation: "[al-go-ri-jeum]", chinese: "算法", korean_example: "이 알고리즘은 매우 효율적이에요.", chinese_example: "这个算法非常高效。" },
            { korean: "인공지능", pronunciation: "[in-gong-ji-neung]", chinese: "人工智能", korean_example: "인공지능은 미래 기술이에요.", chinese_example: "人工智能是未来的技术。" },
            { korean: "클라우드", pronunciation: "[keul-la-u-deu]", chinese: "云（计算）", korean_example: "클라우드 서비스를 이용하고 있어요.", chinese_example: "我正在使用云计算服务。" },
            { korean: "보안", pronunciation: "[bo-an]", chinese: "安全（信息安全）", korean_example: "정보 보안이 매우 중요해요.", chinese_example: "信息安全非常重要。" },
            { korean: "코딩", pronunciation: "[ko-ding]", chinese: "编码/程式码", korean_example: "파이썬으로 코딩을 시작했어요.", chinese_example: "我开始用Python编码了。" },
            { korean: "서버", pronunciation: "[seo-beo]", chinese: "伺服器", korean_example: "웹사이트 서버가 다운됐어요.", chinese_example: "网站伺服器宕机了。" },
            { korean: "앱", pronunciation: "[aep]", chinese: "应用程式", korean_example: "새로운 모바일 앱을 개발 중이에요.", chinese_example: "我正在开发一个新的行动应用程式。" },
            { korean: "개발자", pronunciation: "[gae-bal-ja]", chinese: "开发者", korean_example: "이 소프트웨어는 유능한 개발자들이 만들었어요.", chinese_example: "这个软体是由有能力的开发者们製作的。" },
            { korean: "인터넷", pronunciation: "[in-teo-net]", chinese: "互联网", korean_example: "인터넷으로 정보를 찾아요.", chinese_example: "我通过互联网查找资讯。" },
            { korean: "프로젝트", pronunciation: "[peu-ro-jek-teu]", chinese: "专案", korean_example: "새로운 프로젝트를 시작했어요.", chinese_example: "我开始了一个新的专案。" },
            { korean: "웹사이트", pronunciation: "[web-sa-i-teu]", chinese: "网站", korean_example: "이 웹사이트는 디자인이 예뻐요.", chinese_example: "这个网站的设计很漂亮。" },
            { korean: "데이터베이스", pronunciation: "[de-i-teo-be-i-seu]", chinese: "资料库", korean_example: "데이터베이스를 관리하는 방법을 배웠어요.", chinese_example: "我学会了如何管理资料库。" },
            { korean: "컴파일", pronunciation: "[keom-pa-il]", chinese: "编译", korean_example: "소프트웨어 코드를 컴파일해야 해요.", chinese_example: "我需要编译软体程式码。" },
            { korean: "버그", pronunciation: "[beo-geu]", chinese: "错误/缺陷", korean_example: "프로그램에 버그가 있어서 수정 중이에요.", chinese_example: "程式有错误，我正在修复。" },
            { korean: "운영체제", pronunciation: "[un-yeong-che-je]", chinese: "作业系统", korean_example: "새로운 운영체제가 출시됐어요.", chinese_example: "新的作业系统发布了。" },
            { korean: "프로세서", pronunciation: "[peu-ro-se-seo]", chinese: "处理器", korean_example: "이 컴퓨터는 빠른 프로세서를 가지고 있어요.", chinese_example: "这台电脑有很快的处理器。" },
            { korean: "메모리", pronunciation: "[me-mo-ri]", chinese: "记忆体", korean_example: "컴퓨터 메모리를 업그레이드했어요.", chinese_example: "我升级了电脑记忆体。" },
            { korean: "저장장치", pronunciation: "[jeo-jang-jang-chi]", chinese: "储存装置", korean_example: "외장 저장장치가 필요해요.", chinese_example: "我需要一个外部储存装置。" },
            { korean: "그래픽카드", pronunciation: "[geu-rae-pik-ka-deu]", chinese: "显示卡", korean_example: "게임을 위해 좋은 그래픽카드가 필요해요.", chinese_example: "玩游戏需要好的显示卡。" },
            { korean: "모니터", pronunciation: "[mo-ni-teo]", chinese: "显示器", korean_example: "새 모니터를 구입했어요.", chinese_example: "我买了一个新显示器。" },
            { korean: "키보드", pronunciation: "[ki-bo-deu]", chinese: "键盘", korean_example: "이 키보드는 타이핑하기 편해요.", chinese_example: "这个键盘打字很舒服。" },
            { korean: "마우스", pronunciation: "[ma-u-seu]", chinese: "滑鼠", korean_example: "무선 마우스를 사용해요.", chinese_example: "我使用无线滑鼠。" },
            { korean: "프린터", pronunciation: "[peu-rin-teo]", chinese: "印表机", korean_example: "프린터로 문서를 출력했어요.", chinese_example: "我用印表机列印了文件。" },
            { korean: "스캐너", pronunciation: "[seu-kae-neo]", chinese: "扫描器", korean_example: "문서를 스캐너로 디지털화했어요.", chinese_example: "我用扫描器将文件数位化了。" }
        ],
		business: [
            { korean: "경제", pronunciation: "[gyeong-je]", chinese: "经济", korean_example: "세계 경제가 어렵습니다.", chinese_example: "世界经济很困难。" },
            { korean: "경영", pronunciation: "[gyeong-yeong]", chinese: "经营/管理", korean_example: "경영학을 전공했어요.", chinese_example: "我主修经营学。" },
            { korean: "마케팅", pronunciation: "[ma-ke-ting]", chinese: "市场营销", korean_example: "새로운 마케팅 전략이 필요해요.", chinese_example: "我们需要新的市场营销策略。" },
            { korean: "회계", pronunciation: "[hoe-gye]", chinese: "会计", korean_example: "회계 보고서를 작성해야 해요.", chinese_example: "我需要准备会计报告。" },
            { korean: "투자", pronunciation: "[tu-ja]", chinese: "投资", korean_example: "부동산에 투자했어요.", chinese_example: "我投资了房地产。" },
            { korean: "수익", pronunciation: "[su-ik]", chinese: "收益/利润", korean_example: "회사의 수익이 증가했어요.", chinese_example: "公司的收益增加了。" },
            { korean: "비용", pronunciation: "[bi-yong]", chinese: "费用/成本", korean_example: "불필요한 비용을 줄여야 해요.", chinese_example: "我们需要削减不必要的成本。" },
            { korean: "시장", pronunciation: "[si-jang]", chinese: "市场", korean_example: "한국 시장을 분석하고 있어요.", chinese_example: "我正在分析韩国市场。" },
            { korean: "전략", pronunciation: "[jeon-llyak]", chinese: "战略", korean_example: "장기적인 전략을 세워야 해요.", chinese_example: "我们需要制定长期战略。" },
            { korean: "고객", pronunciation: "[go-gaek]", chinese: "顾客/客户", korean_example: "고객 만족이 최우선이에요.", chinese_example: "顾客满意是我们的首要任务。" },
            { korean: "회사", pronunciation: "[hoe-sa]", chinese: "公司", korean_example: "새로운 회사에 취직했어요.", chinese_example: "我在新公司找到了工作。" },
            { korean: "직원", pronunciation: "[jik-won]", chinese: "员工", korean_example: "우리 회사는 직원이 많아요.", chinese_example: "我们公司有很多员工。" },
            { korean: "업무", pronunciation: "[eop-mu]", chinese: "业务/工作", korean_example: "오늘 업무가 많아요.", chinese_example: "今天有很多工作。" },
            { korean: "회의", pronunciation: "[hoe-ui]", chinese: "会议", korean_example: "오전에 중요한 회의가 있어요.", chinese_example: "上午有一个重要的会议。" },
            { korean: "보고서", pronunciation: "[bo-go-seo]", chinese: "报告", korean_example: "보고서를 제출해야 해요.", chinese_example: "我需要提交报告。" },
            { korean: "계약", pronunciation: "[gye-yak]", chinese: "合约/契约", korean_example: "새로운 계약을 체결했어요.", chinese_example: "我签订了新的合约。" },
            { korean: "협상", pronunciation: "[hyeop-sang]", chinese: "谈判", korean_example: "거래를 위해 협상 중이에요.", chinese_example: "我正在为交易进行谈判。" },
            { korean: "성과", pronunciation: "[seong-gwa]", chinese: "成果/绩效", korean_example: "좋은 성과를 냈어요.", chinese_example: "我取得了好的绩效。" },
            { korean: "목표", pronunciation: "[mok-pyo]", chinese: "目标", korean_example: "올해의 목표를 세웠어요.", chinese_example: "我设定了今年的目标。" },
            { korean: "성장", pronunciation: "[seong-jang]", chinese: "成长", korean_example: "회사가 빠르게 성장하고 있어요.", chinese_example: "公司正在快速成长。" },
            { korean: "위기", pronunciation: "[wi-gi]", chinese: "危机", korean_example: "경제가 위기에 처했어요.", chinese_example: "经济陷入了危机。" },
            { korean: "기회", pronunciation: "[gi-hoe]", chinese: "机会", korean_example: "이번이 좋은 기회에요.", chinese_example: "这次是个好机会。" },
            { korean: "경쟁", pronunciation: "[gyeong-jaeng]", chinese: "竞争", korean_example: "시장에서 경쟁이 치열해요.", chinese_example: "市场竞争激烈。" },
            { korean: "협력", pronunciation: "[hyeop-nyeok]", chinese: "合作", korean_example: "다른 회사와 협력하고 있어요.", chinese_example: "我正在与其他公司合作。" },
            { korean: "제안", pronunciation: "[je-an]", chinese: "提案", korean_example: "새로운 사업 제안을 했어요.", chinese_example: "我提出了新的商业提案。" },
            { korean: "승인", pronunciation: "[seung-in]", chinese: "批准/核准", korean_example: "제안서가 승인됐어요.", chinese_example: "提案被批准了。" },
            { korean: "실패", pronunciation: "[sil-pae]", chinese: "失败", korean_example: "실패를 통해 배웠어요.", chinese_example: "我从失败中学习了。" },
            { korean: "성공", pronunciation: "[seong-gong]", chinese: "成功", korean_example: "프로젝트가 성공적으로 끝났어요.", chinese_example: "项目成功结束了。" },
            { korean: "능력", pronunciation: "[neung-nyeok]", chinese: "能力", korean_example: "그는 업무 능력이 뛰어나요.", chinese_example: "他工作能力很出色。" },
            { korean: "기술", pronunciation: "[gi-sul]", chinese: "技术", korean_example: "첨단 기술을 개발하고 있어요.", chinese_example: "我正在开发尖端技术。" }
        ]
    };

    let currentWordListName = 'general';
    let wordList = allWordLists[currentWordListName];

    let currentWordIndex = 0;
    let isCardFlipped = false;
    let synth = window.speechSynthesis;
    let learnedWordsData = {};
    const srsIntervals = [1, 3, 7, 15, 30, 60, 120];

    let dailyNewWordsLimit = 10;
    let dailyNewWordsLearnedToday = 0;
    let studyStreak = {};

    function getTodayDateString() {
        const today = new Date();
        return today.toISOString().slice(0, 10);
    }

    function loadLearnedWords() {
        const savedCurrentList = localStorage.getItem('hanyangKoreanCurrentWordList_AI_Advanced_v10');
        if (savedCurrentList && allWordLists[savedCurrentList]) {
            currentWordListName = savedCurrentList;
        } else {
            currentWordListName = 'general';
        }
        wordList = allWordLists[currentWordListName];

        if (wordListSelectEl) {
            wordListSelectEl.value = currentWordListName;
        }

        const data = localStorage.getItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`);
        if (data) {
            learnedWordsData = JSON.parse(data);
        } else {
            learnedWordsData = {};
        }

        const savedLimit = localStorage.getItem('dailyNewWordsLimit');
        if (savedLimit) dailyNewWordsLimit = parseInt(savedLimit, 10);
        if (dailyStudyAmountInput) dailyStudyAmountInput.value = dailyNewWordsLimit;

        const savedLearnedToday = localStorage.getItem('dailyNewWordsLearnedToday');
        const savedDate = localStorage.getItem('lastDailyNewWordsDate');
        const todayStr = getTodayDateString();

        if (savedDate === todayStr) {
            dailyNewWordsLearnedToday = parseInt(savedLearnedToday, 10);
        } else {
            dailyNewWordsLearnedToday = 0;
            localStorage.setItem('dailyNewWordsLearnedToday', 0);
            localStorage.setItem('lastDailyNewWordsDate', todayStr);
        }

        const savedStreak = localStorage.getItem('hanyangKoreanStudyStreak');
        if (savedStreak) {
            try {
                studyStreak = JSON.parse(savedStreak);
            } catch (e) {
                console.error("Error parsing study streak from localStorage", e);
                studyStreak = {};
            }
        } else {
            studyStreak = {};
        }
    }

    function saveLearnedWords() {
        localStorage.setItem(`hanyangKoreanLearnedWords_${currentWordListName}_AI_Advanced_v10`, JSON.stringify(learnedWordsData));
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);
        localStorage.setItem('dailyNewWordsLearnedToday', dailyNewWordsLearnedToday);
        localStorage.setItem('lastDailyNewWordsDate', getTodayDateString());
        localStorage.setItem('hanyangKoreanStudyStreak', JSON.stringify(studyStreak));
    }

    function renderCalendar() {
        if (!calendarGridEl) return;

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        calendarMonthYearEl.textContent = `${year}年 ${month + 1}月`;
        calendarGridEl.innerHTML = `
            <div class="calendar-day-header">日</div>
            <div class="calendar-day-header">一</div>
            <div class="calendar-day-header">二</div>
            <div class="calendar-day-header">三</div>
            <div class="calendar-day-header">四</div>
            <div class="calendar-day-header">五</div>
            <div class="calendar-day-header">六</div>
        `;

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const numDaysInMonth = lastDayOfMonth.getDate();
        const firstDayOfWeek = firstDayOfMonth.getDay();

        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarGridEl.appendChild(emptyDay);
        }

        for (let day = 1; day <= numDaysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day');
            dayEl.textContent = day;

            const currentDay = new Date(year, month, day);
            const dayString = currentDay.toISOString().slice(0, 10);

            if (dayString === getTodayDateString()) {
                dayEl.classList.add('today');
            }
            if (studyStreak[dayString]) {
                dayEl.classList.add('checked');
            }
            calendarGridEl.appendChild(dayEl);
        }
    }

    function checkDailyStudyGoal() {
        const todayStr = getTodayDateString();
        const wordsLearnedToday = Object.values(learnedWordsData).filter(word => {
            const firstLearnedDate = new Date(word.firstLearned).toISOString().slice(0, 10);
            return firstLearnedDate === todayStr && word.reviewCount === 1;
        }).length;

        if (wordsLearnedToday >= dailyNewWordsLimit && !studyStreak[todayStr]) {
            studyStreak[todayStr] = true;
            saveLearnedWords();
            renderCalendar();
            showFireworks();
            showCongratulationsModal();
            console.log("今日学习目标已完成，打卡成功！");
        }
    }

    function showFireworks() {
        fireworksContainer.innerHTML = '';
        const numberOfFireworks = 20;
        for (let i = 0; i < numberOfFireworks; i++) {
            const firework = document.createElement('div');
            firework.classList.add('firework');
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight * 0.6;
            firework.style.left = `${x}px`;
            firework.style.top = `${y}px`;
            const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
            firework.style.backgroundColor = color;
            const animationDelay = Math.random() * 0.5;
            firework.style.animationDelay = `${animationDelay}s`;
            fireworksContainer.appendChild(firework);
        }
        setTimeout(() => {
            fireworksContainer.innerHTML = '';
        }, 2000);
    }

    function showCongratulationsModal() {
        congratulationsModal.style.display = 'block';
        congratulationsModal.style.opacity = '1';
    }

    function hideCongratulationsModal() {
        congratulationsModal.style.display = 'none';
    }


    function applySavedSettings() {
        const savedTheme = localStorage.getItem('hanyangKoreanTheme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            if (darkModeToggle) darkModeToggle.checked = true;
        } else {
            document.body.removeAttribute('data-theme');
            if (darkModeToggle) darkModeToggle.checked = false;
        }

        const savedColorTheme = localStorage.getItem('hanyangKoreanColorTheme');
        if (savedColorTheme) {
            document.body.setAttribute('data-color-theme', savedColorTheme);
            selectThemeColor(savedColorTheme, false);
        } else {
            document.body.setAttribute('data-color-theme', 'green');
            selectThemeColor('green', false);
        }
    }

    function toggleDarkMode() {
        if (darkModeToggle.checked) {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('hanyangKoreanTheme', 'dark');
        } else {
            document.body.removeAttribute('data-theme');
            localStorage.removeItem('hanyangKoreanTheme');
        }
    }

    function selectThemeColor(color, save = true) {
        document.body.setAttribute('data-color-theme', color);
        colorOptions.forEach(option => {
            option.style.cursor = 'pointer';
            option.classList.toggle('selected', option.dataset.color === color);
        });
        if (save) {
            localStorage.setItem('hanyangKoreanColorTheme', color);
        }
    }

    async function callGeminiAPI(contents, purpose = "general", targetElementForLoading = null) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            const msg = "错误：Gemini API密钥无效或未在JS中正确设置。"; console.error(msg);
            if (targetElementForLoading) { targetElementForLoading.textContent = msg; targetElementForLoading.classList.add('error'); targetElementForLoading.classList.remove('loading'); }
            return null;
        }
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        let formattedContents;
        if (Array.isArray(contents)) {
            formattedContents = contents.map(item => {
                if (item.role && item.parts) {
                    return item;
                } else if (item.text || item.inline_data) {
                    return { role: "user", parts: [item] };
                }
                return { role: "user", parts: [{ text: JSON.stringify(item) }] };
            });
        } else if (contents.text || contents.inline_data) {
            formattedContents = [{ role: "user", parts: [contents] }];
        } else {
            formattedContents = [{ role: "user", parts: [{ text: JSON.stringify(contents) }] }];
        }

        const requestBody = { contents: formattedContents, generationConfig: { "candidateCount": 1, "temperature": 0.6 } };

        if (targetElementForLoading) { targetElementForLoading.innerHTML = ""; targetElementForLoading.classList.add('loading'); targetElementForLoading.classList.remove('error');}

        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (targetElementForLoading) targetElementForLoading.classList.remove('loading');
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: "无法解析API错误回应" } }));
                throw new Error(`API 错误 (${response.status}): ${errorData.error?.message || '未知错误'}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                return data.candidates[0].content.parts[0].text.trim();
            } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                 throw new Error(`请求被阻止: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`);
            } else { throw new Error("AI未能生成有效内容或返回了预期外的数据结构。"); }
        } catch (error) {
            console.error(`Gemini API 调用失败，目的 "${purpose}":`, error);
            if (targetElementForLoading) { targetElementForLoading.textContent = `AI调用失败: ${error.message}`; targetElementForLoading.classList.add('error');}
            return null;
        }
    }

    async function getAITipForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiHelperContentEl.textContent = ""; aiHelperBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `我正在学习韩语单词 "${korean}"，它的中文意思是 "${chinese}"。请用简体中文给我一个非常简短、有趣且易于记忆的助记方法，或者一个与这个单词紧密相关的韩国文化小知识，帮助我记住它。请专注于一个点，保持在一两句话之内。`;
        const aiTip = await callGeminiAPI([{text: prompt}], "ai_tip", aiHelperContentEl);
        if (aiTip && !aiHelperContentEl.classList.contains('error')) aiHelperContentEl.textContent = aiTip;
    }
    async function getAISentencesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiGeneratedSentencesEl.innerHTML = ""; aiSentenceGeneratorBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `为韩语单词 "${korean}" (意思是 "${chinese}") 生成2-3个简短实用的韩语例句，并为每个例句提供对应的简体中文翻译。请确保例句简单易懂，适合初学者。格式如下：\n1. 韩语例句1\n   中文翻译1\n2. 韩语例句2\n   中文翻译2`;
        const sentencesText = await callGeminiAPI([{text: prompt}], "ai_sentence", aiGeneratedSentencesEl);
        if (sentencesText && !aiGeneratedSentencesEl.classList.contains('error')) {
            const lines = sentencesText.split('\n').filter(line => line.trim() !== ''); let htmlContent = "<ul>";
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].match(/^\d+\.\s*/)) { htmlContent += `<li><strong>${lines[i].replace(/^\d+\.\s*/, '')}</strong><br>`;
                    if (lines[i+1] && !lines[i+1].match(/^\d+\.\s*/)) { htmlContent += `<span style="font-size:0.9em; color:var(--wechat-text-secondary);">${lines[i+1]}</span></li>`; i++; }
                    else { htmlContent += `</li>`; }
                }
            } htmlContent += "</ul>"; aiGeneratedSentencesEl.innerHTML = htmlContent;
        }
    }
    async function getAIUsageNotesForWord() {
        if (!wordList[currentWordIndex]) return; const { korean, chinese } = wordList[currentWordIndex];
        aiUsageNotesContentEl.textContent = ""; aiUsageNotesBoxEl.style.display = 'block'; if (!isCardFlipped) flipCard(true);
        const prompt = `关于韩语单词 "${korean}" (意思是 "${chinese}")：\n1. 它最常见的用法或搭配是什么？\n2. 有没有初学者容易混淆的用法或者和中文意思的细微差别？\n3. 如果有相关的近义词或反义词，请举一例。\n请用简体中文简明扼要地回答，每个点一两句话即可。`;
        const usageNotes = await callGeminiAPI([{text: prompt}], "ai_usage", aiUsageNotesContentEl);
        if (usageNotes && !aiUsageNotesContentEl.classList.contains('error')) aiUsageNotesContentEl.textContent = usageNotes;
    }

    async function translateAutoDetect() {
        const text = textToTranslateAutoEl.value.trim();
        if (!text) { translationOutputAutoEl.textContent = "请输入要翻译的内容。"; aiTranslationAnalysisAreaEl.innerHTML = ""; return; }
        const prompt = `请自动检测以下文本是中文还是韩语。\n- 如果是中文，请将其翻译成韩语。\n- 如果是韩语，请将其翻译成简体中文。\n请只提供翻译后的文本，不要包含任何额外的解释、介绍或围绕翻译本身的引号。\n文本内容如下：\n"${text}"`;
        aiTranslationAnalysisAreaEl.innerHTML = "";
        const translatedText = await callGeminiAPI([{text: prompt}], "auto_translate", translationOutputAutoEl);
        if (translatedText && !translationOutputAutoEl.classList.contains('error')) {
            translationOutputAutoEl.textContent = translatedText;
        }
    }

    async function searchAIDictionary() {
        const koreanWord = koreanWordInputEl.value.trim();
        if (!koreanWord) { dictionaryOutputEl.textContent = "请输入要查询的韩语单词。"; dictionaryOutputEl.classList.remove('loading', 'error'); return; }
        const prompt = `请为韩语单词 "${koreanWord}" 提供一个详细的中文词典条目，包含以下部分：\n1. **发音**：[罗马音标记]\n2. **词性**：例如 名词, 动词, 形容词等。\n3. **中文释义**：列出1-3个主要意思，每个意思后附带一个韩语例句及其简体中文翻译。\n   - 意思1: [中文意思1]\n     例句 (韩): [韩语例句1]\n     例句 (中): [中文翻译1]\n   - 意思2: [中文意思2]\n     例句 (韩): [韩语例句2]\n     例句 (中): [中文翻译2]\n4. **常用搭配** (可选，1-2个)：例如 "${koreanWord} + (名词/动词)"\n5. **近义词** (可选，1个)：[韩语近义词] - [中文意思]\n6. **反义词** (可选，1个)：[韩语反义词] - [中文意思]\n7. **词源/助记** (可选，一句话简述，若有意义)：\n请确保格式清晰，例句实用。如果某些部分不适用或难以找到，可以省略该部分，但请尽量提供核心信息。`;
        const dictionaryEntryText = await callGeminiAPI([{text: prompt}], "ai_dictionary", dictionaryOutputEl);
        if (dictionaryEntryText && !dictionaryOutputEl.classList.contains('error')) {
            dictionaryOutputEl.innerHTML = dictionaryEntryText.replace(/\n/g, '<br>');
        }
    }

    async function generateImageRecognition() {
        if (!uploadedImageBase64Rec || !uploadedImageMimeTypeRec) { alert("请先选择一张图片。"); return; }
        imageRecognizedKoTextEl.textContent = ""; imageRecognizedZhTextEl.textContent = "";
        const recognitionOutputKoBox = document.getElementById('ai-image-recognition-output-ko');
        const recognitionOutputZhBox = document.getElementById('ai-image-recognition-output-zh');

        recognitionOutputKoBox.classList.add('loading');
        recognitionOutputKoBox.style.display = 'block';
        recognitionOutputZhBox.style.display = 'none';

        const promptParts = [
            { inline_data: { mime_type: uploadedImageMimeTypeRec, data: uploadedImageBase64Rec } },
            { text: "请识别图片中的韩语文字（如果有的话）。然后，请在下一行用 '---中文翻译及解释---' 分隔，提供识别到的韩语文字的简体中文翻译和简要解释（例如，这是什么意思，或者在什么情境下使用）。如果图片中没有韩语文字，请说明图片内容，并说明未找到韩语文字。"}
        ];
        const resultText = await callGeminiAPI([{role: "user", parts: promptParts}], "image_recognition", recognitionOutputKoBox);

        if (resultText && !recognitionOutputKoBox.classList.contains('error')) {
            const parts = resultText.split("---中文翻译及解释---");
            imageRecognizedKoTextEl.textContent = parts[0] ? parts[0].trim() : "AI未能识别到韩语文字。";
            if (parts[1]) {
                imageRecognizedZhTextEl.textContent = parts[1].trim();
                recognitionOutputZhBox.style.display = 'block';
            } else {
                imageRecognizedZhTextEl.textContent = "AI未能提供中文翻译和解释。";
                recognitionOutputZhBox.style.display = 'block';
            }
        } else if (!resultText && !recognitionOutputKoBox.classList.contains('error')) {
            imageRecognizedKoTextEl.textContent = "AI看图识别韩文失败或未返回内容。";
        }
    }

    async function generateAIClozeTest() {
        clozeQuestionTextEl.textContent = ""; clozeHintTextEl.textContent = ""; clozeAnswerInputEl.value = "";
        clozeFeedbackEl.textContent = ""; clozeCorrectSentenceEl.textContent = ""; currentClozeWordData = null;
        const learnedKeys = Object.keys(learnedWordsData);
        if (learnedKeys.length === 0) { clozeQuestionTextEl.textContent = "请先学习一些单词才能进行填空练习。"; return; }
        const randomWordKey = learnedKeys[Math.floor(Math.random() * learnedKeys.length)];
        const wordData = wordList.find(w => w.korean === randomWordKey) || {};
        if (!wordData.korean_example || !wordData.chinese_example) {
            clozeQuestionTextEl.textContent = "未能找到含有例句的已学单词，请多学习一些单词或重试。";
            return;
        }
        currentClozeWordData = wordData;

        const exampleSentence = wordData.korean_example.split('\n')[0];
        const chineseExample = wordData.chinese_example.split('\n')[0];
        const clozeSentence = exampleSentence.replace(wordData.korean, "_____");

        clozeQuestionTextEl.textContent = clozeSentence;
        clozeHintTextEl.textContent = `提示 (中文): ${chineseExample}`;
        clozeCorrectSentenceEl.style.display = 'none';
    }
    function submitClozeAnswer() {
        const userAnswer = clozeAnswerInputEl.value.trim();
        if (!currentClozeWordData || !userAnswer) { clozeFeedbackEl.textContent = "请输入答案。"; clozeFeedbackEl.style.color = "var(--warning-color)"; return; }
        if (userAnswer === currentClozeWordData.korean) { clozeFeedbackEl.textContent = "回答正确！🎉"; clozeFeedbackEl.style.color = "var(--primary-color)"; }
        else { clozeFeedbackEl.textContent = `回答错误。正确答案是: ${currentClozeWordData.korean}`; clozeFeedbackEl.style.color = "var(--danger-color)"; }
        if(currentClozeWordData.korean_example) clozeCorrectSentenceEl.textContent = `正确句子: ${currentClozeWordData.korean_example.split('\n')[0]}`;
        clozeCorrectSentenceEl.style.display = 'block';
    }

    async function generateAIScenario() {
        currentAIScenarioContext = []; aiScenarioDescriptionEl.textContent = "AI 构思情境中...";
        aiScenarioDialogueHistoryEl.innerHTML = ""; aiScenarioDialogueHistoryEl.style.display = 'none';
        userScenarioResponseEl.value = ""; aiScenarioFeedbackEl.textContent = ""; aiScenarioFeedbackEl.style.display = 'none';
        const selectedDifficulty = document.querySelector('input[name="scenario-difficulty"]:checked').value;
        const learnedWordKeys = Object.keys(learnedWordsData);
        const setupPrompt = `你是一个韩语学习助手，现在要为我创建一个韩语口语情景对话。
        对话难度级别为"${selectedDifficulty}"。
        请给我一个简短的中文场景描述，以及你（作为AI角色）的第一句韩语台词，并明确指出你扮演的角色。
        最后，给用户一个用中文描述的任务提示，告诉他们需要如何开始回应。
        请确保你的韩语台词的词汇和语法复杂度符合"${selectedDifficulty}"水平。
        如果可能，可以在场景描述或任务提示中暗示使用一些已学词汇（例如：${learnedWordKeys.slice(0, 3).join(", ") || "一些基础词汇"}）。

        严格按照以下格式输出，并用 "---" 分隔：
        场景描述 (中文)
        ---
        AI角色: 韩语台词
        ---
        用户任务提示 (中文)`;

        const scenarioData = await callGeminiAPI([{ role: "user", parts: [{ text: setupPrompt }] }], "scenario_setup", aiScenarioDescriptionEl);

        if (scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) {
            const parts = scenarioData.split("---").map(p => p.trim());
            if (parts.length >= 3) {
                aiScenarioDescriptionEl.textContent = `情景 (${selectedDifficulty}): ${parts[0]}`;
                const aiFullLine = parts[1];
                const aiTextMatch = aiFullLine.match(/^(.*?):\s*(.*)$/);
                let aiRole = "AI";
                let aiDialogue = aiFullLine;

                if (aiTextMatch && aiTextMatch.length >= 3) {
                    aiRole = aiTextMatch[1].trim();
                    aiDialogue = aiTextMatch[2].trim();
                } else {
                    aiDialogue = aiFullLine;
                }

                currentAIScenarioContext.push({ role: "model", parts: [{ text: aiDialogue }] });
                updateScenarioDialogueHistory();
                aiScenarioDialogueHistoryEl.style.display = 'block';
                userScenarioResponseEl.placeholder = `你的任务: ${parts[2]}`;

            } else { aiScenarioDescriptionEl.textContent = "AI场景生成格式错误。请重试。"; }
        } else if (!scenarioData && !aiScenarioDescriptionEl.classList.contains('error')) { aiScenarioDescriptionEl.textContent = "AI场景生成失败。"; }
    }

    async function submitScenarioResponse() {
        const userResponse = userScenarioResponseEl.value.trim();
        if (!userResponse) {
            aiScenarioFeedbackEl.textContent = "请输入您的回应。";
            aiScenarioFeedbackEl.style.color = "var(--warning-color)";
            aiScenarioFeedbackEl.style.display = 'block';
            return;
        }

        currentAIScenarioContext.push({ role: "user", parts: [{ text: userResponse }] });
        updateScenarioDialogueHistory();
        userScenarioResponseEl.value = "";

        aiScenarioFeedbackEl.textContent = "AI 思考回应中...";
        aiScenarioFeedbackEl.style.display = 'block';
        aiScenarioFeedbackEl.classList.remove('error', 'success');

        const fullPromptContents = [
            { role: "user", parts: [{ text: "你是一个韩语学习助手。我们正在进行情景对话练习。你的任务是评估用户的韩语回应，然后以你的角色继续对话。请严格遵守以下格式，先是中文反馈，然后用 '---反馈---' 分隔，最后是AI的韩语回应。如果对话可以自然结束，可以说一句韩语结束语（例如：고맙습니다. 다음에 또 만나요.）。如果用户表达不清或任务未完成，可以尝试引导或提问。" }] },
            ...currentAIScenarioContext
        ];

        const aiFullResponse = await callGeminiAPI(fullPromptContents, "scenario_continue");

        if (aiFullResponse) {
            const parts = aiFullResponse.split("---反馈---");
            const feedbackText = parts[0] ? parts[0].trim() : "AI 未提供明确反馈。";
            const aiNextKoreanUtterance = parts[1] ? parts[1].trim() : "음... 다시 한번 말씀해주시겠어요? (嗯...能再说一遍？)";

            aiScenarioFeedbackEl.textContent = `AI反馈: ${feedbackText}`;
            aiScenarioFeedbackEl.style.color = "var(--wechat-text-secondary)";

            currentAIScenarioContext.push({ role: "model", parts: [{ text: aiNextKoreanUtterance }] });
            updateScenarioDialogueHistory();

            if (aiNextKoreanUtterance.includes("감사합니다") || aiNextKoreanUtterance.includes("안녕히 가세요") || currentAIScenarioContext.length > 8) {
                aiScenarioFeedbackEl.textContent += "\n对话结束。";
            }
        } else {
            aiScenarioFeedbackEl.textContent = "AI回应生成失败。";
            aiScenarioFeedbackEl.classList.add('error');
            currentAIScenarioContext.pop();
            updateScenarioDialogueHistory();
        }
    }
    function updateScenarioDialogueHistory() {
        aiScenarioDialogueHistoryEl.innerHTML = currentAIScenarioContext.map(turn => {
            const speaker = turn.role === 'user' ? '您' : 'AI';
            const cssClass = turn.role === 'user' ? 'user-utterance' : 'ai-utterance';
            return `<p class="${cssClass}"><strong>${speaker}:</strong> ${turn.parts[0].text.replace(/\n/g, "<br>")}</p>`;
        }).join('');
        aiScenarioDialogueHistoryEl.scrollTop = aiScenarioDialogueHistoryEl.scrollHeight;
    }

    async function correctEssay() {
        const essayText = essayInputEl.value.trim();
        if (!essayText) {
            essayFeedbackAreaEl.textContent = "请输入您要批改的韩语作文。";
            essayFeedbackAreaEl.classList.remove('loading', 'error');
            essayFeedbackAreaEl.style.display = 'block';
            return;
        }
        const prompt = `请作为一名资深的韩语老师，为以下韩语作文进行批改和评价。请提供：
        1. **整体评价** (Overall Assessment): 简要评价作文的优点和不足。
        2. **语法修正与解释** (Grammar Correction & Explanation): 列出具体的语法错误并提供正确版本，解释为什么是错误的。
        3. **词汇用法建议** (Vocabulary Usage Suggestions): 针对不恰当的词汇提供替换建议，或指出词汇使用的亮点。
        4. **表达流畅度与自然度** (Fluency & Naturalness): 针对不自然的表达进行润色。
        5. **TOPIK相关建议** (TOPIK-specific Advice): 如果有，提供针对TOPIK考试的写作建议。
        6. **修订后的作文** (Revised Essay): 提供一个完整的、修正后的韩语作文版本。
        请确保反馈详细、有建设性，并且易于理解。
        作文内容:
        "${essayText}"`;

        const feedback = await callGeminiAPI([{text: prompt}], "essay_correction", essayFeedbackAreaEl);
        if (feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.innerHTML = feedback.replace(/\n/g, '<br>');
            essayFeedbackAreaEl.style.display = 'block';
        } else if (!feedback && !essayFeedbackAreaEl.classList.contains('error')) {
            essayFeedbackAreaEl.textContent = "AI批改作文失败或未返回内容。";
            essayFeedbackAreaEl.style.display = 'block';
        }
    }

    async function generateMultipleChoiceQuestions() {
        const category = document.querySelector('input[name="mc-category"]:checked').value;
        const count = parseInt(mcCountInputEl.value, 10);

        if (count < 1 || count > 5) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">请输入问题数量（1-5）。</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
            return;
        }

        mcQuestionsAreaEl.innerHTML = `<p style="text-align:center; color:var(--ai-accent-color); font-style:italic;">AI 正在生成题目...</p>`;
        submitMcAnswersBtnEl.style.display = 'none';
        currentMCQuestions = [];

        let prompt = "";
        if (category === "grammar") {
            prompt = `请生成 ${count} 道韩语语法选择题，适合TOPIK初级或中级水平的学习者。
            每道题包括：
            1. 题目 (韩语句子，其中某个语法点被挖空或需要选择正确形式)
            2. 四个选项 (A, B, C, D，韩语语法点或词汇)
            3. 正确答案 (字母)
            4. 详细的中文解释 (为什么正确，为什么其他选项错误，可以扩展相关语法知识点)

            请严格按照以下格式输出，每道题之间用 "---" 分隔，每个部分用 "&&&" 分隔：
            题目&&&A. 选项A&&&B. 选项B&&&C. 选项C&&&D. 选项D&&&正确答案: X&&&解释: 中文解释
            例如：
            저는 주말에 영화____ 볼 거예요.&&&A. -를&&&B. -은&&&C. -와&&&D. -이&&&正确答案: A&&&解释: '영화'는 목적어로, '보다' 동사와 함께 쓰일 때 목적격 조사 '-를'이 붙습니다。
            ---
            [下一道题目]`;
        } else if (category === "proverb") {
            prompt = `请生成 ${count} 道韩语谚语/俗语选择题，适合TOPIK中级或高级水平的学习者。
            每道题包括：
            1. 题目 (一个韩语谚语或俗语的挖空形式，或给出情境选择谚语)
            2. 四个选项 (A, B, C, D，韩语谚语/俗语或其部分)
            3. 正确答案 (字母)
            4. 详细的中文解释 (谚语/俗语的字面意思和引申义，以及使用情境)

            请严格按照以下格式输出，每道题之间用 "---" 分隔，每个部分用 "&&&" 分隔：
            题目&&&[挖空或情境]____&&&A. 选项A&&&B. 选项B&&&C. 选项C&&&D. 选项D&&&正确答案: X&&&解释: 中文解释
            例如：
            늦게 배운 도둑질이 ____ 날 새는 줄 모른다.&&&A. 밤&&&B. 낮&&&C. 아침&&&D. 저녁&&&正确答案: A&&&解释: '늦게 배운 도둑질이 밤 새는 줄 모른다'는 늦게 시작한 일이 재미있어서 시간 가는 줄 모른다는 뜻입니다。
            ---
            [下一道题目]`;
        }


        const rawQuestions = await callGeminiAPI([{text: prompt}], "mc_generation", mcQuestionsAreaEl);

        if (rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            const questionBlocks = rawQuestions.split('---').filter(block => block.trim() !== '');
            let htmlContent = '';
            questionBlocks.forEach((block, index) => {
                const parts = block.split('&&&').map(p => p.trim());
                if (parts.length >= 6) {
                    const questionText = parts[0];
                    const options = parts.slice(1, 5);
                    const correctAnswerMatch = parts[5].match(/正确答案:\s*([A-D])/i);
                    const explanationText = parts[6] || '';

                    const correctAnswer = correctAnswerMatch ? correctAnswerMatch[1].toUpperCase() : '';

                    currentMCQuestions.push({
                        id: `q${index}`,
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        explanation: explanationText,
                        userAnswer: null
                    });

                    htmlContent += `<div class="mc-question" data-question-id="q${index}">
                        <p>${index + 1}. ${questionText}</p>
                        <div class="mc-options">`;
                    options.forEach((opt, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex);
                        htmlContent += `<label>
                            <input type="radio" name="question-${index}" value="${optionLetter}">
                            ${opt}
                        </label>`;
                    });
                    htmlContent += `</div>
                        <div class="mc-feedback" id="feedback-q${index}"></div>
                        <div class="mc-explanation" id="explanation-q${index}" style="display: none;">${explanationText}</div>
                    </div>`;
                }
            });

            if (currentMCQuestions.length > 0) {
                mcQuestionsAreaEl.innerHTML = htmlContent;
                submitMcAnswersBtnEl.style.display = 'block';
            } else {
                mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AI未能生成有效题目。请尝试更改话题或数量。</p>`;
            }

        } else if (!rawQuestions && !mcQuestionsAreaEl.classList.contains('error')) {
            mcQuestionsAreaEl.innerHTML = `<p style="color:var(--danger-color); text-align:center;">AI题目生成失败。</p>`;
        }
    }

    function submitMultipleChoiceAnswers() {
        let allCorrect = true;
        currentMCQuestions.forEach(q => {
            const selectedOption = document.querySelector(`input[name="question-${q.id.replace('q', '')}"]:checked`);
            const feedbackEl = document.getElementById(`feedback-${q.id}`);
            const explanationEl = document.getElementById(`explanation-${q.id}`);

            if (!selectedOption) {
                feedbackEl.textContent = "请选择一个答案。";
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'none';
                return;
            }

            q.userAnswer = selectedOption.value;
            if (q.userAnswer === q.correctAnswer) {
                feedbackEl.textContent = "回答正确！🎉";
                feedbackEl.className = 'mc-feedback correct';
                explanationEl.style.display = 'block';
            } else {
                feedbackEl.textContent = `回答错误。正确答案是 ${q.correctAnswer}。`;
                feedbackEl.className = 'mc-feedback incorrect';
                allCorrect = false;
                explanationEl.style.display = 'block';
            }
        });

        if (currentMCQuestions.length > 0 && allCorrect) {
            alert("恭喜！所有题目都答对了！");
        }
    }

    async function convertCurrency() {
        const amount = parseFloat(exchangeInputAmountEl.value);
        if (isNaN(amount) || amount <= 0) {
            exchangeRateOutputEl.textContent = "请输入有效的金额。";
            exchangeRateOutputEl.classList.remove('loading', 'error');
            return;
        }

        const fromCurrency = exchangeFromCurrencyEl.value;
        const toCurrency = exchangeToCurrencyEl.value;

        if (fromCurrency === toCurrency) {
            exchangeRateOutputEl.textContent = `无需换算，${amount} ${fromCurrency} 就是 ${amount} ${toCurrency}。`;
            exchangeRateOutputEl.classList.remove('loading', 'error');
            return;
        }

        exchangeRateOutputEl.textContent = "AI 正在获取汇率并换算...";
        exchangeRateOutputEl.classList.add('loading');
        exchangeRateOutputEl.classList.remove('error');

        const prompt = `请将 ${amount} ${fromCurrency} 换算成 ${toCurrency}。
        假设当前汇率：
        1 人民币 (CNY) ≈ 185 韩币 (KRW)
        1 韩币 (KRW) ≈ 0.0054 人民币 (CNY)

        请直接给出换算结果，格式为 "XX [目标货币单位]"。不要包含任何额外文字或解释。`;

        const result = await callGeminiAPI([{text: prompt}], "currency_conversion", exchangeRateOutputEl);

        if (result && !exchangeRateOutputEl.classList.contains('error')) {
            exchangeRateOutputEl.textContent = `换算结果：${result}`;
        } else if (!result && !exchangeRateOutputEl.classList.contains('error')) {
            exchangeRateOutputEl.textContent = "汇率换算失败，请稍后再试。";
        }
    }

    async function fetchKoreanStory() {
        koreanStoryOutputEl.textContent = "AI 正在为您生成韩国小故事...";
        koreanStoryOutputEl.classList.add('loading');
        koreanStoryOutputEl.classList.remove('error');

        const prompt = `请生成一个关于韩国文化或韩国历史的简短双语小故事。
        故事应包含：
        1. 故事标题（韩语）
        2. 故事标题（中文翻译）
        3. 故事内容（韩语，约3-5句话）
        4. 故事内容（中文翻译，约3-5句话）

        请确保故事内容有趣、有教育意义，且语言简单易懂，适合韩语学习者。
        格式如下：
        제목 (韩): [韩语标题]
        标题 (中): [中文标题]
        내용 (韩): [韩语内容]
        内容 (中): [中文内容]
        `;

        const storyText = await callGeminiAPI([{text: prompt}], "korean_story", koreanStoryOutputEl);

        if (storyText && !koreanStoryOutputEl.classList.contains('error')) {
            const lines = storyText.split('\n').filter(line => line.trim() !== '');
            let htmlContent = '';
            let currentCategory = '';
            lines.forEach(line => {
                if (line.startsWith('제목 (韩):')) {
                    htmlContent += `<h4>${line.replace('제목 (韩):', '').trim()}</h4>`;
                    currentCategory = 'korean_title';
                } else if (line.startsWith('标题 (中):')) {
                    htmlContent += `<p class="chinese-news">${line.replace('标题 (中):', '').trim()}</p>`;
                    currentCategory = 'chinese_title';
                } else if (line.startsWith('내용 (韩):')) {
                    htmlContent += `<p class="korean-news">${line.replace('내용 (韩):', '').trim()}</p>`;
                    currentCategory = 'korean_content';
                } else if (line.startsWith('内容 (中):')) {
                    htmlContent += `<p class="chinese-news">${line.replace('内容 (中):', '').trim()}</p>`;
                    currentCategory = 'chinese_content';
                } else if (currentCategory) {
                    if (currentCategory === 'korean_content') {
                        htmlContent += `<p class="korean-news">${line.trim()}</p>`;
                    } else if (currentCategory === 'chinese_content') {
                        htmlContent += `<p class="chinese-news">${line.trim()}</p>`;
                    }
                }
            });
            koreanStoryOutputEl.innerHTML = htmlContent;
        } else if (!storyText && !koreanStoryOutputEl.classList.contains('error')) {
             koreanStoryOutputEl.textContent = "未能获取小故事，请稍后再试。";
        }
    }

    async function recognizeTrashImage() {
        if (!uploadedTrashImageBase64 || !uploadedTrashImageMimeType) {
            alert("请先选择一张图片。");
            return;
        }

        trashImageRecognitionOutputEl.textContent = "AI 正在识别图片中的垃圾...";
        trashImageRecognitionOutputEl.classList.add('loading');
        trashImageRecognitionOutputEl.classList.remove('error');
        trashImageRecognitionOutputEl.style.display = 'block';

        const promptParts = [
            { inline_data: { mime_type: uploadedTrashImageMimeType, data: uploadedTrashImageBase64 } },
            { text: "请识别图片中的物品，并根据韩国的垃圾分类标准，告诉我它属于哪一类垃圾（例如：一般垃圾、可回收垃圾、食物垃圾、大型废弃物等），并简要说明原因。请用韩语和中文双语输出。韩语在前，中文在后。格式：\n分类 (한글):\n原因 (한글):\n\n分类 (中文):\n原因 (中文):" }
        ];

        const result = await callGeminiAPI([{role: "user", parts: promptParts}], "trash_image_recognition", trashImageRecognitionOutputEl);

        if (result && !trashImageRecognitionOutputEl.classList.contains('error')) {
            trashImageRecognitionOutputEl.innerHTML = result.replace(/\n/g, '<br>');
        } else if (!result && !trashImageRecognitionOutputEl.classList.contains('error')) {
            trashImageRecognitionOutputEl.textContent = "图片垃圾分类识别失败。";
        }
    }

    async function classifyTrashText() {
        const trashName = trashTextInputEl.value.trim();
        if (!trashName) {
            trashTextClassificationOutputEl.textContent = "请输入垃圾名称。";
            trashTextClassificationOutputEl.classList.remove('loading', 'error');
            return;
        }

        trashTextClassificationOutputEl.textContent = "AI 正在分类垃圾...";
        trashTextClassificationOutputEl.classList.add('loading');
        trashTextClassificationOutputEl.classList.remove('error');
        trashTextClassificationOutputEl.style.display = 'block';

        const prompt = `请根据韩国的垃圾分类标准，将物品 "${trashName}" 进行分类。请用韩语和中文双语输出：
        1. 物品名称（韩语和中文）
        2. 分类类别（韩语和中文，例如：一般垃圾、可回收垃圾、食物垃圾、大型废弃物等）
        3. 简要的分类依据（韩语和中文）
        
        韩语在前，中文在后。格式：
        物品명 (한글):
        분류 (한글):
        근거 (한글):
        
        物品名称 (中文):
        分类 (中文):
        依据 (中文):`;

        const result = await callGeminiAPI([{text: prompt}], "trash_text_classification", trashTextClassificationOutputEl);

        if (result && !trashTextClassificationOutputEl.classList.contains('error')) {
            trashTextClassificationOutputEl.innerHTML = result.replace(/\n/g, '<br>');
        } else if (!result && !trashTextClassificationOutputEl.classList.contains('error')) {
            trashTextClassificationOutputEl.textContent = "文字垃圾分类识别失败。";
        }
    }


    function setActivePage(pageId, title) {
        contentPages.forEach(page => page.classList.toggle('active', page.id === pageId));
        tabItems.forEach(tab => tab.classList.toggle('active', tab.dataset.page === pageId));
        appHeaderTitleEl.textContent = title;
        document.querySelector('.wechat-content').scrollTop = 0;

        if (pageId === 'page-ai-functions') {
            showAIFunctionsMenu();
        } else {
            pageAiFunctionsEl.classList.remove('menu-active', 'sub-feature-active');
            aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        }

        if (pageId === 'page-settings') {
             showSettingsMainMenu();
        } else {
            pageStudyGoalsEl.classList.remove('active');
        }


        if (pageId === 'page-review-plan') {
            renderReviewList('all');
            updateActiveFilterButton('all');
        } else if (pageId === 'page-memorize') {
            loadWordForMemorizePage(true);
        } else if (pageId === 'page-study-goals') {
            renderCalendar();
        }
        if (pageId !== 'page-about') {
            pageAboutEl.classList.remove('active');
        }
        document.getElementById('korean-life-helper-menu').classList.remove('active');
    }

    function showAIFunctionSubFeature(featureId, title) {
        pageAiFunctionsEl.classList.remove('menu-active');
        pageAiFunctionsEl.classList.add('sub-feature-active');

        aiSubFeatureSections.forEach(section => {
            section.classList.toggle('active', section.id === featureId);
        });
        appHeaderTitleEl.textContent = title;

        if (featureId === 'feature-cloze') {
            generateAIClozeTest();
        } else if (featureId === 'feature-scenario') {
            aiScenarioDescriptionEl.textContent = "点击下方按钮生成对话情境。";
            aiScenarioDialogueHistoryEl.innerHTML = "";
            aiScenarioDialogueHistoryEl.style.display = 'none';
            userScenarioResponseEl.value = "";
            aiScenarioFeedbackEl.textContent = "";
            aiScenarioFeedbackEl.style.display = 'none';
            currentAIScenarioContext = [];
        } else if (featureId === 'feature-essay-correction') {
             essayInputEl.value = "";
             essayFeedbackAreaEl.style.display = 'none';
        } else if (featureId === 'feature-mc-questions') {
            mcQuestionsAreaEl.innerHTML = `<p class="no-questions" style="text-align: center; color: var(--wechat-text-secondary);">点击上方按钮生成题目。</p>`;
            submitMcAnswersBtnEl.style.display = 'none';
        } else if (featureId === 'page-image-recognition') {
            imagePreviewRecEl.src = '';
            imagePreviewRecEl.style.display = 'none';
            recognizeImageKoreanBtnEl.disabled = true;
            imageRecognizedKoTextEl.parentElement.style.display = 'none';
            imageRecognizedZhTextEl.parentElement.style.display = 'none';
            imageUploadInputRecEl.value = '';
        }
        else if (featureId === 'page-exchange-rate') {
            exchangeInputAmountEl.value = '100';
            exchangeRateOutputEl.textContent = '换算结果将显示在此。';
            exchangeRateOutputEl.classList.remove('loading', 'error');
        } else if (featureId === 'page-korean-story') {
            koreanStoryOutputEl.textContent = '点击上方按钮生成一个关于韩国文化或历史的双语小故事。';
            koreanStoryOutputEl.classList.remove('loading', 'error');
        } else if (featureId === 'page-trash-classification') {
            trashImagePreviewEl.src = '';
            trashImagePreviewEl.style.display = 'none';
            recognizeTrashImageBtnEl.disabled = true;
            trashImageRecognitionOutputEl.style.display = 'none';
            trashImageRecognitionOutputEl.classList.remove('loading', 'error');
            trashImageUploadEl.value = '';

            trashTextInputEl.value = '';
            trashTextClassificationOutputEl.textContent = '分类结果将显示在此。';
            trashTextClassificationOutputEl.classList.remove('loading', 'error');
            trashTextClassificationOutputEl.style.display = 'block';
        }
        else if (featureId === 'korean-life-helper-menu') {
            document.getElementById('korean-life-helper-menu').classList.add('active');
            pageAiFunctionsEl.classList.remove('sub-feature-active');
            appHeaderTitleEl.textContent = "韩国生活小助手";
        }
    }

    function showAIFunctionsMenu() {
        pageAiFunctionsEl.classList.add('menu-active');
        pageAiFunctionsEl.classList.remove('sub-feature-active');
        aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        document.getElementById('korean-life-helper-menu').classList.remove('active');
        appHeaderTitleEl.textContent = "AI 功能";
    }

    function showKoreanLifeHelperMenu() {
        pageAiFunctionsEl.classList.remove('menu-active');
        pageAiFunctionsEl.classList.add('sub-feature-active');
        aiSubFeatureSections.forEach(section => section.classList.remove('active'));
        document.getElementById('korean-life-helper-menu').classList.add('active');
        appHeaderTitleEl.textContent = "韩国生活小助手";
    }


    function showSettingsMainMenu() {
        document.getElementById('page-settings').classList.add('active');
        document.getElementById('page-settings').classList.remove('sub-page-active');
        pageStudyGoalsEl.classList.remove('active');
        appHeaderTitleEl.textContent = "我";
    }

    function showStudyGoalsPage() {
        document.getElementById('page-settings').classList.remove('active');
        pageStudyGoalsEl.classList.add('active');
        appHeaderTitleEl.textContent = "学习目标";
        renderCalendar();
    }

    function switchWordList(listName) {
        if (currentWordListName === listName) return;

        currentWordListName = listName;
        wordList = allWordLists[currentWordListName];
        localStorage.setItem('hanyangKoreanCurrentWordList_AI_Advanced_v10', currentWordListName);

        loadLearnedWords();

        currentWordIndex = 0;
        loadWordForMemorizePage(true);
        if (isCardFlipped) flipCard(false);

        if (document.getElementById('page-review-plan').classList.contains('active')) {
            renderReviewList(currentReviewFilter);
        }
    }

    function loadWord(indexToLoad = currentWordIndex, shouldSpeak = false) {
        console.log("loadWord called with indexToLoad:", indexToLoad);

        if (!wordList || wordList.length === 0) {
            koreanWordEl.textContent = "暂无单词可学/复习。";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = '0';
            return;
        }

        if (indexToLoad < 0 || indexToLoad >= wordList.length) {
            console.warn("Attempted to load word at invalid index:", indexToLoad);
            indexToLoad = 0;
        }

        const wordToLoad = wordList[indexToLoad];
        if (!wordToLoad) {
            console.error("No word found at index:", indexToLoad);
            koreanWordEl.textContent = "无法载入单词。";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = (indexToLoad + 1).toString();
            totalWordsEl.textContent = wordList.length;
            return;
        }

        currentWordIndex = indexToLoad;
        console.log("Loading word:", wordToLoad.korean, "at index:", currentWordIndex);

        koreanWordEl.textContent = wordToLoad.korean;
        pronunciationEl.textContent = wordToLoad.pronunciation || "";
        chineseTranslationEl.textContent = wordToLoad.chinese;
        if (wordToLoad.korean_example && wordToLoad.chinese_example) {
            koreanExampleEl.innerHTML = `🇰🇷 ${wordToLoad.korean_example.replace(/\n/g, '<br>')}`;
            chineseExampleEl.innerHTML = `🇨🇳 ${wordToLoad.chinese_example.replace(/\n/g, '<br>')}`;
            exampleSentenceEl.style.display = 'block';
        } else {
            exampleSentenceEl.style.display = 'none';
        }

        if (isCardFlipped) {
            flipCard(false);
        }

        aiHelperBoxEl.style.display = 'none'; aiHelperContentEl.textContent = "点击下方 \"AI提示\" 获取。";
        aiSentenceGeneratorBoxEl.style.display = 'none'; aiGeneratedSentencesEl.innerHTML = "";
        aiUsageNotesBoxEl.style.display = 'none'; aiUsageNotesContentEl.textContent = "";

        updateProgress();
        if (shouldSpeak && autoPronounceNextCheckbox && autoPronounceNextCheckbox.checked) {
            setTimeout(() => speakKoreanWord(), 100);
        }
    }

    function flipCard(forceState = null) {
        if (!wordCardEl) return;
        isCardFlipped = (forceState !== null) ? forceState : !isCardFlipped;
        wordCardEl.classList.toggle('is-flipped', isCardFlipped);
    }

    function speakKoreanWord(event) {
        if (event) event.stopPropagation();

        if (!wordList[currentWordIndex]) {
            console.warn("没有当前单词可以播放。");
            return;
        }

        const koreanWord = wordList[currentWordIndex].korean;
        console.log("尝试播放单词:", koreanWord);

        if (synth && synth.speaking) {
            synth.cancel();
            console.log("取消了先前的浏览器 TTS 语音。");
        }

        const googleTtsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(koreanWord)}&tl=ko&client=tw-ob`;

        const audio = new Audio(googleTtsUrl);
        audio.volume = 1.0;

        let playAttempted = false;

        audio.oncanplaythrough = () => {
            if (!playAttempted) {
                audio.play().then(() => {
                    console.log("通过 Google TTS 成功播放:", koreanWord);
                    playAttempted = true;
                }).catch(e => {
                    console.warn("Google TTS 播放失败 (可能被阻止或用户未交互)，尝试回退到浏览器自带 TTS:", e);
                    playWithBrowserTTS(koreanWord);
                    playAttempted = true;
                });
            }
        };

        audio.onerror = (e) => {
            console.error("Google TTS 音频加载错误:", e);
            if (!playAttempted) {
                console.log("Google TTS 加载失败，回退到浏览器自带 TTS。");
                playWithBrowserTTS(koreanWord);
                playAttempted = true;
            }
        };

        setTimeout(() => {
            if (!playAttempted) {
                console.warn("Google TTS 响应超时，回退到浏览器自带 TTS。");
                playWithBrowserTTS(koreanWord);
                playAttempted = true;
            }
        }, 1500);

        audio.load();

        function playWithBrowserTTS(word) {
            if (!synth) {
                console.warn("SpeechSynthesis 在此设备上不可用，无法回退。");
                return;
            }
            if (synth.speaking) {
                synth.cancel();
                console.log("取消了先前的浏览器 TTS 语音。");
            }

            const utterThis = new SpeechSynthesisUtterance(word);
            let koreanVoice = synth.getVoices().find(v => v.lang === 'ko-KR' || v.lang.startsWith('ko'));

            if (koreanVoice) {
                utterThis.voice = koreanVoice;
                console.log("找到韩语语音:", koreanVoice.name);
            } else {
                utterThis.lang = 'ko-KR';
                console.warn("未找到特定韩语语音，回退到 lang='ko-KR'。可用语音:", synth.getVoices().map(v => v.lang + ' (' + v.name + ')').join(', '));
            }

            utterThis.rate = 0.9;
            utterThis.pitch = 1;

            utterThis.onend = () => {
                console.log("浏览器 TTS 播放完成:", word);
            };
            utterThis.onerror = (event) => {
                console.error("浏览器 TTS 错误:", event.error);
            };

            try {
                synth.speak(utterThis);
                console.log("通过浏览器 TTS 启动播放:", word);
            } catch (e) {
                console.error("调用 synth.speak() 错误:", e);
            }
        }
    }

    function nextWord() {
        console.log("Next word clicked. Current index:", currentWordIndex);
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex + 1) % wordList.length;
        loadWord(currentWordIndex, true);
    }

    function prevWord() {
        console.log("Prev word clicked. Current index BEFORE update:", currentWordIndex);
        if (!wordList || wordList.length === 0) return;
        currentWordIndex = (currentWordIndex - 1 + wordList.length) % wordList.length;
        console.log("Prev word clicked. New index:", currentWordIndex);
        loadWord(currentWordIndex, true);
    }

    function calculateNextReviewTimestamp(reviewCount, lastSeenTimestamp) {
        const now = Date.now();
        lastSeenTimestamp = lastSeenTimestamp || now;

        let intervalDays;
        if (reviewCount === 0) {
            intervalDays = 0;
        } else if (reviewCount === 1) {
            intervalDays = srsIntervals[0];
        } else if (reviewCount <= srsIntervals.length) {
            intervalDays = srsIntervals[reviewCount - 1];
        } else {
            intervalDays = srsIntervals[srsIntervals.length - 1] * Math.pow(1.8, (reviewCount - srsIntervals.length));
        }
        return lastSeenTimestamp + (intervalDays * 24 * 60 * 60 * 1000);
    }

    function markAsKnown() {
        if (!wordList[currentWordIndex]) {
            console.warn("No word to mark as known at current index.");
            return;
        }
        const wordKey = wordList[currentWordIndex].korean;
        const currentTimestamp = Date.now();

        let wordEntry = learnedWordsData[wordKey];
        const isNewWord = !wordEntry;

        if (isNewWord) {
            wordEntry = {
                korean: wordList[currentWordIndex].korean,
                chinese: wordList[currentWordIndex].chinese,
                pronunciation: wordList[currentWordIndex].pronunciation,
                firstLearned: currentTimestamp,
                lastSeen: currentTimestamp,
                reviewCount: 1,
            };
        } else {
            wordEntry.reviewCount = (wordEntry.reviewCount || 0) + 1;
            wordEntry.lastSeen = currentTimestamp;
        }
        wordEntry.nextReviewDue = calculateNextReviewTimestamp(wordEntry.reviewCount, wordEntry.lastSeen);
        learnedWordsData[wordKey] = wordEntry;
        saveLearnedWords();

        console.log(`已标记: ${wordKey}, 次数: ${wordEntry.reviewCount}, 下次: ${new Date(wordEntry.nextReviewDue).toLocaleDateString()}, 今日新词: ${dailyNewWordsLearnedToday}/${dailyNewWordsLimit}`);

        checkDailyStudyGoal();
        loadWordForMemorizePage(true);
    }

    function updateProgress() {
        if (!wordList || wordList.length === 0 || !progressBarEl || !currentWordIndexEl || !totalWordsEl) return;
        const percentage = ((currentWordIndex + 1) / wordList.length) * 100;
        progressBarEl.style.width = percentage + '%';
        currentWordIndexEl.textContent = currentWordIndex + 1;
        totalWordsEl.textContent = wordList.length;
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function jumpToWordForReview(wordKey) {
        const wordIndexInList = wordList.findIndex(w => w.korean === wordKey);
        if (wordIndexInList !== -1) {
            setActivePage('page-memorize', '背单词');
            currentWordIndex = wordIndexInList;
            loadWord(currentWordIndex, true);
        } else {
            alert(`单词 "${wordKey}" 在目前字库中未找到。`);
        }
    }

    let currentReviewFilter = 'all';
    function renderReviewList(filter = 'all') {
        currentReviewFilter = filter;
        if (!reviewListContainerEl || !learnedWordsData) return;
        reviewListContainerEl.innerHTML = '';

        const now = Date.now();
        let wordsToReview = Object.values(learnedWordsData);

        let dueCount = 0;
        wordsToReview.forEach(word => {
            if (word.nextReviewDue <= now) dueCount++;
        });
        if (totalLearnedCountEl) totalLearnedCountEl.textContent = Object.keys(learnedWordsData).length;
        if (dueTodayCountEl) dueTodayCountEl.textContent = dueCount;


        if (filter === 'due') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue <= now);
        } else if (filter === 'overdue') {
            wordsToReview = wordsToReview.filter(word => word.nextReviewDue < (now - 24 * 60 * 60 * 1000));
        }

        wordsToReview.sort((a, b) => (a.nextReviewDue || 0) - (b.nextReviewDue || 0));

        if (wordsToReview.length === 0) {
            reviewListContainerEl.innerHTML = `<p class="no-reviews">${filter === 'all' ? '暂无学习记录。' : '目前筛选条件下没有需要复习的单词。'}</p>`;
            return;
        }

        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.paddingLeft = '0';

        wordsToReview.forEach(word => {
            const li = document.createElement('li');
            li.className = 'review-list-item';
            li.dataset.wordKey = word.korean;

            const wordInfoDiv = document.createElement('div');
            wordInfoDiv.className = 'review-word-info';
            wordInfoDiv.innerHTML = `<div class="word">${word.korean}</div><div class="meaning">${word.chinese || 'N/A'}</div>`;

            const reviewStatusDiv = document.createElement('div');
            reviewStatusDiv.className = 'review-status';
            let nextReviewText = formatDate(word.nextReviewDue);
            let statusClass = '';
            if (word.nextReviewDue <= now) {
                statusClass = 'overdue';
                nextReviewText = "立即复习";
            } else if (word.nextReviewDue <= now + 2 * 24 * 60 * 60 * 1000) {
                statusClass = 'due-soon';
            }

            reviewStatusDiv.innerHTML = `<div class="next-review">下次复习: <span class="date ${statusClass}">${nextReviewText}</span></div><div style="font-size:0.75em; color: #aaa;">上次: ${formatDate(word.lastSeen)} (次数: ${word.reviewCount || 0})</div>`;

            li.appendChild(wordInfoDiv);
            li.appendChild(reviewStatusDiv);
            ul.appendChild(li);
        });
        reviewListContainerEl.appendChild(ul);
    }

    function updateActiveFilterButton(activeFilter) { filterButtonsReview.forEach(button => button.classList.toggle('active', button.id === `filter-${activeFilter}`)); }

    function showAboutPage() {
        setActivePage('page-about', '关于本应用');
    }

    function initializeApp() {
        currentUsernameDisplayEl.textContent = localStorage.getItem('lastLoggedInUser') || "汉阳大计算机学部某学生";

        loadLearnedWords();
        applySavedSettings();

        if (dailyStudyAmountInput) {
            dailyStudyAmountInput.addEventListener('change', (e) => {
                let value = parseInt(e.target.value, 10);
                if (isNaN(value) || value < 1) value = 1;
                if (value > 50) value = 50;
                dailyNewWordsLimit = value;
                localStorage.setItem('dailyNewWordsLimit', dailyNewWordsLimit);
                e.target.value = dailyNewWordsLimit;
                checkDailyStudyGoal();
            });
        }

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || GEMINI_API_KEY.trim() === "" || GEMINI_API_KEY.length < 30) {
            console.warn("警告: Gemini API 密钥无效或未在 JavaScript 中正确设置。AI 功能将受限。");
            const aiButtons = document.querySelectorAll('.ai-btn, .generic-button, .ai-action-btn');
            aiButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = 0.5; btn.title = "API Key 未设置或无效"; btn.style.cursor = "not-allowed"; });

            const aiSections = [
                document.getElementById('page-translate'),
                document.getElementById('page-ai-dictionary'),
                document.getElementById('page-image-recognition'),
                document.getElementById('feature-cloze'),
                document.getElementById('feature-scenario'),
                document.getElementById('feature-essay-correction'),
                document.getElementById('feature-mc-questions'),
                document.getElementById('page-exchange-rate'),
                document.getElementById('page-korean-story'),
                document.getElementById('page-trash-classification')
            ];

            aiSections.forEach(section => {
                if (section && !section.querySelector('.api-error-message')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'var(--danger-color)';
                    errorDiv.style.fontWeight = 'bold';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.marginBottom = '10px';
                    errorDiv.className = 'api-error-message';
                    errorDiv.textContent = '🚫 AI 功能受限：Gemini API 密钥无效或未设置。';
                    section.querySelector('.section-container')?.prepend(errorDiv) || section.prepend(errorDiv);
                }
            });
        }

        loadWordForMemorizePage(true);

        if(wordCardEl) {
            wordCardEl.addEventListener('click', (event) => {
                if (event.target.closest('.pronounce-btn') || event.target.closest('.ai-btn') || event.target.tagName === 'A') return;
                flipCard();
            });
        }

        if(pronounceBtnEl) {
            pronounceBtnEl.addEventListener('click', speakKoreanWord);
        }

        document.getElementById('prev-word-btn').addEventListener('click', prevWord);
        document.getElementById('next-word-btn').addEventListener('click', nextWord);
        document.getElementById('mark-known-btn').addEventListener('click', markAsKnown);

        document.getElementById('ai-tip-btn').addEventListener('click', getAITipForWord);
        document.getElementById('ai-sentence-btn').addEventListener('click', getAISentencesForWord);
        document.getElementById('ai-usage-btn').addEventListener('click', getAIUsageNotesForWord);

        if(reviewListContainerEl) {
            reviewListContainerEl.addEventListener('click', (event) => {
                const listItem = event.target.closest('.review-list-item');
                if (listItem && listItem.dataset.wordKey) {
                    jumpToWordForReview(listItem.dataset.wordKey);
                }
            });
        }

        if(doTranslateAutoBtnEl){ doTranslateAutoBtnEl.addEventListener('click', translateAutoDetect); }
        if(searchDictionaryBtnEl){
            searchDictionaryBtnEl.addEventListener('click', searchAIDictionary);
            koreanWordInputEl.addEventListener('keypress', (e) => { if(e.key === 'Enter') searchAIDictionary(); });
        }
        if(imageUploadInputRecEl){
            imageUploadInputRecEl.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 4 * 1024 * 1024) { alert("图片文件过大，请选择小于 4MB 的图片。"); imageUploadInputRecEl.value = ""; return; }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreviewRecEl.src = e.target.result; imagePreviewRecEl.style.display = 'block';
                        uploadedImageBase64Rec = e.target.result.split(',')[1]; uploadedImageMimeTypeRec = file.type;
                        recognizeImageKoreanBtnEl.disabled = false;
                        imageRecognizedKoTextEl.parentElement.style.display = 'none';
                        imageRecognizedZhTextEl.parentElement.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        if(recognizeImageKoreanBtnEl) { recognizeImageKoreanBtnEl.addEventListener('click', generateImageRecognition); }

        if(generateClozeBtnEl){ generateClozeBtnEl.addEventListener('click', generateAIClozeTest); }
        if(submitClozeBtnEl){ submitClozeBtnEl.addEventListener('click', submitClozeAnswer); }

        if(generateScenarioBtnEl){ generateScenarioBtnEl.addEventListener('click', generateAIScenario); }
        if(submitScenarioResponseBtnEl){ submitScenarioResponseBtnEl.addEventListener('click', submitScenarioResponse); }
        if(correctEssayBtnEl) { correctEssayBtnEl.addEventListener('click', correctEssay); }
        if(generateMcBtnEl) { generateMcBtnEl.addEventListener('click', generateMultipleChoiceQuestions); }
        if(submitMcAnswersBtnEl) { submitMcAnswersBtnEl.addEventListener('click', submitMultipleChoiceAnswers); }

        if(doExchangeRateBtnEl) { doExchangeRateBtnEl.addEventListener('click', convertCurrency); }
        if(fetchKoreanStoryBtnEl) { fetchKoreanStoryBtnEl.addEventListener('click', fetchKoreanStory); }
        if(trashImageUploadEl) {
            trashImageUploadEl.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 4 * 1024 * 1024) { alert("图片文件过大，请选择小于 4MB 的图片。"); trashImageUploadEl.value = ""; return; }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        trashImagePreviewEl.src = e.target.result; trashImagePreviewEl.style.display = 'block';
                        uploadedTrashImageBase64 = e.target.result.split(',')[1]; uploadedTrashImageMimeType = file.type;
                        recognizeTrashImageBtnEl.disabled = false;
                        trashImageRecognitionOutputEl.style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                } else {
                    trashImagePreviewEl.src = '#';
                    trashImagePreviewEl.style.display = 'none';
                    recognizeTrashImageBtnEl.disabled = true;
                }
            });
        }
        if(recognizeTrashImageBtnEl) { recognizeTrashImageBtnEl.addEventListener('click', recognizeTrashImage); }
        if(classifyTrashTextBtnEl) {
            classifyTrashTextBtnEl.addEventListener('click', classifyTrashText);
            trashTextInputEl.addEventListener('keypress', (e) => { if(e.key === 'Enter') classifyTrashText(); });
        }


        filterButtonsReview.forEach(button => {
            button.addEventListener('click', () => { const filterType = button.id.replace('filter-', ''); renderReviewList(filterType); updateActiveFilterButton(filterType); });
        });
        tabItems.forEach(tab => {
            tab.addEventListener('click', () => {
                setActivePage(tab.dataset.page, tab.dataset.title);
            });
        });
        aiFunctionMenuBtns.forEach(button => {
            button.addEventListener('click', () => {
                if (button.dataset.subFeatureId === "korean-life-helper-menu") {
                    showKoreanLifeHelperMenu();
                } else {
                    showAIFunctionSubFeature(button.dataset.subFeatureId, button.dataset.title);
                }
            });
        });


        if(darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleDarkMode);
        }
        colorOptions.forEach(option => {
            option.addEventListener('click', () => selectThemeColor(option.dataset.color));
        });

        const aboutButton = document.querySelector('#page-settings .about-section .about-button');
        if (aboutButton) {
            aboutButton.addEventListener('click', showAboutPage);
        }

        if(learningGoalsMenuItem) {
            learningGoalsMenuItem.addEventListener('click', showStudyGoalsPage);
        }

        if (wordListSelectEl) {
            wordListSelectEl.addEventListener('change', (event) => {
                switchWordList(event.target.value);
            });
        }

        setActivePage('page-memorize', '背单词');
        console.log("韩语学习助手 (AI高级定制版) 已初始化。");

        setTimeout(() => {
            splashScreen.classList.add('hidden');
        }, 2000);

        closeCongratsModalButton.addEventListener('click', hideCongratulationsModal);
    }

    function loadWordForMemorizePage(initialLoadOrMarkKnown = false) {
        console.log("loadWordForMemorizePage called. Initial/MarkKnown:", initialLoadOrMarkKnown);
        const now = Date.now();
        const dueWords = Object.values(learnedWordsData).filter(word => word.nextReviewDue <= now);
        const newWordsNotLearned = wordList.filter(word => !learnedWordsData[word.korean]);

        let wordToLoad = null;
        let targetIndex = currentWordIndex;

        if (dueWords.length > 0) {
            dueWords.sort((a, b) => a.nextReviewDue - b.nextReviewDue);
            wordToLoad = wordList.find(w => w.korean === dueWords[0].korean);
            targetIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            console.log("Found due word:", wordToLoad.korean);
        } else if (dailyNewWordsLearnedToday < dailyNewWordsLimit && newWordsNotLearned.length > 0) {
            wordToLoad = newWordsNotLearned[0];
            targetIndex = wordList.findIndex(w => w.korean === wordToLoad.korean);
            console.log("Found new word:", wordToLoad.korean);
        } else {
            console.log("No due words or new words. Cycling through all words.");
            if (wordList.length > 0) {
                 if (initialLoadOrMarkKnown) {
                     targetIndex = (currentWordIndex + 1) % wordList.length;
                     if (targetIndex === currentWordIndex && wordList.length > 1) {
                         wordToLoad = wordList[currentWordIndex];
                     } else {
                        wordToLoad = wordList[targetIndex];
                     }
                 } else {
                    wordToLoad = wordList[currentWordIndex];
                 }
            }
        }

        if (wordToLoad) {
            loadWord(targetIndex, true);
        } else {
            koreanWordEl.textContent = "暂无单词可学/复习。";
            pronunciationEl.textContent = "";
            chineseTranslationEl.textContent = "";
            exampleSentenceEl.style.display = 'none';
            progressBarEl.style.width = '0%';
            currentWordIndexEl.textContent = '0';
            totalWordsEl.textContent = wordList.length;
            console.log("No word to load based on learning logic. Displaying placeholder.");
        }
    }

    if (synth && synth.getVoices().length === 0) {
        synth.onvoiceschanged = () => { console.log("语音合成声音已载入。"); };
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>